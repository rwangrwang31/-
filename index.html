<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NO GAME NO LIFE - SYSTEM</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Noto+Sans+SC:wght@300;400;500;700&family=ZCOOL+XiaoWei&display=swap" rel="stylesheet">
    <style>
        :root {
            --pink: #ff2a6d; --cyan: #05d9e8; --purple: #d905e8; --gold: #ffd700;
            --dark: #09000f; --glass: rgba(20, 20, 35, 0.95);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; }
        body { background: var(--dark); color: white; font-family: 'Noto Sans SC'; height: 100vh; overflow: hidden; }
        body.unlocked { overflow-y: auto; }

        /* Login Overlay */
        #auth-layer {
            position: fixed; inset: 0; z-index: 20000; background: rgba(5, 2, 10, 0.98);
            display: flex; justify-content: center; align-items: center;
        }
        .auth-box {
            width: 400px; padding: 40px; background: rgba(0,0,0,0.9); 
            border: 2px solid var(--pink); box-shadow: 0 0 50px rgba(255,42,109,0.3); text-align: center;
        }
        .auth-inp { width: 100%; padding: 12px; margin-bottom: 15px; background: #111; border: 1px solid #555; color: white; text-align: center; }
        .auth-btn { width: 100%; padding: 12px; background: var(--pink); color: white; font-weight: bold; cursor: pointer; border: none; }
        .auth-btn:disabled { background: #555; }
        .hidden { display: none !important; }
        .link { margin-top: 10px; font-size: 0.8rem; color: #aaa; text-decoration: underline; cursor: pointer; }
        .err { color: red; margin-top: 10px; height: 20px; font-size: 0.9rem; }

        /* Main UI */
        #app { filter: blur(10px); opacity: 0.5; pointer-events: none; transition: 1s; width: 100%; }
        body.unlocked #app { filter: blur(0); opacity: 1; pointer-events: all; }
        
        nav { position: fixed; top: 0; width: 100%; height: 60px; padding: 0 40px; display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.9); z-index: 100; border-bottom: 1px solid #333; }
        .hero { height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; }
        h1 { font-family: 'Orbitron'; font-size: 4rem; text-shadow: 0 0 20px var(--pink); margin-bottom: 20px; }
        
        section { padding: 80px 20px; max-width: 1200px; margin: 0 auto; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        .card { background: var(--glass); border: 1px solid rgba(255,255,255,0.1); padding: 20px; border-radius: 8px; transition: 0.3s; }
        .card:hover { transform: translateY(-5px); border-color: var(--cyan); }

        /* Reader Overlay (Fixed Z-Index & Background) */
        #reader {
            position: fixed; inset: 0; background: #050505; z-index: 30000;
            display: flex; flex-direction: column; opacity: 0; pointer-events: none; transition: 0.3s;
        }
        #reader.active { opacity: 1; pointer-events: all; }
        
        .reader-head { height: 50px; background: #111; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; padding: 0 20px; }
        .reader-body { flex: 1; display: flex; overflow: hidden; position: relative; }
        
        /* Left Sidebar */
        .side-l { width: 250px; background: #0a0a0a; border-right: 1px solid #333; display: flex; flex-direction: column; }
        .toc-list { flex: 1; overflow-y: auto; }
        .toc-item { padding: 10px 15px; color: #888; border-bottom: 1px solid #222; cursor: pointer; font-size: 0.85rem; }
        .toc-item:hover { color: white; background: #222; }

        /* Center Text */
        .text-area { flex: 1; overflow-y: auto; padding: 50px 100px; font-family: 'ZCOOL XiaoWei'; font-size: 1.3rem; line-height: 2; color: #ddd; background: #000; }
        .line { position: relative; padding: 2px 0; }
        .line:hover { background: #111; }
        .bubble { position: absolute; right: -30px; top: 0; color: var(--purple); cursor: pointer; opacity: 0; }
        .line:hover .bubble { opacity: 1; right: 10px; }

        /* Right Sidebar */
        .side-r { width: 0; background: #0a0a0a; border-left: 1px solid #333; transition: 0.3s; display: flex; flex-direction: column; }
        .side-r.open { width: 320px; }
        .cmt-list { flex: 1; overflow-y: auto; padding: 15px; }
        .cmt-box { background: #222; padding: 10px; margin-bottom: 10px; border-radius: 4px; font-size: 0.9rem; }
        
        /* Mobile */
        @media(max-width:768px) { 
            .side-l { display:none; } 
            .text-area { padding: 20px; }
            .side-r.open { position: absolute; right: 0; width: 90%; height: 100%; z-index: 40000; }
            .auth-box { width: 90%; padding: 20px; }
        }
    </style>
</head>
<body>

    <!-- AUTH LAYER -->
    <div id="auth-layer">
        <div class="auth-box">
            <h2 id="auth-title" style="font-family:'Orbitron'; color:white; margin-bottom:20px;">SYSTEM LOGIN</h2>
            
            <!-- Login -->
            <div id="view-login">
                <input id="l-email" class="auth-inp" placeholder="EMAIL">
                <input id="l-pass" type="password" class="auth-inp" placeholder="PASSWORD">
                <button class="auth-btn" onclick="doLogin(this)">CONNECT</button>
                <div class="link" onclick="switchView('reg1')">New Player? Register</div>
            </div>

            <!-- Reg 1 -->
            <div id="view-reg1" class="hidden">
                <input id="r-user" class="auth-inp" placeholder="USERNAME">
                <input id="r-email" class="auth-inp" placeholder="EMAIL">
                <input id="r-pass" type="password" class="auth-inp" placeholder="PASSWORD">
                <button class="auth-btn" onclick="getCode(this)">GET CODE</button>
                <div class="link" onclick="switchView('login')">Back</div>
            </div>

            <!-- Reg 2 -->
            <div id="view-reg2" class="hidden">
                <p style="color:#888; font-size:0.8rem; margin-bottom:10px;">Code sent (Test: 123456)</p>
                <input id="r-code" class="auth-inp" placeholder="CODE">
                <button class="auth-btn" onclick="doReg(this)">CONFIRM</button>
            </div>

            <div id="auth-msg" class="err"></div>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="app">
        <nav>
            <span style="color:var(--cyan); font-weight:900;">NGNL</span>
            <div>
                <span id="u-name" style="color:var(--gold); margin-right:20px;">GUEST</span>
            </div>
        </nav>

        <div class="hero">
            <h1>ASCHENTE</h1>
            <button class="auth-btn" style="width:auto; padding:10px 40px; margin-top:30px;" onclick="openReader()">READ NOVEL</button>
        </div>

        <section>
            <h2 class="title" style="font-family:'Orbitron'; text-align:center; color:var(--pink); margin-bottom:40px;">PLEDGES</h2>
            <div class="grid">
                <div class="card">I. Á¶ÅÊ≠¢ÊùÄ‰º§„ÄÅÊàò‰∫â‰∏éÊé†Â§∫</div>
                <div class="card">II. ÊâÄÊúâÁ∫†Á∫∑ÈÄöËøáÊ∏∏ÊàèËß£ÂÜ≥</div>
                <div class="card">III. ËµåÊ≥®ÂøÖÈ°ªÂØπÁ≠â</div>
                <div class="card">IV. ÂÜÖÂÆπ‰∏çÈôê</div>
                <div class="card">V. ÂèóÊåëÊàòÊñπÂÜ≥ÂÆöÂÜÖÂÆπ</div>
                <div class="card">VI. ÁõüÁ∫¶ÂøÖÈ°ªÈÅµÂÆà</div>
                <div class="card">VII. ÈõÜÂõ¢Á∫†Á∫∑ÂÖ®ÊùÉ‰ª£ÁêÜ</div>
                <div class="card">VIII. ‰ΩúÂºäË¥•Èú≤Âç≥Ë¥•Âåó</div>
                <div class="card">IX. ËßÑÂàôÁªùÂØπ‰∏çÂèò</div>
                <div class="card">X. Â§ßÂÆ∂ÂíåÂπ≥Áé©Âêß</div>
            </div>
        </section>
    </div>

    <!-- READER OVERLAY -->
    <div id="reader">
        <div class="reader-head">
            <span style="color:var(--cyan); font-family:'Orbitron'">DATABASE</span>
            <button onclick="closeReader()" style="background:none; border:1px solid var(--pink); color:var(--pink); padding:5px 15px; font-family:'Orbitron'; cursor:pointer;">EXIT</button>
        </div>
        <div class="reader-body">
            <div class="side-l">
                <div style="padding:15px; border-bottom:1px solid #333; color:#666; text-align:center;">INDEX</div>
                <div id="toc-list" class="toc-list"></div>
            </div>
            
            <div class="text-area">
                <div id="content" style="min-height:500px;">
                    <div style="text-align:center; margin-top:100px;">
                        <p style="color:#666;">NO DATA</p>
                        <button class="auth-btn" style="width:auto; margin-top:20px;" onclick="document.getElementById('file').click()">LOAD FILE</button>
                    </div>
                </div>
                
                <!-- Pagination -->
                <div style="margin-top:50px; display:flex; justify-content:center; gap:20px;">
                    <button class="auth-btn" style="width:auto; background:transparent; border:1px solid #444;" onclick="turnPage(-1)">PREV</button>
                    <button class="auth-btn" style="width:auto; background:transparent; border:1px solid #444;" onclick="turnPage(1)">NEXT</button>
                </div>
                
                <!-- Discussion Area -->
                <div style="margin-top:80px; padding-top:40px; border-top:2px solid var(--cyan);">
                    <h3 style="color:var(--cyan); font-family:'Orbitron'; margin-bottom:20px;">DISCUSSION</h3>
                    <div style="background:#111; padding:15px;">
                        <textarea id="d-inp" style="width:100%; background:#222; border:none; color:white; padding:10px;" rows="2"></textarea>
                        <button class="auth-btn" style="margin-top:10px;" onclick="postDisc()">POST</button>
                    </div>
                    <div id="d-list" style="margin-top:20px;"></div>
                </div>
            </div>

            <div id="side-r" class="side-r">
                <div style="padding:15px; border-bottom:1px solid #333; display:flex; justify-content:space-between;">
                    <span style="color:var(--pink)">COMMENTS</span>
                    <span onclick="toggleR()" style="cursor:pointer;">X</span>
                </div>
                <div id="cmt-list" class="cmt-list"></div>
                <div style="padding:15px; background:#111;">
                    <textarea id="c-inp" style="width:100%; background:#222; border:none; color:white; padding:10px;" rows="2"></textarea>
                    <button class="auth-btn" style="margin-top:5px;" onclick="postCmt()">POST</button>
                </div>
            </div>
        </div>
    </div>

    <input type="file" id="file" accept=".txt" style="display:none" onchange="loadFile(this)">

    <script>
        // ==============================================
        // ‚ö†Ô∏è ÊõøÊç¢‰∏∫‰Ω†ÁöÑÊñ∞ URL
        const API = "https://script.google.com/macros/s/AKfycbxJBrAx1_jzwNCO6kCSVyJsNANGE4ibdXy5SXva_p54B4Zot8OaJeCm3PdQsIVhdU4v/exec"; 
        // ==============================================

        let user = {name:"Guest"}, lines = [], curStart = 0, curCmtLine = -1;
        const PG_SIZE = 150;

        // --- API ---
        async function req(data) {
            console.log("Send:", data);
            try {
                const r = await fetch(API, {
                    method:'POST', redirect:'follow',
                    headers:{'Content-Type':'text/plain;charset=utf-8'},
                    body:JSON.stringify(data)
                });
                return await r.json();
            } catch(e) { console.error(e); return {status:'error', message:'Network Error'}; }
        }

        // --- Auth ---
        function switchView(v) {
            ['view-login','view-reg1','view-reg2'].forEach(id=>document.getElementById(id).classList.add('hidden'));
            document.getElementById('view-'+v).classList.remove('hidden');
            document.getElementById('auth-msg').innerText="";
        }
        async function doLogin(btn) {
            const e=document.getElementById('l-email').value, p=document.getElementById('l-pass').value;
            if(!e||!p) return msg("Empty fields");
            btn.disabled=true; btn.innerText="...";
            const r = await req({action:'login', email:e, password:p});
            if(r.status==='success') {
                user.name = r.username;
                document.getElementById('auth-layer').style.display='none';
                document.body.classList.add('unlocked');
                document.getElementById('u-name').innerText = user.name.toUpperCase();
            } else { msg(r.message); btn.disabled=false; btn.innerText="CONNECT"; }
        }
        let tmp={};
        async function getCode(btn) {
            const u=document.getElementById('r-user').value, e=document.getElementById('r-email').value, p=document.getElementById('r-pass').value;
            if(!u||!e) return msg("Empty fields");
            btn.disabled=true;
            const r = await req({action:'req_code', email:e}); // ‰øÆÊ≠£ Action ‰∏∫ req_code
            if(r.status==='success') { tmp={u,e,p}; switchView('reg2'); }
            else { msg(r.message); btn.disabled=false; }
        }
        async function doReg(btn) {
            const c=document.getElementById('r-code').value;
            const r = await req({action:'register', username:tmp.u, email:tmp.e, password:tmp.p, code:c}); // ‰øÆÊ≠£ Action ‰∏∫ register
            if(r.status==='success') { alert("Success"); switchView('login'); }
            else msg(r.message);
        }
        function msg(t) { document.getElementById('auth-msg').innerText = t; }

        // --- Reader ---
        function openReader() { document.getElementById('reader').classList.add('active'); }
        function closeReader() { document.getElementById('reader').classList.remove('active'); }
        
        function loadFile(inp) {
            const r = new FileReader();
            r.onload = e => {
                lines = e.target.result.split('\n');
                genToc(); renderPage(0);
            };
            r.readAsText(inp.files[0]);
        }

        function genToc() {
            let h = "";
            lines.forEach((l,i) => {
                if(l.match(/(Chapter|Á¨¨.+Á´†|Â∫èÁ´†)/i) && l.length<50) 
                    h += `<div class="toc-item" onclick="renderPage(${i})">${l}</div>`;
            });
            document.getElementById('toc-list').innerHTML = h;
        }

        function renderPage(idx) {
            if(idx<0) idx=0; if(idx>=lines.length) return;
            curStart = idx;
            const chunk = lines.slice(idx, idx+PG_SIZE);
            document.getElementById('content').innerHTML = chunk.map((l,i) => {
                if(!l.trim()) return "<br>";
                return `<div class="line">${l}<div class="bubble" onclick="openCmt(${idx+i})">üí¨</div></div>`;
            }).join('');
            document.querySelector('.text-area').scrollTop = 0;
            loadDisc(); // Âä†ËΩΩËÆ®ËÆ∫Âå∫
        }

        function turnPage(d) { renderPage(curStart + d*PG_SIZE); }

        // --- Social ---
        function toggleR() { document.getElementById('side-r').classList.toggle('open'); }
        
        async function openCmt(idx) {
            curCmtLine = idx;
            document.getElementById('side-r').classList.add('open');
            const div = document.getElementById('cmt-list');
            div.innerHTML = "Loading...";
            const r = await req({action:'get_line_comments', line_index:idx});
            div.innerHTML = r.data.length ? "" : "No comments";
            r.data.forEach(c => div.innerHTML += `<div class="cmt-box"><div style="color:var(--cyan)">${c.user}</div>${c.content}</div>`);
        }

        async function postCmt() {
            const t = document.getElementById('c-inp').value;
            if(!t) return;
            await req({action:'post_line_comment', line_index:curCmtLine, username:user.name, content:t});
            document.getElementById('c-inp').value="";
            openCmt(curCmtLine);
        }

        async function loadDisc() {
            const r = await req({action:'get_discussion'});
            document.getElementById('d-list').innerHTML = r.data.map(d => 
                `<div class="cmt-box"><div style="color:var(--cyan)">${d.user}</div>${d.content}</div>`
            ).join('');
        }

        async function postDisc() {
            const t = document.getElementById('d-inp').value;
            await req({action:'post_discussion', username:user.name, content:t});
            document.getElementById('d-inp').value="";
            loadDisc();
        }
    </script>
</body>
</html>