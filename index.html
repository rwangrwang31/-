<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NO GAME NO LIFE | DISBOARD SYSTEM</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Noto+Sans+SC:wght@300;500;700&family=ZCOOL+XiaoWei&display=swap" rel="stylesheet">
    <style>
        /* ================= 0. æ ¸å¿ƒå˜é‡ä¸å…¨å±€è®¾å®š ================= */
        :root {
            --pink:#ff2a6d; --cyan:#05d9e8; --purple:#d905e8; --gold:#ffd700;
            --dark:#05010d; --glass:rgba(20,20,35,0.9); --border:rgba(255,255,255,0.1);
            --race-olddeus:#ffef5c;
            --race-phantasma:#e65cff;
            --race-elemental:#5ce6ff;
            --race-dragonia:#ff7c5c;
            --race-flugel:#ffb4ff;
            --race-demon:#ff6c9c;
            --race-fairy:#9cffd0;
            --race-dwarf:#ffc46c;
            --race-werabeast:#ff7aa8;
            --race-seiren:#5cd0ff;
            --race-dhampir:#b35cff;
            --race-elf:#7affb7;
            --race-angel:#ffe0ff;
            --race-goblin:#b5ff5c;
            --race-automaton:#9ad0ff;
            --race-imanity:#ffffff;
        }
        *{margin:0;padding:0;box-sizing:border-box;cursor:none;outline:none;user-select:none;}
        html{scroll-behavior:smooth;}
        body{background-color:var(--dark);color:white;font-family:'Noto Sans SC',sans-serif;height:100vh;overflow-x:hidden;}

        /* ================= 1. åŠ¨æ€å…‰æ ‡ ================= */
        #cursor{width:25px;height:25px;border:2px solid var(--cyan);border-radius:50%;position:fixed;pointer-events:none;z-index:999999;transform:translate(-50%,-50%);transition:all .1s ease-out;mix-blend-mode:difference;}
        #cursor.hover{width:60px;height:60px;background:rgba(5,217,232,.2);border-color:var(--pink);}
        #cursor.click{transform:translate(-50%,-50%) scale(.8);border-width:4px;}
        ::-webkit-scrollbar{width:8px;}
        ::-webkit-scrollbar-thumb{background:linear-gradient(180deg,var(--pink),var(--purple),var(--cyan));border-radius:4px;}
        ::-webkit-scrollbar-track{background:transparent;}

        .btn{
            background:transparent;border:2px solid var(--cyan);color:var(--cyan);
            padding:10px 25px;font-family:'Orbitron',sans-serif;font-weight:bold;
            transition:.25s;position:relative;overflow:hidden;text-transform:uppercase;
            text-shadow:0 0 5px var(--cyan);letter-spacing:1px;
        }
        .btn::before{
            content:"";position:absolute;left:-120%;top:0;width:120%;height:100%;
            background:linear-gradient(120deg,transparent,rgba(255,255,255,.4),transparent);
            transform:skewX(-25deg);
        }
        .btn:hover::before{left:120%;}
        .btn:hover{
            background:var(--cyan);color:black;box-shadow:0 0 25px var(--cyan),inset 0 0 10px rgba(255,255,255,.5);
            transform:scale(1.05) translateY(-2px);text-shadow:none;
        }
        .btn:disabled{border-color:#444;color:#444;cursor:not-allowed;box-shadow:none;transform:none;text-shadow:none;}

        .input{
            width:100%;padding:10px 14px;background:rgba(0,0,0,.5);
            border:1px solid #444;color:white;font-family:'Noto Sans SC',sans-serif;
            transition:.3s;margin-bottom:10px;border-radius:4px;
        }
        .input:focus{border-color:var(--cyan);box-shadow:0 0 15px rgba(5,217,232,.3),inset 0 0 10px rgba(5,217,232,.1);}
        .hidden{display:none!important;}
        .section-title{font-family:'Orbitron';font-size:2.5rem;text-align:center;margin:60px 0 30px;color:white;text-shadow:0 0 15px var(--cyan);}

        /* ================= 2. å¸ƒå±€ä¸æ•´ä½“èƒŒæ™¯ ================= */
        #app-container{transition:filter .5s ease-out,transform .5s ease-out;}
        body.auth-active #app-container{filter:blur(10px) brightness(.4);transform:scale(.98);pointer-events:none;}
        .bg-anim{position:fixed;inset:0;z-index:-10;background:radial-gradient(circle at 50% 0,rgba(189,0,255,.18),transparent 60%),url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%2305d9e8' fill-opacity='0.04'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");}
        #canvas-bg{position:fixed;inset:0;z-index:-5;opacity:.7;}

        /* ================= 3. ç™»å½• / æ³¨å†Œ ================= */
        #auth-overlay,#profile-viewer-overlay{
            position:fixed;inset:0;z-index:20000;background:rgba(5,2,10,.82);
            display:flex;justify-content:center;align-items:center;
            backdrop-filter:blur(10px);opacity:0;pointer-events:none;transition:opacity .5s;
        }
        #auth-overlay.active,#profile-viewer-overlay.active{opacity:1;pointer-events:all;}
        .auth-box,.profile-viewer-box{
            width:420px;padding:40px;background:rgba(0,0,0,.8);
            border:2px solid var(--pink);box-shadow:0 0 60px rgba(255,42,109,.5),inset 0 0 30px rgba(255,42,109,.3);
            text-align:center;position:relative;animation:fadeIn .5s ease-out;border-radius:10px;
        }
        @keyframes fadeIn{from{opacity:0;transform:scale(.9);}to{opacity:1;transform:scale(1);}}
        .auth-title{font-family:'Orbitron',sans-serif;font-size:2rem;margin-bottom:30px;color:white;text-shadow:0 0 10px var(--cyan);}
        .auth-link{font-size:.8rem;color:#888;text-decoration:underline;margin-top:10px;display:inline-block;transition:.2s;}
        .auth-link:hover{color:var(--cyan);}
        .err-msg{color:var(--pink);margin-top:15px;font-family:'Orbitron';font-size:.8rem;min-height:20px;text-shadow:0 0 5px var(--pink);}

        /* ================= 4. é¡¶éƒ¨å¯¼èˆª + è‹±é›„åŒº ================= */
        nav{
            position:fixed;top:0;width:100%;height:70px;padding:0 40px;
            display:flex;justify-content:space-between;align-items:center;z-index:1000;
            background:rgba(5,1,10,.9);border-bottom:1px solid rgba(255,255,255,.1);backdrop-filter:blur(10px);
        }
        .brand{font-family:'Orbitron',sans-serif;font-weight:900;font-size:1.6rem;color:white;text-shadow:0 0 10px var(--cyan),0 0 20px var(--purple);}
        .nav-links{display:flex;align-items:center;gap:20px;}
        .nav-item{
            margin-left:10px;color:#aaa;text-decoration:none;font-family:'Orbitron';font-size:.9rem;
            transition:.3s;position:relative;padding:5px 0;letter-spacing:1px;
        }
        .nav-item:after{
            content:'';position:absolute;bottom:0;left:0;width:0;height:2px;background:var(--cyan);transition:width .3s;
        }
        .nav-item:hover{color:var(--cyan);text-shadow:0 0 8px var(--cyan);}
        .nav-item:hover:after{width:100%;}
        .user-badge{
            border:2px solid var(--gold);padding:6px 15px;color:var(--gold);
            border-radius:999px;font-family:'Orbitron';display:flex;gap:8px;align-items:center;
            transition:.3s;text-shadow:0 0 8px var(--gold);background:rgba(0,0,0,.5);
        }
        .user-badge:hover{background:rgba(255,215,0,.12);box-shadow:0 0 18px rgba(255,215,0,.4);transform:scale(1.05);}
        section{padding:120px 40px 80px;max-width:1400px;margin:0 auto;}
        .hero{min-height:100vh;display:flex;flex-direction:column;justify-content:center;align-items:center;text-align:center;}
        h1{
            font-family:'Orbitron',sans-serif;font-size:5.2rem;margin-bottom:20px;
            text-shadow:0 0 25px var(--pink),0 0 40px var(--purple);animation:glitch 3s infinite alternate;
        }
        @keyframes glitch{
            0%,100%{text-shadow:0 0 25px var(--pink),0 0 40px var(--purple);}
            50%{transform:skew(-.5deg);text-shadow:2px 2px 0 var(--cyan),-2px -2px 0 var(--pink);}
            51%{transform:skew(.5deg);text-shadow:-2px 2px 0 var(--cyan),2px -2px 0 var(--pink);}
        }

        /* ================= 5. è§’è‰²å¡ç‰‡ï¼ˆæ‰‘å…‹ç‰Œç¿»è½¬ï¼‰ ================= */
        .char-gallery{display:flex;justify-content:center;gap:30px;flex-wrap:wrap;}
        .char-card{
    width:240px;
    height:360px;
    perspective:1400px;
    position:relative;
}

/* å†…å±‚çœŸæ­£ç¿»è½¬çš„å®¹å™¨ */
.char-inner{
    width:100%;
    height:100%;
    position:relative;
    transform-style:preserve-3d;
    transition:transform .6s;
}

/* æ‚¬åœæ—¶ç¿»è½¬æ•´å¼ å¡ */
.char-card:hover .char-inner{
    transform:rotateY(180deg);
}

/* æ­£åä¸¤é¢å…¬å…±æ ·å¼ï¼šå åœ¨ä¸€èµ· */
.char-face{
    position:absolute;
    inset:0;
    border-radius:16px;
    overflow:hidden;
    backface-visibility:hidden;
}

/* è®©å›¾ç‰‡å’Œä¸‹æ–¹æ–‡å­—åœ¨å¡ç‰‡å†…å‡åŒ€åˆ†å¸ƒï¼ˆæ­£é¢ï¼‰ */
.char-front{
    background:radial-gradient(circle at 20% 0,var(--cyan),transparent 55%),
               radial-gradient(circle at 90% 110%,var(--pink),transparent 55%),
               #05030a;
    display:flex;
    flex-direction:column;
    justify-content:space-between;
    align-items:center;
    padding:10px 10px 0;
}

/* å…³é”®ï¼šä½¿ç”¨ containï¼Œé™åˆ¶æœ€å¤§é«˜åº¦ï¼Œå–æ¶ˆè´Ÿä½ç§» */
.char-front img{
    width:100%;
    height:auto;
    max-height:260px;           /* æ ¹æ®éœ€è¦å¯ä»¥è°ƒï¼Œæ¯”å¦‚ 250~280 */
    object-fit:contain;
    filter:drop-shadow(0 0 26px rgba(0,0,0,.8));
    transition:transform .35s;
}

/* æ‚¬åœåªåšè½»å¾®ç¼©æ”¾ï¼Œä¸å†å‘ä¸Šç§»å‡ºå¡ç‰‡ */
.char-card:hover .char-front img{
    transform:scale(1.03);
}

.char-front-info{
    width:100%;
    padding:10px 15px 14px;
    background:linear-gradient(180deg,rgba(0,0,0,.1),rgba(0,0,0,.9));
    text-align:center;
}
.char-name{
    font-family:'Orbitron';
    font-size:1.4rem;
    letter-spacing:2px;
}
.char-race{
    font-size:.8rem;
    color:var(--cyan);
}

/* èƒŒé¢ */
.char-back{
    background:
        radial-gradient(circle at 50% 0,var(--purple),transparent 55%),
        radial-gradient(circle at 0 100%,var(--cyan),transparent 55%),
        #05010e;
    transform:rotateY(180deg);
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    gap:12px;
}

.card-symbol{
    width:70px;
    height:70px;
    border-radius:14px;
    border:2px solid var(--gold);
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:2.2rem;
    box-shadow:0 0 18px rgba(255,215,0,.6),
               0 0 40px rgba(255,42,109,.5);
}
.char-desc{
    padding:0 18px;
    font-size:.85rem;
    color:#eee;
    text-align:center;
    line-height:1.5;
}
/* ===== Anime Player Layout ===== */
.anime-layout{
    display:flex;
    gap:18px;
    margin-top:10px;
}

/* å·¦ä¾§ï¼šåˆ—è¡¨ */
.anime-list{
    width:260px;
    max-height:520px;
    overflow-y:auto;
    border-radius:16px;
    border:1px solid rgba(255,255,255,.08);
    background:rgba(10,10,25,.9);
    padding:10px;
}
.anime-card{
    padding:8px 10px;
    border-radius:10px;
    margin-bottom:6px;
    cursor:pointer;
    transition:background .2s, transform .15s;
}
.anime-card:hover{
    background:rgba(255,255,255,.06);
    transform:translateY(-1px);
}
.anime-card.active{
    background:linear-gradient(90deg,var(--pink),var(--purple));
}
.anime-card-title{
    font-size:.9rem;
    font-weight:bold;
}
.anime-card-ep{
    font-size:.78rem;
    color:#ccc;
}

/* å³ä¾§ï¼šæ’­æ”¾å™¨ & è¯„è®º */
.anime-main{
    flex:1;
    display:flex;
    flex-direction:column;
    gap:10px;
}
.anime-video-wrap{
    position:relative;
    width:100%;
    background:#000;
    border-radius:16px;
    overflow:hidden;
    border:1px solid rgba(255,255,255,.12);
}
.anime-video{
    width:100%;
    max-height:420px;
    display:block;
}

/* å¼¹å¹•å±‚ï¼ˆè¦†ç›–åœ¨ video ä¸Šï¼‰ */
.anime-danmaku-layer{
    position:absolute;
    inset:0;
    pointer-events:none;
    overflow:hidden;
}
.dm-item{
    position:absolute;
    white-space:nowrap;
    font-size:14px;
    text-shadow:0 0 3px #000;
    animation:dm-move 8s linear forwards;
}
@keyframes dm-move{
    from{ transform:translateX(100%); }
    to{ transform:translateX(-120%); }
}

/* å·¥å…·æ  / å¼¹å¹•è¾“å…¥ */
.anime-toolbar{
    display:flex;
    align-items:center;
    gap:10px;
    margin-top:4px;
    font-size:.85rem;
}
.anime-dm-input{
    display:flex;
    gap:8px;
    margin-top:4px;
}

/* è¯„è®ºåŒº */
.anime-comments{
    margin-top:6px;
    border-radius:16px;
    border:1px solid rgba(255,255,255,.08);
    padding:10px 12px;
    background:rgba(5,5,20,.9);
}
.anime-comment-list{
    max-height:220px;
    overflow-y:auto;
    margin-bottom:8px;
}
.anime-comment-card{
    padding:6px 0;
    border-bottom:1px dashed rgba(255,255,255,.1);
}
.anime-comment-header{
    display:flex;
    align-items:center;
    gap:8px;
    font-size:.8rem;
    color:#aaa;
}
.anime-comment-body{
    font-size:.9rem;
    margin:4px 0;
}
.anime-comment-actions{
    font-size:.75rem;
    color:#888;
    display:flex;
    gap:12px;
}
.anime-comment-actions span{
    cursor:pointer;
}
.anime-comment-input{
    display:flex;
    flex-direction:column;
    gap:6px;
}
#anime-fav-btn.fav-on{
    background:linear-gradient(90deg,var(--gold),var(--pink));
    color:#000;
}


        /* ================= 6. ç”¨æˆ·ç³»ç»Ÿ MODAL + è®¾å®šä¸ºå±…ä¸­ ================= */
        #user-overlay.modal-layer{
            display:flex;align-items:center;justify-content:center;
        }
        .modal-layer{
            position:fixed;inset:0;z-index:9000;background:rgba(5,5,10,.96);
            display:flex;flex-direction:column;opacity:0;pointer-events:none;transition:all .5s;backdrop-filter:blur(6px);
        }
        .modal-layer.active{opacity:1;pointer-events:all;}
        .profile-ui{
            width:1000px;height:640px;margin:auto;background-color:#050713;
            background-image:radial-gradient(circle at 0 0,rgba(5,217,232,.2),transparent 55%),radial-gradient(circle at 100% 100%,rgba(217,5,232,.25),transparent 55%);
            border:1px solid var(--cyan);display:flex;border-radius:16px;overflow:hidden;box-shadow:0 0 50px rgba(5,217,232,.35);transform:scale(.98);transition:transform .5s;
        }
        #user-overlay.active .profile-ui{transform:scale(1);}
        .p-side{width:260px;background:rgba(0,0,0,.75);border-right:1px solid #222;display:flex;flex-direction:column;}
        .p-head{padding:16px 18px;border-bottom:1px solid #333;font-family:'Orbitron';color:var(--pink);display:flex;justify-content:space-between;align-items:center;}
        .f-list{flex:1;overflow-y:auto;}
        .f-item{padding:10px 16px;border-bottom:1px solid #222;display:flex;align-items:center;gap:8px;transition:.2s;position:relative;font-size:.9rem;}
        .f-item:hover,.f-item.active{background:linear-gradient(90deg,rgba(5,217,232,.25),transparent);border-right:3px solid var(--cyan);}
        .f-name{flex:1;cursor:pointer;}
        .f-status{font-size:.7rem;color:#888;}
        .f-actions{display:flex;gap:4px;}
        .f-actions .btn{padding:2px 6px;font-size:.65rem;border-width:1px;}
        .p-content{flex:1;display:flex;flex-direction:column;position:relative;background:radial-gradient(circle at 50% 0,rgba(5,217,232,.2),transparent 60%);}
        .p-tabs{height:46px;border-bottom:1px solid #333;display:flex;}
        .p-tab{flex:1;background:transparent;border:none;color:#777;font-family:'Orbitron';font-size:.75rem;letter-spacing:1px;}
        .p-tab.active{color:#fff;background:rgba(255,255,255,.05);border-bottom:2px solid var(--cyan);}
        .view{position:absolute;inset:46px 0 0;padding:24px 32px;transition:opacity .3s,transform .3s;}
        .view.hidden{opacity:0;pointer-events:none;transform:scale(.98);}
        .stat-grid{margin-top:24px;display:grid;grid-template-columns:1fr 1fr;gap:18px;}
        .stat-box{background:rgba(255,255,255,.04);padding:16px;border-radius:10px;border:1px solid #333;text-align:center;transition:.3s;}
        .stat-box:hover{box-shadow:0 0 18px rgba(5,217,232,.35);transform:translateY(-3px);}
        .exp-bar{width:100%;height:18px;background:#111;border-radius:9px;margin:8px 0;overflow:hidden;border:1px solid #444;padding:2px;}
        .exp-fill{height:100%;border-radius:7px;background:linear-gradient(90deg,var(--cyan),var(--purple));box-shadow:0 0 10px var(--cyan);transition:width .8s ease-out;}
        .exp-text{font-family:'Orbitron';color:#ccc;text-align:right;font-size:.8rem;}
        .rank-badge{
            display:inline-block;
            padding:4px 10px;
            border-radius:999px;
            font-family:'Orbitron';
            font-size:.9rem;
            letter-spacing:1px;
            border:1px solid rgba(255,255,255,.3);
            position:relative;
            overflow:hidden;
        }
        .rank-tier-C{
            box-shadow:0 0 8px rgba(5,217,232,.4);
        }
        .rank-tier-B{
            box-shadow:0 0 12px rgba(217,5,232,.7);
            animation:rankPulseB 2.5s infinite;
        }
        @keyframes rankPulseB{
            0%,100%{transform:scale(1);box-shadow:0 0 10px rgba(217,5,232,.6);}
            50%{transform:scale(1.05);box-shadow:0 0 22px rgba(5,217,232,.9);}
        }
        .rank-tier-A{
            box-shadow:0 0 18px rgba(255,255,255,.9);
        }
        .rank-tier-A::before{
            content:"";
            position:absolute;
            inset:-2px;
            border-radius:inherit;
            background:conic-gradient(from 0deg,var(--pink),var(--cyan),var(--purple),var(--pink));
            animation:rankBorderSpin 3s linear infinite;
            opacity:0.8;
            z-index:-1;
        }
        .rank-tier-A::after{
            content:"";
            position:absolute;
            inset:2px;
            border-radius:inherit;
            background:rgba(5,2,15,0.9);
            z-index:-1;
        }
        @keyframes rankBorderSpin{
            from{transform:rotate(0);}
            to{transform:rotate(360deg);}
        }
        .chat-view{display:flex;flex-direction:column;height:100%;}
        .chat-header{padding:10px 18px;border-bottom:1px solid #333;font-family:'Orbitron';font-size:1rem;color:var(--cyan);}
        .chat-box{flex:1;padding:16px 20px;overflow-y:auto;display:flex;flex-direction:column;gap:10px;}
        .msg{max-width:70%;padding:8px 12px;border-radius:14px;font-size:.85rem;line-height:1.4;position:relative;}
        .msg.me{align-self:flex-end;background:linear-gradient(45deg,var(--cyan),#00b8c5);color:black;border-bottom-right-radius:4px;}
        .msg.them{align-self:flex-start;background:#262626;border:1px solid #444;border-bottom-left-radius:4px;}
        .chat-input{padding:8px 16px;border-top:1px solid #333;display:flex;gap:8px;align-items:center;}
        /* èŠå¤©è¾“å…¥æ¡†ä¸‹æ–¹çš„è¡¨æƒ…æ¡ */
.chat-emoji-bar{
    display:flex;
    flex-wrap:wrap;
    gap:6px;
    font-size:1.1rem;
    margin:4px 0;
}
.chat-emoji-bar span{
    cursor:pointer;
    padding:2px 6px;
}
.chat-emoji-bar span:hover{
    transform:scale(1.1);
}


        /* Settings view */
        .settings-grid{display:grid;grid-template-columns:1.2fr 1fr;gap:18px;margin-top:10px;}
        .settings-card{background:rgba(255,255,255,.04);border-radius:10px;border:1px solid #333;padding:14px 16px;}
        .settings-card h3{font-family:'Orbitron';font-size:.9rem;margin-bottom:8px;color:var(--cyan);}
        .textarea{width:100%;height:90px;background:rgba(0,0,0,.45);border:1px solid #444;color:#fff;border-radius:6px;padding:8px;font-size:.85rem;resize:vertical;}
        .settings-row{display:flex;gap:8px;margin-top:6px;align-items:center;}
        .settings-row label{font-size:.8rem;color:#aaa;min-width:80px;}

        /* Shop modal */
        #shop-layer .m-body{display:flex;flex-direction:column;padding:20px 30px;gap:20px;}
        .shop-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(210px,1fr));gap:18px;}
        .shop-card{
            background:rgba(4,6,20,.9);border-radius:12px;border:1px solid #333;
            padding:14px 16px;position:relative;overflow:hidden;
        }
        .shop-card::before{
            content:"";position:absolute;inset:-40%;background:conic-gradient(from 0deg,var(--cyan),var(--purple),var(--pink),var(--cyan));
            opacity:.15;filter:blur(18px);animation:spinGlow 10s linear infinite;
        }
        @keyframes spinGlow{from{transform:rotate(0);}to{transform:rotate(360deg);}}
        .shop-inner{position:relative;z-index:1;}
        .shop-tag{font-size:.7rem;color:#aaa;margin-bottom:2px;}
        .shop-name{font-family:'Orbitron';font-size:.95rem;margin-bottom:4px;}
        .shop-price{font-size:.8rem;color:var(--gold);margin-bottom:6px;}
        .shop-desc{font-size:.8rem;color:#ccc;margin-bottom:10px;min-height:32px;}
        .shop-owned{font-size:.75rem;color:var(--cyan);margin-bottom:4px;}

        /* ================= 7. NOVEL READER ================= */
        .m-head{
            height:60px;background:rgba(0,0,0,.7);border-bottom:1px solid #333;
            display:flex;justify-content:space-between;align-items:center;padding:0 30px;flex-shrink:0;
        }
        .m-title{font-family:'Orbitron';letter-spacing:2px;}
        .m-body{flex:1;display:flex;overflow:hidden;position:relative;}
        .r-left-panel{width:260px;background:rgba(0,0,0,.7);border-right:1px solid #333;display:flex;flex-direction:column;}
        .r-tabs{display:flex;border-bottom:1px solid #333;}
        .r-tab{flex:1;background:transparent;border:none;color:#888;padding:10px;font-family:'Orbitron';font-size:.8rem;}
        .r-tab.active{color:#fff;background:rgba(255,255,255,.06);border-bottom:2px solid var(--cyan);}
        .r-tab-content{flex:1;overflow-y:auto;}
        .toc-item,.bm-item{
            padding:10px 14px;border-bottom:1px solid #222;transition:.2s;font-size:.9rem;cursor:pointer;
        }
        .toc-item:hover,.bm-item:hover{background:rgba(5,217,232,.18);color:var(--cyan);}
        .toc-item small{display:block;color:#888;font-size:.7rem;margin-top:2px;}

        .r-main-panel{flex:1;display:flex;flex-direction:column;position:relative;overflow:hidden;}
        #reader-bg-canvas{
            position:absolute;inset:0;z-index:0;opacity:.7;
        }
        .r-text-area{
            position:relative;z-index:1;flex:1;overflow-y:auto;
            padding:26px 6%;font-family:'ZCOOL XiaoWei',serif;font-size:1.5rem;line-height:2.2;color:#f1f1f1;
        }
        .line{position:relative;padding-right:40px;transition:background-color .2s;}
        .line:hover{background:rgba(255,255,255,.04);}
        .comment-bubble{
            position:absolute;right:10px;top:50%;transform:translateY(-50%) scale(.8);
            width:30px;height:30px;background:rgba(255,255,255,.12);border-radius:50%;
            display:flex;align-items:center;justify-content:center;opacity:0;transition:all .25s;box-shadow:0 0 0 0 rgba(5,217,232,.4);
        }
        .line:hover .comment-bubble{opacity:1;transform:translateY(-50%) scale(1);box-shadow:0 0 12px 2px rgba(5,217,232,.55);}
        .comment-icon{font-size:1.1rem;}
        .comment-count{
            font-family:'Orbitron';font-size:.7rem;position:absolute;top:-5px;right:-5px;
            background:var(--pink);border-radius:50%;width:16px;height:16px;line-height:16px;text-align:center;box-shadow:0 0 5px var(--pink);
        }
        .r-footer{
            padding:10px 10px;background:rgba(0,0,0,.8);border-top:1px solid #333;
            display:flex;justify-content:center;align-items:center;gap:16px;z-index:2;
        }
        .r-progress{font-family:'Orbitron';color:#aaa;font-size:.85rem;}
        .r-side-r{
            position:absolute;top:0;right:0;width:380px;height:100%;background:#05050a;
            border-left:1px solid #333;transform:translateX(100%);transition:transform .35s ease-out;
            display:flex;flex-direction:column;z-index:5;
        }
        .r-side-r.open{transform:translateX(0);box-shadow:-10px 0 30px rgba(0,0,0,.7);}
        .cmt-header{
            padding:12px 16px;border-bottom:1px solid #333;font-family:'Orbitron';
            color:var(--pink);display:flex;justify-content:space-between;align-items:center;
        }
        .cmt-list{flex:1;overflow-y:auto;padding:10px;}
        .cmt-card{
            background:#151515;padding:10px 12px;margin-bottom:8px;border-radius:6px;
            border-left:2px solid transparent;transition:border-color .25s,transform .25s;
        }
        .cmt-card:hover{border-color:var(--cyan);transform:translateX(-2px);}
        .mention-link{color:var(--cyan);text-decoration:none;font-weight:bold;}
        .mention-link:hover{text-decoration:underline;}
        .cmt-user{display:flex;align-items:center;gap:6px;font-size:.85rem;}
        .mini-avatar{
    width:22px;height:22px;border-radius:50%;background:#333;
    overflow:hidden;border:1px solid rgba(255,255,255,.2);
}
.mini-avatar img{width:100%;height:100%;object-fit:cover;}

/* åŸºç¡€å¤´åƒæ¡†å®¹å™¨ */
.avatar-frame{
    border-radius:50%;
    overflow:hidden;
}

/* Elkia é‡‘è‰²å¤´åƒæ¡† */
.avatar-frame.frame-elkia{
    border:2px solid var(--gold);
    box-shadow:0 0 14px rgba(255,215,0,.9);
}

/* FlÃ¼gel ç´«è‰²å…‰ç¯å¤´åƒæ¡† */
.avatar-frame.frame-flugel{
    border:2px solid #ff7bff;
    box-shadow:0 0 14px rgba(255,123,255,.9);
}

/* Warbeast éœ“è™¹å¤´åƒæ¡† */
.avatar-frame.frame-warbeast{
    border:2px solid var(--cyan);
    box-shadow:0 0 14px rgba(5,217,232,.9);
}

/* åç§° + ç§°å· + ç­¾åçš„ç»Ÿä¸€æ ·å¼ */
.user-name{font-weight:bold;cursor:pointer;}
.user-title{
    margin-left:6px;
    padding:2px 6px;
    border-radius:10px;
    font-size:.7rem;
    background:linear-gradient(90deg,var(--pink),var(--purple));
}
.user-signature{
    font-size:.75rem;
    color:#aaa;
}
/* è®©å¤´åƒå›¾ç‰‡é“ºæ»¡åœ†åœˆï¼ˆä¿é™©èµ·è§ï¼Œè™½ç„¶ä½ åœ¨ HTML å·²ç»å†™äº† inline æ ·å¼ï¼‰ */
#profile-avatar {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
}

/* å¦‚æœæœªæ¥æƒ³åšå ä½å›¾ï¼Œå¯ä»¥ç”¨è¿™ä¸ªï¼Œä½†ç°åœ¨å…ˆéšè—æ–‡å­— */
#profile-avatar-frame.has-avatar img {
    /* æœ‰å¤´åƒçš„æ—¶å€™ï¼Œåªæ˜¾ç¤ºå›¾ç‰‡ */
    opacity: 1;
}

#profile-avatar-frame:not(.has-avatar) img {
    /* æ²¡å¤´åƒçš„æ—¶å€™ï¼Œå¯ä»¥è®©å›¾ç‰‡é€æ˜ï¼Œåªæ˜¾ç¤ºä½ æƒ³åšçš„èƒŒæ™¯ï¼Œå ä½å…ˆä¸åšå°±è¡Œ */
    opacity: 0;
}

        .cmt-content{margin-top:4px;white-space:pre-wrap;font-size:.85rem;}
        .cmt-actions{font-size:.78rem;color:#888;display:flex;gap:10px;margin-top:4px;}
        .cmt-actions span{cursor:pointer;}

        .cmt-input-box{padding:8px 10px;border-top:1px solid #333;z-index:10;}
        .cmt-input-box .input{margin-bottom:6px;}

        /* ================= 8. è®¨è®ºåŒº ================= */
        #discussion-layer .m-body{padding:16px 26px;display:flex;gap:20px;}
        .forum-left{flex:2;display:flex;flex-direction:column;height:100%;}
        .forum-list{flex:1;overflow-y:auto;margin-top:10px;}
        .post-card{
            background:rgba(0,0,0,.7);border-radius:10px;border:1px solid #333;
            padding:10px 14px;margin-bottom:10px;display:flex;gap:10px;align-items:flex-start;
            transition:.25s;
        }
        .post-card:hover{box-shadow:0 0 18px rgba(5,217,232,.35);transform:translateY(-2px);}
        .post-main{flex:1;}
        .post-header{display:flex;align-items:center;gap:6px;font-size:.85rem;}
        .post-content{margin-top:4px;font-size:.9rem;white-space:pre-wrap;}
        .post-meta{margin-top:4px;font-size:.75rem;color:#777;}
        .post-actions{margin-top:4px;font-size:.78rem;color:#888;display:flex;gap:12px;}
        .post-actions span{cursor:pointer;}
        .forum-right{flex:1;background:rgba(0,0,0,.7);border-radius:10px;border:1px solid #333;padding:12px 14px;display:flex;flex-direction:column;}
        .forum-right h3{font-family:'Orbitron';font-size:.9rem;margin-bottom:6px;color:var(--cyan);}
        .forum-right textarea{flex:1;margin:6px 0 10px;}

        /* ================= 9. è®¾å®šåŒºï¼ˆåæ¡ç›Ÿçº¦ + åå…­ç§æ—ï¼‰ ================= */
        #codex{position:relative;}
        .codex-grid{display:grid;grid-template-columns:1.3fr 1fr;gap:26px;}
        .codex-card{
            background:radial-gradient(circle at 0 0,rgba(5,217,232,.25),transparent 55%),radial-gradient(circle at 100% 100%,rgba(217,5,232,.25),transparent 55%),rgba(0,0,0,.8);
            border-radius:16px;border:1px solid rgba(255,255,255,.15);padding:18px 20px;position:relative;overflow:hidden;
        }
        .codex-card::before{
            content:"";position:absolute;inset:-30%;background:conic-gradient(from 140deg,rgba(5,217,232,.6),rgba(217,5,232,.2),rgba(255,42,109,.5),rgba(5,217,232,.6));
            opacity:.15;filter:blur(20px);animation:codexSpin 14s linear infinite;
        }
        @keyframes codexSpin{from{transform:rotate(0);}to{transform:rotate(360deg);}}
        .codex-inner{position:relative;z-index:1;}
        .codex-card h3{font-family:'Orbitron';font-size:1.1rem;margin-bottom:8px;}
        .pledge-list{list-style:none;font-size:.9rem;line-height:1.7;margin-top:6px;}
        .pledge-list li{margin-bottom:4px;position:relative;padding-left:20px;}
        .pledge-list li::before{
            content:"â™œ";position:absolute;left:0;top:0;color:var(--cyan);font-size:.8rem;
        }
        .race-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px;margin-top:10px;font-size:.85rem;}
        .race-chip{
            border-radius:10px;padding:8px 10px;display:flex;align-items:center;justify-content:space-between;
            background:rgba(0,0,0,.7);border:1px solid rgba(255,255,255,.09);position:relative;overflow:hidden;
        }
        .race-chip span{position:relative;z-index:1;}
        .race-piece{font-family:'Orbitron';font-size:.75rem;opacity:.9;}
        .race-bg{
            position:absolute;inset:-40%;opacity:.28;filter:blur(10px);z-index:0;
        }
        .race-chip strong{font-size:.9rem;}
        .codex-meta{margin-top:10px;font-size:.85rem;color:#ccc;line-height:1.7;}

        /* ================= 10. å…¶å®ƒ ================= */
        footer{text-align:center;padding:40px;color:#555;font-family:'Orbitron';font-size:.8rem;}
        @media(max-width:1024px){
            nav{padding:0 18px;}
            section{padding:110px 18px 60px;}
            .profile-ui{width:95%;height:640px;}
            .codex-grid{grid-template-columns:1fr;}
        }
        @media(max-width:768px){
            h1{font-size:3.4rem;}
            .char-gallery{gap:18px;}
            .char-card{width:200px;height:300px;}
            .r-left-panel{display:none;}
        }
    </style>
</head>
<body id="body">
<div id="cursor"></div>

<!-- ============= 1. AUTH OVERLAY ============= -->
<div id="auth-overlay">
    <div class="auth-box">
        <h2 id="auth-head" class="auth-title">SYSTEM LOGIN</h2>
        <div id="form-login">
            <input id="login-email" class="input" type="email" placeholder="EMAIL">
            <input id="login-pass" type="password" class="input" placeholder="PASSWORD">
            <button class="btn" style="width:100%" onclick="auth.login()">CONNECT</button>
            <div class="auth-link" onclick="ui.switchAuth('register')">New Player? Register</div>
        </div>
        <div id="form-register" class="hidden">
            <input id="reg-user" class="input" placeholder="USERNAME">
            <input id="reg-email" class="input" type="email" placeholder="EMAIL">
            <input id="reg-pass" type="password" class="input" placeholder="PASSWORD">
            <button id="reg-code-btn" class="btn" style="width:100%" onclick="auth.requestCode()">GET CODE</button>
            <div class="auth-link" onclick="ui.switchAuth('login')">Already a Player? Login</div>
        </div>
        <div id="form-confirm" class="hidden">
            <p style="color:#888;font-size:.8rem;margin-bottom:10px;">Code sent. (Test code: 123456)</p>
            <input id="reg-code" class="input" placeholder="VERIFICATION CODE">
            <button class="btn" style="width:100%" onclick="auth.register()">CONFIRM</button>
            <div class="auth-link" onclick="ui.switchAuth('register')">Back</div>
        </div>
        <div id="auth-msg" class="err-msg"></div>
    </div>
</div>

<!-- ============= 2. MAIN APP ============= -->
<div id="app-container">
    <div class="bg-anim"></div>
    <canvas id="canvas-bg"></canvas>

    <nav>
        <div class="brand">DISBOARD</div>
        <div class="nav-links">
            <a href="#hero" class="nav-item">HOME</a>
            <a href="#" class="nav-item" onclick="ui.showModal('reader-layer');reader.ensureReady();return false;">ARCHIVE</a>
            <a href="#codex" class="nav-item">CODEX</a>
            <a href="#" class="nav-item" onclick="ui.showModal('discussion-layer');forum.init();return false;">FORUM</a>
            <a href="#" class="nav-item" onclick="ui.showModal('shop-layer');shop.init();return false;">SHOP</a>
        </div>
        <div class="user-badge" onclick="ui.showModal('user-overlay')">
            <span id="hud-username">GUEST</span>
            <span id="hud-coins">ğŸª™ 0</span>
        </div>
    </nav>

    <header id="hero" class="hero">
        <h1>NO GAME NO LIFE</h1>
        <p style="color:#aaa;letter-spacing:2px;margin-bottom:40px;">ã€ã•ã‚ã€ã‚²ãƒ¼ãƒ ã‚’å§‹ã‚ã‚ˆã†ã€</p>
        <button class="btn" onclick="ui.showModal('reader-layer');reader.ensureReady();">READ NOVEL</button>
    </header>

    <section id="players">
        <h2 class="section-title">MAIN PLAYERS</h2>
        <div class="char-gallery" id="char-grid"></div>
    </section>

    <!-- CODEX SECTION -->
    <section id="codex">
        <h2 class="section-title">DISBOARD CODEX</h2>
        <div class="codex-grid">
            <div class="codex-card">
                <div class="codex-inner">
                    <h3>åæ¡ç›Ÿçº¦ Ten Pledges</h3>
                    <ul class="pledge-list">
                        <li>ä¸€ã€æ€æˆ®æˆ˜äº‰ä¸€æ¦‚ç¦æ­¢ã€‚</li>
                        <li>äºŒã€ä»¥æ¸¸æˆæ¥å†³å®šä¸€åˆ‡äº‰ç«¯ã€‚</li>
                        <li>ä¸‰ã€æ¸¸æˆä¸­èµŒä¸Šçš„ç‰©å“é¡»ä¸ºåŒæ–¹åŒæ„ä¹‹ç‰©ã€‚</li>
                        <li>å››ã€åªè¦ä¸è¿åç¬¬ä¸‰æ¡ï¼Œè‹¥å¯¹èµŒå“æœ‰å¼‚è®®å¯è¿½åŠ èµŒæ³¨ä½œä¸ºè°ˆåˆ¤ç­¹ç ã€‚</li>
                        <li>äº”ã€è¢«æŒ‘æˆ˜è€…æœ‰æƒå†³å®šæ¸¸æˆå†…å®¹ã€‚</li>
                        <li>å…­ã€èµŒçº¦è‹¥è¿ååˆ™è§†åŒè´¥åŒ—ï¼Œä¾æ®ç»“æœæœä»å¤„åˆ†ã€‚</li>
                        <li>ä¸ƒã€åœ¨ç¥è§è¯ä¹‹ä¸‹çš„äº‰ç«¯ç»å¯¹æœä»æ¸¸æˆç»“æœã€‚</li>
                        <li>å…«ã€åœ¨æ¸¸æˆä¸­ä½œå¼Šæœªè¢«å‘ç°å³è§†ä¸ºæ­£å½“æ‰‹æ®µã€‚</li>
                        <li>ä¹ã€åœ¨éµå®ˆå‰å…«æ¡çš„å‰æä¸‹ï¼Œä¸ªäººä¹‹é—´ã€å›½ä¸å›½ä¹‹é—´çš†ä¸€è§†åŒä»ã€‚</li>
                        <li>åã€ä»¥ä¸Šå„æ¡ï¼Œçš†ç”±å”¯ä¸€ç¥ç‰¹å›¾æ‰€ä¿éšœã€‚</li>
                    </ul>
                    <div class="codex-meta">
                        <strong>å°è¯´ç®€ä»‹ï¼š</strong>åœ¨è¢«ç§°ä¸ºã€ã€€ã€€ã€çš„æœ€å¼º NEET æ¸¸æˆç©å®¶å…„å¦¹ï¼Œè¢«å¬å”¤åˆ°ç”±æ¸¸æˆæ”¯é…çš„ä¸€åˆ‡â€”â€”å¼‚ä¸–ç•Œã€Œè¿ªæ–¯åšå¾·ã€ï¼Œå‘åå…­ç§æ—ä¸æ¸¸æˆä¹‹ç¥å‘èµ·æŒ‘æˆ˜ã€‚<br>
                        <strong>ä½œè€…ï¼š</strong>æ¦å®«ç¥ï¼ˆæ¦å®® ç¥ï¼‰ï¼Œä»¥é«˜é¥±å’Œåº¦çš„è‰²å½©ä¸è¶…é«˜é€Ÿå¯¹è¯è‘—ç§°ã€‚
                    </div>
                </div>
            </div>
            <div class="codex-card">
                <div class="codex-inner">
                    <h3>æ£‹ç›˜ä¸Šçš„åå…­æ— Exceed x Chess</h3>
                    <div class="race-grid" id="race-grid"></div>
                    <div class="codex-meta">
                        æ¯ä¸ªç§æ—éƒ½è¢«è§†ä½œæ£‹ç›˜ä¸Šçš„ä¸€æšæ£‹å­ï¼š<br>
                        ç‹(â™”)è±¡å¾æ—§ç¥ã€çš‡æ—çš„ç»å¯¹æ”¯é…ï¼›å(â™•)ä»£è¡¨æ”¯é…æˆ˜åœºçš„ç©¶æåŠ›é‡ï¼›è½¦(â™–)æ˜¯è½°ç„¶æ¨è¿›çš„å†›åŠ¿ï¼›è±¡(â™—)æ˜¯è¯¡è°²çš„é­”æ³•ä¸è°‹ç•¥ï¼›é©¬(â™˜)æ˜¯ä¸å¯é¢„çŸ¥çš„è·ƒè¿›ï¼›å…µ(â™™)åˆ™æ˜¯çœ‹ä¼¼æ¸ºå°å´èƒ½ç¿»ç›˜çš„äººç±»ã€‚
                    </div>
                </div>
            </div>
        </div>
    </section>

    <footer><p>DISBOARD SYSTEM v40.0 â€” ã€Itâ€™s checkmate from move zero.ã€</p></footer>
</div>

<!-- ============= 3. USER PROFILE MODAL ============= -->
<div id="user-overlay" class="modal-layer">
    <div class="profile-ui">
        <div class="p-side">
            <div class="p-head"><span>SOCIAL</span><button class="btn" onclick="social.addFriend()">+</button></div>
            <div id="friend-list" class="f-list"></div>
            <div style="padding:10px;border-top:1px solid #333;">
                <button class="btn" style="width:100%;border-color:var(--pink);color:var(--pink)" onclick="auth.logout()">LOGOUT</button>
            </div>
        </div>
        <div class="p-content">
            <div class="p-tabs">
                <button id="tab-stats" class="p-tab active" onclick="ui.switchProfileTab('stats')">PROFILE</button>
                <button id="tab-chat" class="p-tab" onclick="ui.switchProfileTab('chat')">CHAT</button>
                <button id="tab-settings" class="p-tab" onclick="ui.switchProfileTab('settings')">SETTINGS</button>
            </div>
            <div id="view-stats" class="view">
                <div style="display:flex;align-items:center;gap:16px;">
                    <div class="mini-avatar avatar-frame" style="width:56px;height:56px;border-radius:50%;overflow:hidden;border-width:2px;" id="profile-avatar-frame">
                        <img id="profile-avatar" src="" alt="avatar" style="width:100%;height:100%;object-fit:cover;">
                    </div>
                    <div>
                        <h2 id="profile-name" style="font-family:'Orbitron';font-size:1.4rem;"></h2>
                        <div id="profile-title" style="font-size:.75rem;color:var(--gold);margin-top:2px;"></div>
                        <p id="profile-bio" style="color:#aaa;margin-top:6px;min-height:36px;font-size:.85rem;"></p>
                        <div id="profile-signature" style="color:#ccc;font-size:.8rem;margin-top:4px;"></div>
                    </div>
                </div>
                <div class="stat-grid">
                    <div class="stat-box">
                        <div style="font-size:.8rem;color:#aaa;">RACE / TITLE</div>
                        <div id="profile-rank" class="rank-badge">Imanity Â· Novice Player</div>
                    </div>
                    <div class="stat-box">
                        <div style="font-size:.8rem;color:#aaa;">COINS</div>
                        <div id="profile-coins" style="font-size:1.8rem;">ğŸª™ 0</div>
                    </div>
                </div>
                <div style="margin-top:20px;">
                    <div class="exp-text">EXP</div>
                    <div class="exp-bar"><div id="profile-exp-fill" class="exp-fill"></div></div>
                    <div id="profile-exp-text" class="exp-text"></div>
                </div>
                <button class="btn" style="position:absolute;bottom:24px;left:50%;transform:translateX(-50%);" onclick="ui.hideAllModals()">CLOSE</button>
            </div>

            <div id="view-chat" class="view hidden">
                <div id="chat-header" class="chat-header"></div>
                <div id="chat-box" class="chat-box"></div>
                <div class="chat-input">
                    <input id="msg-input" class="input" style="text-align:left;margin:0;" placeholder="Message..." onkeydown="if(event.key==='Enter')social.sendMessage()">
                    <button class="btn" onclick="social.sendMessage()">SEND</button>
                </div>
            </div>

            <div id="view-settings" class="view hidden">
                <div class="settings-grid">
                    <div class="settings-card">
                        <h3>PROFILE TEXT</h3>
                        <label style="font-size:.8rem;color:#aaa;">Bio / è‡ªæˆ‘ä»‹ç»</label>
                        <textarea id="settings-bio" class="textarea" placeholder="å‘Šè¯‰ä¸–ç•Œä½ æ˜¯è°ã€‚"></textarea>
                        <div class="settings-row" style="margin-top:10px;">
                            <label>Signature</label>
                            <input id="settings-signature" class="input" placeholder="ä¸ªæ€§ç­¾åï¼ˆä¹Ÿä¼šåœ¨è®¨è®ºåŒºæ˜¾ç¤ºï¼‰">
                        </div>
                        <button class="btn" style="margin-top:10px;" onclick="settings.saveProfile()">SAVE PROFILE</button>
                    </div>
                    <div class="settings-card">
                        <h3>AVATAR & NAME</h3>
<div class="settings-row">
    <label>Avatar URL</label>
    <input id="settings-avatar" class="input" placeholder="ç²˜è´´ä¸€å¼ å›¾ç‰‡é“¾æ¥" />
</div>
<button class="btn" style="margin-bottom:8px;" onclick="settings.saveAvatar()">SAVE AVATAR</button>

<!-- æ–°å¢ï¼šæœ¬åœ°ä¸Šä¼  -->
<div class="settings-row" style="margin-top:4px;">
    <label>Upload</label>
    <input id="settings-avatar-file" type="file" accept="image/*" class="input" style="padding:6px 8px;">
</div>
<button class="btn" style="margin-bottom:8px;" onclick="settings.uploadAvatarFile()">UPLOAD FROM DEVICE</button>

<div style="border-top:1px dashed #444;margin:6px 0 8px;"></div>

                        <div class="settings-row">
                            <label>New Name</label>
                            <input id="settings-newname" class="input" placeholder="æ”¹åéœ€è¦ 100ğŸª™">
                        </div>
                        <button class="btn" style="border-color:var(--gold);color:var(--gold);" onclick="settings.changeName()">CHANGE NAME (100 COINS)</button>
                        <p style="font-size:.75rem;color:#888;margin-top:4px;">æ”¹åä¼šåŒæ­¥æ›´æ–°è¯„è®ºåŒºã€è®¨è®ºåŒºå’Œå¥½å‹åˆ—è¡¨ä¸­çš„åå­—ã€‚</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- ============= ANIME PLAYER ============= -->
<section id="anime-section" class="panel">
    <h2 class="panel-title">ANIME PLAYER</h2>
    <div class="anime-layout">
        <!-- å·¦è¾¹ï¼šç•ªå‰§ / ç”µå½±åˆ—è¡¨ -->
        <div class="anime-list" id="anime-list"></div>

        <!-- å³è¾¹ï¼šæ’­æ”¾å™¨ + å¼¹å¹• + è¯„è®º -->
        <div class="anime-main">
            <div class="anime-video-wrap">
                <video id="anime-video" class="anime-video" controls></video>
                <div id="anime-danmaku-layer" class="anime-danmaku-layer"></div>
            </div>

            <div class="anime-toolbar">
                <button id="anime-fav-btn" class="btn">â˜† æ”¶è—æœ¬é›†</button>

                <label style="margin-left:10px;">
                    å€é€Ÿ
                    <select id="anime-speed" class="input" style="width:auto;display:inline-block;">
                        <option value="0.5">0.5x</option>
                        <option value="1" selected>1.0x</option>
                        <option value="1.5">1.5x</option>
                        <option value="2">2.0x</option>
                    </select>
                </label>

                <label style="margin-left:12px;">
                    <input type="checkbox" id="anime-dm-toggle" checked>
                    æ˜¾ç¤ºå¼¹å¹•
                </label>
            </div>

            <div class="anime-dm-input">
                <input id="anime-danmaku-input" class="input" placeholder="å‘ä¸€æ¡å¼¹å¹•ï½" />
                <button class="btn" id="anime-danmaku-send">å‘é€å¼¹å¹•</button>
            </div>

            <div class="anime-comments">
                <h3>è¯„è®º</h3>
                <div id="anime-comment-list" class="anime-comment-list"></div>
                <div class="anime-comment-input">
                    <textarea id="anime-comment-input" class="textarea" placeholder="è¯´ç‚¹ä»€ä¹ˆ..."></textarea>
                    <button class="btn" id="anime-comment-send">å‘é€è¯„è®º</button>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- 4. NOVEL READER MODAL -->
<div id="reader-layer" class="modal-layer">
    <div class="m-head">
        <span class="m-title">ARCHIVE</span>
        <button class="btn" style="border-color:var(--pink);color:var(--pink);" onclick="ui.hideAllModals()">EXIT</button>
    </div>
    <div class="m-body">
        <div class="r-left-panel">
            <div class="r-tabs">
                <button id="tab-toc" class="r-tab active" onclick="reader.switchTab('toc')">INDEX</button>
                <button id="tab-bm" class="r-tab" onclick="reader.switchTab('bm')">BOOKMARKS</button>
            </div>
            <div id="content-toc" class="r-tab-content"></div>
            <div id="content-bm" class="r-tab-content hidden"></div>
        </div>
        <div class="r-main-panel">
            <canvas id="reader-bg-canvas"></canvas>
            <div id="reader-text-area" class="r-text-area">
                <p style="text-align:center;color:#888;margin-top:50px;">Loading novel...</p>
            </div>
            <div class="r-footer">
                <button class="btn" onclick="reader.goToPage(state.novel.currentPage - 1)">PREV</button>
                <span id="reader-progress" class="r-progress">0 / 0</span>
                <button class="btn" onclick="reader.goToPage(state.novel.currentPage + 1)">NEXT</button>
                <button class="btn" style="border-color:var(--gold);color:var(--gold);" onclick="reader.addBookmark()">BOOKMARK</button>
            </div>
        </div>
        <div id="reader-comment-sidebar" class="r-side-r">
            <div class="cmt-header">
                <span id="cmt-header-title">COMMENTS</span>
                <button onclick="reader.closeCommentSidebar()" style="background:none;border:none;color:white;font-size:1.2rem;">Ã—</button>
            </div>
            <div id="cmt-list" class="cmt-list"></div>
            <div class="cmt-input-box">
                <textarea id="cmt-input" class="input" rows="3" placeholder="Add a comment..."></textarea>
                <button class="btn" style="width:100%;margin-top:4px;" onclick="reader.postComment()">POST</button>
            </div>
        </div>
    </div>
</div>

<!-- 5. OTHER PROFILE VIEWER -->
<div id="profile-viewer-overlay" class="modal-layer">
    <div class="profile-viewer-box">
        <div id="profile-viewer-content"></div>
        <button class="btn" style="margin-top:20px;" onclick="document.getElementById('profile-viewer-overlay').classList.remove('active')">CLOSE</button>
    </div>
</div>

<!-- 6. DISCUSSION MODAL -->
<div id="discussion-layer" class="modal-layer">
    <div class="m-head">
        <span class="m-title">FORUM</span>
        <button class="btn" style="border-color:var(--pink);color:var(--pink);" onclick="ui.hideAllModals()">CLOSE</button>
    </div>
    <div class="m-body">
        <div class="forum-left">
            <h3 style="font-family:'Orbitron';font-size:1rem;">LATEST THREADS</h3>
            <div id="forum-list" class="forum-list"></div>
        </div>
        <div class="forum-right">
            <h3>NEW POST</h3>
            <textarea id="forum-input" class="textarea" placeholder="åœ¨è¿™é‡Œè¾“å…¥ä½ çš„æƒ³æ³•ï¼Œæ”¯æŒ @ç”¨æˆ·åã€‚"></textarea>
            <button class="btn" onclick="forum.post()">POST</button>
        </div>
    </div>
</div>

<!-- 7. SHOP MODAL -->
<div id="shop-layer" class="modal-layer">
    <div class="m-head">
        <span class="m-title">NGNL SHOP</span>
        <button class="btn" style="border-color:var(--pink);color:var(--pink);" onclick="ui.hideAllModals()">CLOSE</button>
    </div>
    <div class="m-body">
        <div style="display:flex;justify-content:space-between;align-items:center;">
            <div style="font-family:'Orbitron';font-size:.9rem;color:#ccc;">
                Purchase avatar frames, titles and signatures that will appear everywhere.
            </div>
            <div style="font-family:'Orbitron';color:var(--gold);">Balance: <span id="shop-coins">0</span> ğŸª™</div>
        </div>
        <div id="shop-grid" class="shop-grid"></div>
    </div>
</div>

<script>
/* ==========================================================
   NGNL SYSTEM FRONTEND v4.2  (åŒ¹é…åç«¯ï¼šç§æ— / ç§°å· / expToNext)
   ========================================================== */

const API_URL = "https://script.google.com/macros/s/AKfycbxJBrAx1_jzwNCO6kCSVyJsNANGE4ibdXy5SXva_p54B4Zot8OaJeCm3PdQsIVhdU4v/exec";

/* --- å•†åº—ç‰©å“æ ·å¼æ˜ å°„ï¼šç”¨äºæ˜¾ç¤ºå¤´åƒæ¡† / ç§°å· / ç­¾åæ–‡æœ¬ --- */
const SHOP_STYLES = {
    frame_elkia:   { class: "frame-elkia" },
    frame_flugel:  { class: "frame-flugel" },
    frame_warbeast:{ class: "frame-warbeast" },

    title_blank:   { label: "ã€ã€€ã€" },
    title_king:    { label: "KING OF GAMES" },
    title_hardcore:{ label: "HARDCORE GAMER" },

    sig_ciallo:    { label: "Cialloï½(â‰§â–½â‰¦)ï½" },
    sig_blank:     { label: "We are ã€ã€€ã€" }
};
/* --- ä½ çš„ç•ªå‰§ / ç”µå½±æ¸…å•ï¼ˆå…ˆå†™æ­»åœ¨å‰ç«¯ï¼‰ --- */
const ANIME_DATA = [
    {
        id: "ngnl_s1",
        title: "NO GAME NO LIFE ç¬¬1å­£",
        type: "series",
        cover: "ngnl_s1_cover.jpg", // æ²¡æœ‰å°±ç•™ç©ºå­—ç¬¦ä¸²
        episodes: [
            { no: 1,  title: "ç¬¬1è¯ å¤–è¡Œäººï¼ˆBeginnerï¼‰", url: "https://pan.quark.cn/s/f60b2a34c80e" },
            { no: 2,  title: "ç¬¬2è¯ æŒ‘æˆ˜è€…ï¼ˆChallengerï¼‰", url: "https://pan.quark.cn/s/f2d358da63b7" },
            { no: 3,  title: "ç¬¬3è¯ ç†Ÿç»ƒè€…ï¼ˆExpertï¼‰", url: "https://pan.quark.cn/s/9d3defe2165d" },
            { no: 4,  title: "ç¬¬4è¯ å›½ç‹ï¼ˆGrand Masterï¼‰", url: "https://pan.quark.cn/s/b6adcd920027" },
            { no: 5,  title: "ç¬¬5è¯ å¸ƒå±€ï¼ˆWeak Squareï¼‰", url: "https://pan.quark.cn/s/a21f96ca2f31" },
            { no: 6,  title: "ç¬¬6è¯ ä¸€æ­¥ï¼ˆInterestingï¼‰", url: "https://pan.quark.cn/s/dbbddce0ecfc" },
            { no: 7,  title: "ç¬¬7è¯ å¼ƒå­ï¼ˆSacrificeï¼‰", url: "https://pan.quark.cn/s/e48dbae30a3d" },
            { no: 8,  title: "ç¬¬8è¯ èµ·æ­»å›ç”Ÿï¼ˆFake Endï¼‰", url: "https://pan.quark.cn/s/c33ad75ae7d2" },
            { no: 9,  title: "ç¬¬9è¯ åˆ†ç¦»æ³•ï¼ˆSky Walkï¼‰", url: "https://pan.quark.cn/s/2afb0c4846ee" },
            { no: 10, title: "ç¬¬10è¯ æŒ‡å‘æ³•ï¼ˆBlue Roseï¼‰", url: "https://pan.quark.cn/s/36103d7949a8" },
            { no: 11, title: "ç¬¬11è¯ è¯±å¯¼æ³•ï¼ˆKilling Giantï¼‰", url: "https://pan.quark.cn/s/6d0ce1c6a38c" },
            { no: 12, title: "ç¬¬12è¯ æ”¶æŸæ³•ï¼ˆRule Number 10ï¼‰", url: "https://pan.quark.cn/s/6055834c0940" }
        ]
    },
    {
        id: "ngnl_movie",
        title: "NO GAME NO LIFE ZERO å‰§åœºç‰ˆ",
        type: "movie",
        cover: "ngnl_movie_cover.jpg",
        episodes: [
            { no: 1, title: "å‰§åœºç‰ˆ", url: "https://pan.quark.cn/s/121fcf65a219" }
        ]
    }
];

const state = {
    user:{
        name:"Guest",
        rank:16,
        exp:0,
        expToNext:100,
        race:"",
        rankTitle:"",
        coins:0,
        bio:"",
        avatar:"",
        frameKey:"",
        titleKey:"",
        sigKey:""
    },
    isLoggedIn:false,
    activeChat:null,
    novel:{
        lines:[],
        comments:{},
        activeCommentLine:-1,
        toc:[],
        bookmarks:[],
        linesPerPage:24,
        pages:[],
        currentPage:0,
        totalPages:0,
        initialized:false
    }
};

/* æŠŠåç«¯ profile å¯¹è±¡åŒæ­¥åˆ°å‰ç«¯ state çš„ç»Ÿä¸€å‡½æ•° */
function applyProfileFromServer(p){
    if(!p) return;

    // âœ… å…¼å®¹ä¸¤ç§è¿”å›ï¼š{status, username, ...} æˆ– {status, profile:{...}}
    if (p.profile) p = p.profile;

    state.user.name       = p.username;
    state.user.rank       = p.rank || 16;
    // ä½¿ç”¨åç«¯è¿”å›çš„ rankRace (å…¼å®¹æ—§çš„ p.race)
    state.user.race       = p.rankRace || p.race || "";
    state.user.rankTitle  = p.rankTitle || "";
    state.user.exp        = p.exp  || 0;
    state.user.expToNext  = p.expToNext || 100;
    state.user.coins      = p.coins|| 0;
    state.user.bio        = p.bio  || "";
    state.user.avatar     = p.avatar || p.avatarUrl || "";
    state.user.frameKey   = p.frameKey || "";
    state.user.titleKey   = p.titleKey || "";
    state.user.sigKey     = p.sigKey   || "";

    sessionStorage.setItem('ngnlUser',JSON.stringify(state.user));
    ui.updateHUD();
    ui.updateProfileView();
}

async function apiRequest(payload){
    if(!API_URL.startsWith('https')){
        const errorTarget=document.getElementById('auth-msg');
        if(errorTarget && !state.isLoggedIn){
            errorTarget.innerText="API URL is not configured.";
        }
        console.error("API URL is not configured.");
        return {status:'error',message:'API URL not configured.'};
    }
    if(state.isLoggedIn){
        payload.username=state.user.name;   // å‘é€å½“å‰ç”¨æˆ·åç»™åç«¯
    }
    try{
        const response=await fetch(API_URL,{
            method:'POST',
            mode:'cors',
            cache:'no-cache',
            headers:{'Content-Type':'text/plain;charset=utf-8'},
            body:JSON.stringify(payload),
            redirect:'follow'
        });
        return await response.json();
    }catch(e){
        console.error("API Error:",e);
        return {status:'error',message:'Network or server error.'};
    }
}

/* ================= UI & ç”¨æˆ·æ ·å¼æ¸²æŸ“ =================== */

const ui={
    elements:{
        authOverlay:document.getElementById('auth-overlay'),
        body:document.getElementById('body'),
        authMsg:document.getElementById('auth-msg'),
        hudUsername:document.getElementById('hud-username'),
        hudCoins:document.getElementById('hud-coins'),
    },

    showModal(id){
        if(!state.isLoggedIn && !['auth-overlay','profile-viewer-overlay'].includes(id)){
            alert("Please log in to access this feature.");
            this.elements.body.classList.add('auth-active');
            this.elements.authOverlay.classList.add('active');
            return;
        }
        this.hideAllModals();
        const m=document.getElementById(id);
        if(m) m.classList.add('active');
        if(id==='user-overlay') social.init();
    },
    hideAllModals(){
        document.querySelectorAll('.modal-layer').forEach(m=>m.classList.remove('active'));
    },

    switchAuth(view){
        ['login','register','confirm'].forEach(id=>document.getElementById('form-'+id).classList.add('hidden'));
        document.getElementById('form-'+view).classList.remove('hidden');
        document.getElementById('auth-head').innerText=view==='login'?'SYSTEM LOGIN':'PLAYER REGISTRATION';
        this.elements.authMsg.innerText='';
    },
    showAuthError(msg){this.elements.authMsg.innerText=msg;},

    updateHUD(){
        this.elements.hudUsername.innerText=state.user.name.toUpperCase();
        this.elements.hudCoins.innerText=`ğŸª™ ${state.user.coins}`;
        const shopCoins=document.getElementById('shop-coins');
        if(shopCoins) shopCoins.innerText=state.user.coins;
    },

    updateProfileView(){
        const titleLabel = SHOP_STYLES[state.user.titleKey]?.label || "";
        const sigLabel   = SHOP_STYLES[state.user.sigKey]?.label   || "";

        document.getElementById('profile-name').innerText=state.user.name;
        document.getElementById('profile-coins').innerText=`ğŸª™ ${state.user.coins}`;
        document.getElementById('profile-bio').innerText=state.user.bio||"This player is lazy.";
        document.getElementById('profile-signature').innerText = sigLabel || "";
        document.getElementById('profile-title').innerText = titleLabel || "";

        // ====== RANK æ˜¾ç¤ºï¼šç§æ— + ç§°å· ======
        const rankBox = document.getElementById('profile-rank');
        const race    = state.user.race || "Imanity";
        const rTitle  = state.user.rankTitle || ("Rank " + state.user.rank);
        rankBox.textContent = `${race} Â· ${rTitle}`;

        // æ ¹æ® rank è®¾ç½®ä¸åŒç‚«é…·ç¨‹åº¦
        rankBox.classList.remove('rank-tier-C','rank-tier-B','rank-tier-A');
        if(state.user.rank <= 4){
            rankBox.classList.add('rank-tier-A'); // é¡¶çº§ï¼šæ—§ç¥/é¾™/å¤©ç¿¼
        }else if(state.user.rank <= 8){
            rankBox.classList.add('rank-tier-B'); // ä¸­å±‚ç§
        }else{
            rankBox.classList.add('rank-tier-C'); // æ–°æ‰‹ã€äººç±»é˜¶æ®µ
        }

        // ====== ç»éªŒæ¡ï¼šä½¿ç”¨ expToNext åŠ¨æ€éœ€æ±‚ ======
        const need   = state.user.expToNext || 100;
        const expNow = state.user.exp || 0;
        const expFill=document.getElementById('profile-exp-fill');

        if(state.user.rank === 1){
            expFill.style.width = "100%";
            document.getElementById('profile-exp-text').innerText = "MAX (Old Deus)";
        }else{
            const percent = Math.max(0, Math.min(100, Math.round(expNow / need * 100)));
            expFill.style.width = percent + "%";
            document.getElementById('profile-exp-text').innerText = `${expNow} / ${need}`;
        }

        // å¤´åƒ / æ¡†
const avImg = document.getElementById('profile-avatar');
const frameEl = document.getElementById('profile-avatar-frame');

// è®¾ç½®å¤´åƒåœ°å€
avImg.src = state.user.avatar || "sora.png";

// æ ¹æ®æœ‰æ²¡æœ‰å¤´åƒï¼Œç»™å¤–æ¡†åŠ  / å»æ‰ has-avatar
if (state.user.avatar) {
    frameEl.classList.add('has-avatar');
} else {
    frameEl.classList.remove('has-avatar');
}

// å¤´åƒæ¡†æ ·å¼
frameEl.classList.remove('frame-elkia','frame-flugel','frame-warbeast');
const fk = state.user.frameKey;
if (fk && SHOP_STYLES[fk] && SHOP_STYLES[fk].class) {
    frameEl.classList.add(SHOP_STYLES[fk].class);
}


        document.getElementById('settings-bio').value=state.user.bio||"";
        document.getElementById('settings-avatar').value=state.user.avatar||"";
    },

    /* ä»»ä½•åœ°æ–¹æ˜¾ç¤ºå¤´åƒæ¡†/ç§°å·/ç­¾åéƒ½ç”¨è¿™ä¸ªç»Ÿä¸€æ¸²æŸ“ */
    renderUserStyle(src){
        const name = src.user || state.user.name;
        const avatar = src.avatar || src.avatarUrl || "";
        const frameKey = src.frameKey || "";
        const titleKey = src.titleKey || "";
        const sigKey   = src.sigKey || "";

        const frameClass = frameKey && SHOP_STYLES[frameKey]?.class ? SHOP_STYLES[frameKey].class : "";
        const titleLabel = titleKey && SHOP_STYLES[titleKey]?.label ? SHOP_STYLES[titleKey].label : "";
        const sigLabel   = sigKey && SHOP_STYLES[sigKey]?.label ? SHOP_STYLES[sigKey].label : "";

        const avatarHTML = `
            <div class="mini-avatar avatar-frame ${frameClass}">
                ${avatar ? `<img src="${avatar}" alt="">` : ""}
            </div>`;

        const nameHTML = `
            <span class="user-name" onclick="ui.showOtherUserProfile('${name}')">${name}</span>
            ${titleLabel ? `<span class="user-title">${titleLabel}</span>` : ""}`;

        const subHTML = sigLabel ? `<span class="user-signature">${sigLabel}</span>` : "";

        return { avatarHTML, nameHTML, subHTML };
    },

    showOtherUserProfile(username){
        if(username===state.user.name){
            ui.showModal('user-overlay');
            return;
        }
        const container=document.getElementById('profile-viewer-content');
        container.innerHTML=`<p>Loading ${username}'s profile...</p>`;
        document.getElementById('profile-viewer-overlay').classList.add('active');
        apiRequest({action:'get_profile',target_user:username}).then(res=>{
            if(res.status==='success'){
                const p=res.profile;
                const style = ui.renderUserStyle({
                    user:p.username,
                    avatar:p.avatar,
                    frameKey:p.frameKey,
                    titleKey:p.titleKey,
                    sigKey:p.sigKey
                });

                const race = p.rankRace || "Imanity";
                const rTitle = p.rankTitle || ("Rank " + p.rank);
                const need = p.expToNext || 0;
                const expNow = p.exp || 0;

                let badgeClass = "rank-badge ";
                if(p.rank <= 4) badgeClass += "rank-tier-A";
                else if(p.rank <= 8) badgeClass += "rank-tier-B";
                else badgeClass += "rank-tier-C";

                let expText, percent;
                if(p.rank === 1){
                    expText = "MAX (Old Deus)";
                    percent = 100;
                }else{
                    const n = need || 1;
                    percent = Math.max(0, Math.min(100, Math.round(expNow / n * 100)));
                    expText = `${expNow} / ${n}`;
                }

                container.innerHTML=`
                    <div style="display:flex;align-items:center;gap:14px;">
                        ${style.avatarHTML}
                        <div>
                            <div>${style.nameHTML}</div>
                            <div style="margin-top:4px;">${style.subHTML || ""}</div>
                            <div style="color:#aaa;font-size:.85rem;margin-top:6px;">${p.bio||""}</div>
                        </div>
                    </div>
                    <div class="stat-grid" style="margin-top:20px;grid-template-columns:1fr 1fr;gap:15px;">
                        <div class="stat-box">
                            <div style="font-size:.8rem;color:#aaa;">RACE / TITLE</div>
                            <div class="${badgeClass}">${race} Â· ${rTitle}</div>
                        </div>
                        <div class="stat-box">
                            <div style="font-size:.8rem;color:#aaa;">COINS</div>
                            <div style="font-size:1.5rem;">ğŸª™ ${p.coins}</div>
                        </div>
                    </div>
                    <div style="margin-top:18px;">
                        <div class="exp-text">EXP</div>
                        <div class="exp-bar">
                            <div class="exp-fill" style="width:${percent}%;"></div>
                        </div>
                        <div class="exp-text">${expText}</div>
                    </div>`;
            }else{
                container.innerHTML=`<p style="color:var(--pink);">${res.message}</p>`;
            }
        });
    },

    switchProfileTab(tab){
        ['stats','chat','settings'].forEach(t=>{
            document.getElementById('view-'+t).classList.add('hidden');
            document.getElementById('tab-'+t).classList.remove('active');
        });
        document.getElementById('view-'+tab).classList.remove('hidden');
        document.getElementById('tab-'+tab).classList.add('active');
    }
};

/* ================== è®¤è¯ ================== */

const auth = {
    tempRegData:{},

    async login(){
        const email = document.getElementById('login-email').value.trim();
        const password = document.getElementById('login-pass').value;

        if(!email || !password){
            return ui.showAuthError("Email and password are required.");
        }

        ui.showAuthError("Connecting...");

        const res = await apiRequest({ action:'login', email, password });

        if(res.status === 'success'){
            // â¬‡ï¸ login ç›´æ¥è¿”å›çš„å°±æ˜¯ profile å­—æ®µé›†åˆï¼ˆæ²¡æœ‰ res.profile è¿™ä¸€å±‚ï¼‰
            applyProfileFromServer(res);

            state.isLoggedIn = true;
            ui.elements.authOverlay.classList.remove('active');
            ui.elements.body.classList.remove('auth-active');
            ui.showAuthError("");
        }else{
            ui.showAuthError(res.message || "Login failed.");
        }
    },
   async requestCode(){
        const user=document.getElementById('reg-user').value.trim();
        const email=document.getElementById('reg-email').value.trim();
        const pass=document.getElementById('reg-pass').value;
        if(!user||!email||!pass) return ui.showAuthError("All fields are required.");
        const btn=document.getElementById('reg-code-btn');
        btn.disabled=true;btn.innerText="REQUESTING...";
        ui.showAuthError("Requesting code...");
        const res=await apiRequest({action:'request_code',email});
        btn.disabled=false;btn.innerText="GET CODE";
        if(res.status==='success'){
            this.tempRegData={user,email,pass};
            ui.switchAuth('confirm');
            alert(res.message);
        }else ui.showAuthError(res.message);
    },
    async register(){
        const code=document.getElementById('reg-code').value.trim();
        if(!code) return ui.showAuthError("Verification code is required.");
        ui.showAuthError("Registering...");
        const payload={
            action:'register',
            username:this.tempRegData.user,
            email:this.tempRegData.email,
            password:this.tempRegData.pass,
            code
        };
        const res=await apiRequest(payload);
        if(res.status==='success'){
            alert("Registration successful! Please log in.");
            ui.switchAuth('login');
        }else ui.showAuthError(res.message);
    },
    logout(){
        if(confirm("Are you sure you want to log out?")){
            sessionStorage.removeItem('ngnlUser');
            window.location.reload();
        }
    }
};

/* ================== ç¤¾äº¤ & å¥½å‹ç³»ç»Ÿ ================== */

const social={
    init(){
        this.loadFriends();
        ui.updateProfileView();
        ui.switchProfileTab('stats');
    },
    async loadFriends(){
        const list=document.getElementById('friend-list');
        list.innerHTML=`<div class="f-item">Loading friends...</div>`;
        const res=await apiRequest({action:'get_friends'});
        let html=`<div class="f-item active" onclick="social.showMyStats(event)"><span class="f-name">MY PROFILE</span></div>`;
        if(res.status==='success' && res.data){
            res.data.forEach(f=>{
                html+=`<div class="f-item" data-name="${f.name}">
                    <span class="f-name" onclick="social.startChat('${f.name}',event)">${f.name}</span>
                    ${social.getFriendStatusUI(f)}
                </div>`;
            });
        }
        list.innerHTML=html;
    },
    getFriendStatusUI(friend){
        if(friend.status==='Accepted') return `<span class="f-status" style="color:var(--cyan)">FRIEND</span>`;
        if(friend.status==='Sent') return `<span class="f-status">SENT</span>`;
        if(friend.status==='Received'){
            return `<div class="f-actions">
                <button class="btn" onclick="social.handleFriendRequest('${friend.name}','Accepted')">âœ“</button>
                <button class="btn" style="border-color:var(--pink);color:var(--pink)" onclick="social.handleFriendRequest('${friend.name}','Declined')">Ã—</button>
            </div>`;
        }
        return '';
    },
    async handleFriendRequest(target,status){
        const res=await apiRequest({action:'update_friend_status',target_user:target,new_status:status});
        alert(res.message);
        if(res.status==='success') this.loadFriends();
    },
    showMyStats(e){
        ui.switchProfileTab('stats');
        document.querySelectorAll('#friend-list .f-item').forEach(el=>el.classList.remove('active'));
        e.currentTarget.classList.add('active');
    },
    async addFriend(){
        const name=prompt("Enter the player's name to send a friend request:");
        if(name && name.trim()){
            const res=await apiRequest({action:'add_friend',target_user:name.trim()});
            alert(res.message);
            if(res.status==='success') this.loadFriends();
        }
    },
    startChat(target,e){
        state.activeChat=target;
        ui.switchProfileTab('chat');
        document.getElementById('chat-header').innerText=`Chat with ${target}`;
        document.querySelectorAll('#friend-list .f-item').forEach(el=>el.classList.remove('active'));
        e.currentTarget.closest('.f-item').classList.add('active');
        this.loadMessages();
    },
    async loadMessages(){
        if(!state.activeChat) return;
        const box=document.getElementById('chat-box');
        box.innerHTML="Loading messages...";
        const res=await apiRequest({action:'get_messages',target_user:state.activeChat});
        if(res.status==='success' && res.data){
            box.innerHTML=res.data.map(m=>`<div class="msg ${m.sender===state.user.name?'me':'them'}">${m.content}</div>`).join('')||"No messages yet. Say hi!";
            box.scrollTop=box.scrollHeight;
        }
    },
    async sendMessage(){
        const input=document.getElementById('msg-input');
        const content=input.value.trim();
        if(!content || !state.activeChat) return;
        const box=document.getElementById('chat-box');
        box.innerHTML+=`<div class="msg me">${content}</div>`;
        box.scrollTop=box.scrollHeight;
        input.value="";
        await apiRequest({action:'send_message',target_user:state.activeChat,content});
    },
    insertEmoji(e){
        const input=document.getElementById('msg-input');
        const start = input.selectionStart ?? input.value.length;
        input.value = input.value.slice(0,start) + e + input.value.slice(start);
        input.focus();
        input.selectionStart = input.selectionEnd = start + e.length;
    }
};

/* ================== ç”¨æˆ·è®¾ç½® ================== */

const settings={
    async saveProfile(){
        const bio=document.getElementById('settings-bio').value.trim();
        const res=await apiRequest({action:'update_profile',bio});
        if(res.status==='success'){
            applyProfileFromServer(res.profile);
            alert("Profile updated.");
        }else alert(res.message);
    },
    async saveAvatar(){
        const avatar=document.getElementById('settings-avatar').value.trim();
        const res=await apiRequest({action:'update_profile',avatar});
        if(res.status==='success'){
            applyProfileFromServer(res.profile);
            alert("Avatar updated.");
        }else alert(res.message);
    },
    async uploadAvatarFile(){
    const input = document.getElementById('settings-avatar-file');
    const file = input.files && input.files[0];
    if(!file) return alert("è¯·é€‰æ‹©ä¸€å¼ å›¾ç‰‡ã€‚");

    // å¯é€‰ï¼šé™åˆ¶ä¸€ä¸‹å¤§å°ï¼Œæ¯”å¦‚ 12MB
    const MAX_SIZE = 12 * 1024 * 1024;
    if(file.size > MAX_SIZE){
        if(!confirm("å›¾ç‰‡å¤§äº 12MBï¼Œä»ç„¶ç»§ç»­ä¸Šä¼ å—ï¼Ÿ")) return;
    }

    const reader = new FileReader();
    reader.onload = async (e) => {
        const result = e.target.result; // data:image/png;base64,xxxx
        const match = /^data:(.*?);base64,(.*)$/.exec(result);
        if(!match){
            alert("æ— æ³•è¯»å–è¿™å¼ å›¾ç‰‡ã€‚");
            return;
        }
        const mimeType  = match[1];
        const base64Data= match[2];

        // è°ƒç”¨åç«¯ upload_avatar
        const res = await apiRequest({
            action: 'upload_avatar',
            fileName: file.name,
            mimeType: mimeType,
            data: base64Data
        });

        if(res.status === 'success'){
            // 1ï¼‰ç”¨ç»Ÿä¸€å‡½æ•°åŒæ­¥æ‰€æœ‰å­—æ®µï¼ˆåŒ…æ‹¬ avatarï¼‰
            applyProfileFromServer(res);

            // 2ï¼‰æŠŠåç«¯è¿”å›çš„ç›´é“¾å¡«å›è¾“å…¥æ¡†ï¼Œæ–¹ä¾¿å¤åˆ¶
            if(res.avatarUrl){
                document.getElementById('settings-avatar').value = res.avatarUrl;
            }

            alert("Avatar uploaded!");
        }else{
            alert(res.message || "Upload failed.");
        }
    };
    reader.onerror = () => {
        alert("è¯»å–å›¾ç‰‡å¤±è´¥ã€‚");
    };
    reader.readAsDataURL(file);
},

    async changeName(){
        const newName=document.getElementById('settings-newname').value.trim();
        if(!newName) return alert("è¯·è¾“å…¥æ–°åå­—ã€‚");
        if(!confirm("æ”¹åå°†æ¶ˆè€— 100 ğŸª™ï¼Œç¡®å®šå—ï¼Ÿ")) return;
        const res=await apiRequest({action:'update_profile',new_name:newName});
        if(res.status==='success'){
            applyProfileFromServer(res.profile);
            alert("Name changed successfully.");
        }else alert(res.message);
    }
};

/* ================== å°è¯´é˜…è¯»å™¨ ================== */

const reader={
    async ensureReady(){
        if(!state.novel.initialized){
            await this.init();
            state.novel.initialized=true;
        }
    },
    async init(){
        const textArea=document.getElementById('reader-text-area');
        try{
            const [novelResponse,commentRes]=await Promise.all([
                fetch('novel.txt'),
                apiRequest({action:'get_all_comments'})
            ]);
            if(!novelResponse.ok) throw new Error('novel.txt not found in your repo.');
            const text=await novelResponse.text();
            state.novel.lines=text.replace(/\r\n/g,"\n").split('\n');
            if(commentRes.status==='success') state.novel.comments=commentRes.data||{};
            this.parseAndPaginate();
            visuals.initReaderBG();
        }catch(err){
            console.error(err);
            textArea.innerHTML=`<p style="text-align:center;color:var(--pink);">${err.message}</p>`;
        }
    },
    parseAndPaginate(){
    const lines = state.novel.lines;

    // âœ… 1. æ›´ä¸¥æ ¼çš„ç« èŠ‚è¯†åˆ«ï¼šè¡Œé¦– + ç« /è¯/å›/å· + å¸¸è§ç‰¹ä¾‹
    const chapterRegex = /^(ç¬¬.{1,12}[ç« è¯å›å·]|åºç« |ç»ˆç« |Prologue|Epilogue|Chapter\s+\d+)/i;

    const pages = [];
    const toc   = [];
    let currentStart = 0;
    let buffer = [];
    const LPP = state.novel.linesPerPage;

    const flushPage = (endIndex)=>{
        if(endIndex > currentStart){
            pages.push({ start: currentStart, end: endIndex });
        }
    };

    for(let i=0;i<lines.length;i++){
        const line = lines[i];
        const pure = line.replace(/\s/g,"");
        const isChapter = chapterRegex.test(pure);

        // ç¢°åˆ°æ–°ç« èŠ‚æ ‡é¢˜ï¼šå¦‚æœå½“å‰é¡µå·²æœ‰å†…å®¹ï¼Œå…ˆç»“ç®—ä¸Šä¸€é¡µ
        if(isChapter && buffer.length > 0){
            flushPage(i);
            currentStart = i;   // æ–°é¡µä»æœ¬ç« èŠ‚æ ‡é¢˜å¼€å§‹
            buffer = [];
        }

        // åªè®°å½•â€œç« èŠ‚æ ‡é¢˜è¡Œâ€åˆ°ç›®å½•ï¼Œä¸å†æå‰çŒœ pageIndex
        if(isChapter){
            toc.push({
                title: line.trim() || `Chapter @${i+1}`,
                lineIndex: i
            });
        }

        buffer.push(line);

        // æ­£å¸¸æŒ‰ LPP è¡Œæ•°åˆ†é¡µ
        if(buffer.length >= LPP){
            flushPage(i+1);
            currentStart = i+1;
            buffer = [];
        }
    }

    // æ”¶å°¾ï¼šæœ€åä¸€é¡µ
    if(buffer.length > 0){
        flushPage(lines.length);
    }

    state.novel.pages      = pages;
    state.novel.totalPages = pages.length;

    // âœ… 2. åœ¨åˆ†é¡µå®Œæˆä¹‹åï¼Œå†ç»Ÿä¸€ç»™ TOC è¡¥ä¸Šæ­£ç¡®çš„ pageIndex
    state.novel.toc = toc.map(ch=>{
        const pageIndex = pages.findIndex(p => ch.lineIndex >= p.start && ch.lineIndex < p.end);
        return { ...ch, pageIndex };
    });

    this.renderTOC();
    this.loadBookmarks();
    this.renderBookmarks();
    this.goToPage(0);
},
    goToPage(page){
        if(page<0 || page>=state.novel.totalPages) return;
        state.novel.currentPage=page;
        const seg=state.novel.pages[page];
        const start=seg.start,end=seg.end;
        const textArea=document.getElementById('reader-text-area');
        const html=state.novel.lines.slice(start,end).map((line,i)=>{
            const idx=start+i;
            if(!line.trim()) return '<br>';
            const cnt=state.novel.comments[idx]?state.novel.comments[idx].length:0;
            return `<div class="line" data-line-index="${idx}">
                ${line}
                <div class="comment-bubble" onclick="reader.openCommentSidebar(${idx})">
                    <span class="comment-icon">â™Ÿ</span>
                    ${cnt>0?`<span class="comment-count">${cnt}</span>`:""}
                </div>
            </div>`;
        }).join('');
        textArea.innerHTML=html;
        textArea.scrollTop=0;
        document.getElementById('reader-progress').innerText=`${page+1} / ${state.novel.totalPages}`;
    },
    goToChapter(lineIndex){
        const pageIdx=state.novel.pages.findIndex(p=>lineIndex>=p.start && lineIndex<p.end);
        if(pageIdx>=0) this.goToPage(pageIdx);
    },
    switchTab(tab){
        document.getElementById('tab-toc').classList.toggle('active',tab==='toc');
        document.getElementById('content-toc').classList.toggle('hidden',tab!=='toc');
        document.getElementById('tab-bm').classList.toggle('active',tab==='bm');
        document.getElementById('content-bm').classList.toggle('hidden',tab!=='bm');
    },
    renderTOC(){
        const c=document.getElementById('content-toc');
        if(state.novel.toc.length===0){
            c.innerHTML=`<p style="padding:12px;color:#888;">No chapter titles detected.</p>`;
            return;
        }
        c.innerHTML=state.novel.toc.map(ch=>`
            <div class="toc-item" onclick="reader.goToChapter(${ch.lineIndex})">
                <strong>${ch.title}</strong>
                <small>Page ${ch.pageIndex+1}</small>
            </div>`).join('');
    },
    loadBookmarks(){
        state.novel.bookmarks=JSON.parse(localStorage.getItem('ngnl_bookmarks')||'[]');
    },
    renderBookmarks(){
        const c=document.getElementById('content-bm');
        if(state.novel.bookmarks.length===0){
            c.innerHTML=`<p style="padding:12px;color:#888;">No bookmarks yet.</p>`;
            return;
        }
        c.innerHTML=state.novel.bookmarks.map((bm,idx)=>`
            <div class="bm-item" onclick="reader.goToPage(${bm.page})">
                Page ${bm.page+1} - ${bm.line.substring(0,20)}...
                <button onclick="reader.removeBookmark(${idx},event)" style="float:right;background:none;border:none;color:var(--pink);font-size:.8rem;">X</button>
            </div>`).join('');
    },
    addBookmark(){
        const p=state.novel.currentPage;
        if(state.novel.bookmarks.some(b=>b.page===p)) return alert("This page is already bookmarked.");
        const seg=state.novel.pages[p];
        const firstLine=state.novel.lines[seg.start]||"Empty Page";
        state.novel.bookmarks.push({page:p,line:firstLine});
        localStorage.setItem('ngnl_bookmarks',JSON.stringify(state.novel.bookmarks));
        this.renderBookmarks();
        alert(`Page ${p+1} bookmarked!`);
    },
    removeBookmark(i,e){
        e.stopPropagation();
        if(!confirm("Remove this bookmark?")) return;
        state.novel.bookmarks.splice(i,1);
        localStorage.setItem('ngnl_bookmarks',JSON.stringify(state.novel.bookmarks));
        this.renderBookmarks();
    },
    openCommentSidebar(lineIndex){
        state.novel.activeCommentLine=lineIndex;
        document.getElementById('cmt-header-title').innerText=`Line ${lineIndex+1}`;
        const cList=document.getElementById('cmt-list');
        const arr=state.novel.comments[lineIndex]||[];
        if(arr.length===0){
            cList.innerHTML=`<p style="text-align:center;color:#888;padding:20px;">No comments yet. Be the first!</p>`;
        }else{
            cList.innerHTML=arr.map(reader.formatComment).join('');
        }
        document.getElementById('reader-comment-sidebar').classList.add('open');
    },
    closeCommentSidebar(){
        document.getElementById('reader-comment-sidebar').classList.remove('open');
    },
    formatComment(c){
        const content=c.content.replace(/@(\w+)/g,`<span class="mention-link" onclick="ui.showOtherUserProfile('$1')">@$1</span>`);
        const style = ui.renderUserStyle(c);
        return `<div class="cmt-card">
            <div class="cmt-user">
                ${style.avatarHTML}
                <div>
                    <div>${style.nameHTML}</div>
                    ${style.subHTML ? `<div class="cmt-meta">${style.subHTML}</div>` : ""}
                </div>
            </div>
            <div class="cmt-content">${content}</div>
            <div class="cmt-actions">
                <span onclick="community.interact('like','${c.id}','comment')">â™¥ ${c.likes}</span>
                <span onclick="community.interact('tip','${c.id}','comment')">ğŸª™ ${c.coins||0}</span>
            </div>
        </div>`;
    },
    async postComment(){
        const input=document.getElementById('cmt-input');
        const content=input.value.trim();
        if(!content || state.novel.activeCommentLine<0) return;
        if(!state.isLoggedIn) return alert("You must be logged in to comment.");
        input.disabled=true;
        await apiRequest({action:'post_line_comment',line_index:state.novel.activeCommentLine,content});
        input.value="";input.disabled=false;
        const res=await apiRequest({action:'get_all_comments'});
        if(res.status==='success'){
            state.novel.comments=res.data||{};
            this.goToPage(state.novel.currentPage);
            this.openCommentSidebar(state.novel.activeCommentLine);
        }
    }
};

/* ================== ç‚¹èµ / æ‰“èµ ================== */

const community={
    async interact(subAction,id,type){
        if(!state.isLoggedIn) return alert("Login required.");
        if(subAction==='tip' && !confirm("Spend 1 coin?")) return;
        const res=await apiRequest({action:'interact',sub_action:subAction,type,id});
        if(res.status==='success'){
            if(subAction==='tip' && typeof res.new_balance!=='undefined'){
                state.user.coins=res.new_balance;
                sessionStorage.setItem('ngnlUser',JSON.stringify(state.user));
                ui.updateHUD();
            }
            // åŒæ­¥è¯„è®º + è®¨è®ºåŒºå±•ç¤º
            const [cRes,dRes]=await Promise.all([
                apiRequest({action:'get_all_comments'}),
                apiRequest({action:'get_discussions'})
            ]);
            if(cRes.status==='success'){
                state.novel.comments=cRes.data||{};
                reader.goToPage(state.novel.currentPage);
                if(state.novel.activeCommentLine>=0) reader.openCommentSidebar(state.novel.activeCommentLine);
            }
            if(dRes.status==='success') forum.render(dRes.data);
        }else alert(res.message);
    }
};

/* ================== è®¨è®ºåŒº ================== */

const forum={
    async init(){
        const res=await apiRequest({action:'get_discussions'});
        if(res.status==='success') this.render(res.data);
    },
    render(list){
        const box=document.getElementById('forum-list');
        if(!list || list.length===0){
            box.innerHTML=`<p style="color:#888;padding:10px;">No posts yet. Be the first challenger.</p>`;
            return;
        }
        box.innerHTML=list.map(p=>{
            const style = ui.renderUserStyle(p);
            const content=p.content.replace(/@(\w+)/g,`<span class="mention-link" onclick="ui.showOtherUserProfile('$1')">@$1</span>`);
            return `<div class="post-card">
                ${style.avatarHTML}
                <div class="post-main">
                    <div class="post-header">
                        ${style.nameHTML}
                    </div>
                    <div class="post-content">${content}</div>
                    <div class="post-meta">${p.time}</div>
                    <div class="post-actions">
                        <span onclick="community.interact('like','${p.id}','discussion')">â™¥ ${p.likes}</span>
                        <span onclick="community.interact('tip','${p.id}','discussion')">ğŸª™ ${p.coins||0}</span>
                    </div>
                </div>
            </div>`;
        }).join('');
    },
    async post(){
        const input=document.getElementById('forum-input');
        const content=input.value.trim();
        if(!content) return;
        if(!state.isLoggedIn) return alert("Login required.");
        input.disabled=true;
        const res=await apiRequest({action:'post_discussion',content});
        input.disabled=false;
        if(res.status==='success'){
            input.value="";
            this.init();
        }else alert(res.message);
    }
};

/* ================== å•†åº—ï¼ˆå¯¹æ¥åç«¯ get_shop / buy_itemï¼‰ ================== */

const shop={
    async init(){
        await this.refresh();
    },
    async refresh(){
        ui.updateHUD();
        const grid=document.getElementById('shop-grid');
        grid.innerHTML="<p>Loading shop...</p>";
        const res=await apiRequest({action:'get_shop'});
        if(res.status!=='success'){
            grid.innerHTML=`<p style="color:var(--pink);">${res.message}</p>`;
            return;
        }
        const ownedMap=res.owned || {};
        const styles=res.styles || {};
        state.user.frameKey = styles.frameKey || state.user.frameKey;
        state.user.titleKey = styles.titleKey || state.user.titleKey;
        state.user.sigKey   = styles.sigKey   || state.user.sigKey;
        ui.updateProfileView();
        this.render(res.items || [], ownedMap, styles);
    },
    render(items, ownedMap, styles){
        const grid=document.getElementById('shop-grid');
        grid.innerHTML=items.map(it=>{
            const own = ownedMap[it.key];
            const isActive =
                (it.category==='frame' && styles.frameKey===it.key) ||
                (it.category==='title' && styles.titleKey===it.key) ||
                (it.category==='signature' && styles.sigKey===it.key);
            const btnLabel = own ? (isActive ? "EQUIPPED" : "EQUIP") : `BUY (${it.price}ğŸª™)`;
            const disabled = isActive ? "disabled" : "";
            const ownedTag = own ? `<div class="shop-owned">OWNED</div>` : "";
            return `<div class="shop-card">
                <div class="shop-inner">
                    <div class="shop-tag">${it.category.toUpperCase()}</div>
                    <div class="shop-name">${it.name}</div>
                    <div class="shop-price">Price: ${it.price} ğŸª™</div>
                    <div class="shop-desc">${it.desc}</div>
                    ${ownedTag}
                    <button class="btn" style="width:100%;margin-top:6px;" ${disabled}
                        onclick="shop.buy('${it.key}')">${btnLabel}</button>
                </div>
            </div>`;
        }).join('');
        ui.updateHUD();
    },
    async buy(key){
        const res=await apiRequest({action:'buy_item',key});
        if(res.status!=='success'){
            alert(res.message);
            return;
        }
        state.user.coins = res.new_balance;
        if(res.styles){
            state.user.frameKey = res.styles.frameKey || state.user.frameKey;
            state.user.titleKey = res.styles.titleKey || state.user.titleKey;
            state.user.sigKey   = res.styles.sigKey   || state.user.sigKey;
        }
        sessionStorage.setItem('ngnlUser',JSON.stringify(state.user));
        ui.updateHUD();
        ui.updateProfileView();
        this.refresh();
    }
};

/* ================== è§†è§‰æ•ˆæœï¼ˆè§’è‰²å¡ / èƒŒæ™¯ï¼‰ ================== */

const visuals={
    init(){
        this.initPlayers();
        this.initCursor();
        this.initCanvas();
        this.initRaces();
        this.initEmojiBar();
    },
    initPlayers(){
        const players=[
            {n:'IZUNA',r:'Warbeast / Knight',img:'izuna.png',d:'æ‹¥æœ‰â€œè¡€åâ€çš„å…½äººå°‘å¥³ï¼Œç¬é—´è¯»å–åœºä¸Šçš„ä¸€åˆ‡ä¿¡æ¯ã€‚'},
            {n:'JIBRIL',r:'FlÃ¼gel / Bishop',img:'jibril.png',d:'ç‹‚çƒ­çš„çŸ¥è¯†æ”¶é›†ç‹‚ï¼ŒæŒæ¡æ¯ç­çº§é­”æ³•çš„å¤©ç¿¼ç§ã€‚'},
            {n:'SHIRO',r:'Imanity / Queen',img:'shiro.png',d:'è®¡ç®—åŠ›è¶…è¶Šäººç±»æé™çš„å¤©æ‰å°‘å¥³ï¼Œæ˜¯ã€ã€€ã€€ã€çš„å¤´è„‘ã€‚'},
            {n:'SORA',r:'Imanity / King',img:'sora.png',d:'è¯»å¿ƒçº§å¿ƒç†æˆ˜é«˜æ‰‹ï¼Œç›¸ä¿¡â€œäººç±»çš„å¯èƒ½æ€§â€èƒœè¿‡ä¸€åˆ‡ã€‚'},
            {n:'STEPH',r:'Imanity / Pawn',img:'steph.png',d:'è‰¾å°”å¥‡äºšå…¬ä¸»ï¼Œè™½ä¸æ“…æ¸¸æˆï¼Œå´ç”¨æ‰§ç€ä¸æ¸©æŸ”æ”¯æ’‘ç‹å›½ã€‚'},
            {n:'TET',r:'OldDeus / Joker',img:'tet.png',d:'å”¯ä¸€ç¥ï¼Œæ”¯é…æ£‹ç›˜çš„è§‚æˆ˜è€…ä¸å‘èµ·è€…ã€‚'}
        ];
        document.getElementById('char-grid').innerHTML=players.map(p=>`
            <div class="char-card">
                <div class="char-inner">
                    <div class="char-face char-front">
                        <img src="${p.img}" alt="${p.n}">
                        <div class="char-front-info">
                            <div class="char-name">${p.n}</div>
                            <div class="char-race">${p.r}</div>
                        </div>
                    </div>
                    <div class="char-face char-back">
                        <div class="card-symbol">â™œ</div>
                        <p class="char-desc">${p.d}</p>
                    </div>
                </div>
            </div>`).join('');
    },
    initCursor(){
        const cursor=document.getElementById('cursor');
        document.addEventListener('mousemove',e=>{
            cursor.style.left=e.clientX+'px';
            cursor.style.top=e.clientY+'px';
        });
        document.body.addEventListener('mouseover',e=>{
            if(e.target.closest('a,button,.btn,.char-card,.f-item,.auth-link,[onclick]')) cursor.classList.add('hover');
            else cursor.classList.remove('hover');
        });
        document.addEventListener('mousedown',()=>cursor.classList.add('click'));
        document.addEventListener('mouseup',()=>cursor.classList.remove('click'));
    },
    initCanvas(){
        const cvs=document.getElementById('canvas-bg'),ctx=cvs.getContext('2d');
        let w=window.innerWidth,h=window.innerHeight;
        cvs.width=w;cvs.height=h;
        const particles=Array.from({length:60},()=>({
            x:Math.random()*w,
            y:Math.random()*h,
            s:Math.random()*0.6+0.2,
            char:['â™”','â™•','â™–','â™—','â™˜','â™™'][Math.floor(Math.random()*6)],
            opacity:Math.random()*0.4+0.2
        }));
        function loop(){
            ctx.clearRect(0,0,w,h);
            particles.forEach(p=>{
                p.y-=p.s;
                if(p.y<-40){p.y=h+40;p.x=Math.random()*w;}
                ctx.fillStyle=`rgba(255,255,255,${p.opacity})`;
                ctx.font='22px Orbitron';
                ctx.fillText(p.char,p.x,p.y);
            });
            requestAnimationFrame(loop);
        }
        requestAnimationFrame(loop);
        window.addEventListener('resize',()=>{
            w=window.innerWidth;h=window.innerHeight;
            cvs.width=w;cvs.height=h;
        });
    },
    initReaderBG(){
        const cvs=document.getElementById('reader-bg-canvas');
        if(!cvs.getContext) return;
        const ctx=cvs.getContext('2d');
        function resize(){
            const panel=document.querySelector('.r-main-panel');
            if(!panel) return;
            cvs.width=panel.clientWidth;
            cvs.height=panel.clientHeight;
        }
        resize();
        const dots=Array.from({length:80},()=>({
            x:Math.random()*cvs.width,
            y:Math.random()*cvs.height,
            r:Math.random()*2+1,
            vy:Math.random()*0.4+0.2
        }));
        let scrollFactor=0;
        const textArea=document.getElementById('reader-text-area');
        textArea.addEventListener('scroll',()=>{scrollFactor=textArea.scrollTop/200;});
        function draw(){
            ctx.clearRect(0,0,cvs.width,cvs.height);
            const gradient=ctx.createRadialGradient(cvs.width/2,cvs.height/2,0,cvs.width/2,cvs.height/2,cvs.width/1.2);
            gradient.addColorStop(0,'rgba(5,217,232,0.35)');
            gradient.addColorStop(0.5,'rgba(217,5,232,0.15)');
            gradient.addColorStop(1,'rgba(0,0,0,0)');
            ctx.fillStyle=gradient;
            ctx.fillRect(0,0,cvs.width,cvs.height);
            dots.forEach(d=>{
                d.y-=d.vy+scrollFactor*0.3;
                if(d.y<-10){d.y=cvs.height+10;d.x=Math.random()*cvs.width;}
                ctx.beginPath();
                ctx.fillStyle='rgba(255,255,255,0.7)';
                ctx.arc(d.x,d.y,d.r,0,Math.PI*2);
                ctx.fill();
            });
            requestAnimationFrame(draw);
        }
        window.addEventListener('resize',resize);
        requestAnimationFrame(draw);
    },
    initRaces(){
        const races=[
            {name:"Old Deus",piece:"King â™”",color:"var(--race-olddeus)"},
            {name:"Phantasma",piece:"Queen â™•",color:"var(--race-phantasma)"},
            {name:"Elemental",piece:"Queen â™•",color:"var(--race-elemental)"},
            {name:"Dragonoia",piece:"Rook â™–",color:"var(--race-dragonia)"},
            {name:"FlÃ¼gel",piece:"Bishop â™—",color:"var(--race-flugel)"},
            {name:"Demonia",piece:"Bishop â™—",color:"var(--race-demon)"},
            {name:"Fairy",piece:"Bishop â™—",color:"var(--race-fairy)"},
            {name:"Dwarf",piece:"Rook â™–",color:"var(--race-dwarf)"},
            {name:"Warbeast",piece:"Knight â™˜",color:"var(--race-werabeast)"},
            {name:"Seiren",piece:"Pawn â™™",color:"var(--race-seiren)"},
            {name:"Dhampir",piece:"Knight â™˜",color:"var(--race-dhampir)"},
            {name:"Elf",piece:"Bishop â™—",color:"var(--race-elf)"},
            {name:"Angel (Ex-Machina)",piece:"Rook â™–",color:"var(--race-angel)"},
            {name:"Goblin",piece:"Pawn â™™",color:"var(--race-goblin)"},
            {name:"Automaton",piece:"Knight â™˜",color:"var(--race-automaton)"},
            {name:"Imanity",piece:"Pawn â™™",color:"var(--race-imanity)"}
        ];
        const grid=document.getElementById('race-grid');
        grid.innerHTML=races.map(r=>`
            <div class="race-chip">
                <div class="race-bg" style="background:radial-gradient(circle,${r.color},transparent);"></div>
                <span><strong>${r.name}</strong></span>
                <span class="race-piece">${r.piece}</span>
            </div>`).join('');
    },
    /* èŠå¤©è¡¨æƒ…æ¡ï¼šä¸ç”¨æ”¹ HTMLï¼Œè¿™é‡Œè‡ªåŠ¨æ’å…¥ */
    initEmojiBar(){
        const wrapper=document.querySelector('.chat-input');
        if(!wrapper) return;
        const bar=document.createElement('div');
        bar.className='chat-emoji-bar';
        const emojis=['(â‰§â–½â‰¦)','(à¹‘â€¢Ì€ã…‚â€¢Ì)Ùˆâœ§','orz','ğŸ˜‚','â¤ï¸'];
        emojis.forEach(e=>{
            const span=document.createElement('span');
            span.textContent=e;
            span.onclick=()=>social.insertEmoji(e);
            bar.appendChild(span);
        });
        wrapper.insertBefore(bar, wrapper.querySelector('.btn'));
    }
};

/* ================== å¯åŠ¨ ================== */

document.addEventListener('DOMContentLoaded',async ()=>{
    visuals.init();

    const stored=sessionStorage.getItem('ngnlUser');
    if(stored){
        try{
            const obj=JSON.parse(stored);
            state.user={...state.user,...obj};
            state.isLoggedIn=true;
            ui.elements.authOverlay.classList.remove('active');
            ui.elements.body.classList.remove('auth-active');
            ui.updateHUD();
            ui.updateProfileView();
            // ç”¨åç«¯æ•°æ®åˆ·æ–°ä¸€æ¬¡ï¼ˆæ‹¿åˆ°æœ€æ–°çš„ race / title / frame ç­‰ï¼‰
            const res=await apiRequest({action:'get_profile'});
            if(res.status==='success') applyProfileFromServer(res.profile);
        }catch(e){
            console.error(e);
            sessionStorage.removeItem('ngnlUser');
            ui.elements.body.classList.add('auth-active');
            ui.elements.authOverlay.classList.add('active');
        }
    }else{
        ui.elements.body.classList.add('auth-active');
        ui.elements.authOverlay.classList.add('active');
    }
});
</script>
</body>
</html>