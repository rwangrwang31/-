<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NO GAME NO LIFE - SYSTEM</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Noto+Sans+SC:wght@300;400;500;700&family=ZCOOL+XiaoWei&display=swap" rel="stylesheet">
    <style>
        /* ================= 全局样式 ================= */
        :root {
            --primary-pink: #ff2a6d; --primary-cyan: #05d9e8; --primary-purple: #d905e8; --primary-gold: #ffd700;
            --dark-bg: #09000f; --glass-bg: rgba(20, 20, 35, 0.9);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; cursor: default; outline: none; }
        body { background-color: var(--dark-bg); color: white; font-family: 'Noto Sans SC', sans-serif; height: 100vh; overflow: hidden; }
        body.unlocked { overflow-y: auto; }

        /* ================= 登录层 (Z-Index 最高) ================= */
        #auth-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 10000;
            background: rgba(5, 2, 10, 0.95); backdrop-filter: blur(15px);
            display: flex; justify-content: center; align-items: center;
        }
        .auth-box {
            width: 400px; padding: 40px; background: rgba(0,0,0,0.8); 
            border: 2px solid var(--primary-pink); box-shadow: 0 0 50px rgba(255,42,109,0.3);
            text-align: center; position: relative;
        }
        .auth-title { font-family: 'Orbitron'; font-size: 2rem; margin-bottom: 20px; color: white; text-shadow: 0 0 10px var(--primary-cyan); }
        .auth-input {
            width: 100%; padding: 12px; margin-bottom: 15px; background: rgba(255,255,255,0.1);
            border: 1px solid #555; color: white; text-align: center; font-family: 'Orbitron'; font-size: 1rem;
        }
        .auth-btn {
            width: 100%; padding: 12px; background: transparent; border: 2px solid var(--primary-pink);
            color: var(--primary-pink); font-family: 'Orbitron'; font-weight: bold; cursor: pointer; transition: 0.3s;
        }
        .auth-btn:hover { background: var(--primary-pink); color: white; box-shadow: 0 0 20px var(--primary-pink); }
        .auth-link { margin-top: 15px; font-size: 0.8rem; color: #aaa; text-decoration: underline; cursor: pointer; }
        .auth-error { color: #ff2a6d; margin-top: 10px; min-height: 20px; font-size: 0.9rem; }
        
        .hidden { display: none !important; }

        /* ================= 主界面 (初始模糊) ================= */
        #main-app { filter: blur(10px); opacity: 0.5; pointer-events: none; transition: 0.8s; width: 100%; min-height: 100vh; position: relative; z-index: 1; }
        body.unlocked #main-app { filter: blur(0); opacity: 1; pointer-events: all; }
        
        /* 背景 */
        .bg-anim { position: fixed; inset: 0; z-index: -1; background: radial-gradient(circle at 50% 0%, #2a0e36 0%, #000 70%); }
        
        /* 导航 */
        nav {
            position: fixed; top: 0; width: 100%; height: 60px; padding: 0 5%; 
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(0,0,0,0.8); border-bottom: 1px solid #333; z-index: 100;
        }
        .brand { font-family: 'Orbitron'; font-weight: 900; color: var(--primary-cyan); }
        
        /* Hero */
        .hero { height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; }
        .hero h1 { font-family: 'Orbitron'; font-size: 4rem; margin-bottom: 20px; text-shadow: 0 0 20px var(--primary-pink); }
        
        /* Content Sections */
        section { padding: 80px 5%; max-width: 1200px; margin: 0 auto; }
        .card-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .card { background: rgba(255,255,255,0.05); padding: 20px; border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #ddd; }
        
        /* Novel Reader Overlay */
        #reader-overlay {
            position: fixed; inset: 0; background: #000; z-index: 5000; 
            display: flex; flex-direction: column; opacity: 0; pointer-events: none; transition: 0.3s;
        }
        #reader-overlay.active { opacity: 1; pointer-events: all; }
        .reader-head { padding: 15px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; }
        .reader-content { flex: 1; overflow-y: auto; padding: 40px; font-family: 'ZCOOL XiaoWei'; font-size: 1.2rem; line-height: 2; color: #ccc; text-align: justify; }
        .close-btn { border: 1px solid var(--primary-pink); color: var(--primary-pink); background: none; padding: 5px 15px; font-family: 'Orbitron'; cursor: pointer; }

        /* 移动端 */
        @media (max-width: 768px) {
            .hero h1 { font-size: 2.5rem; }
            .auth-box { width: 90%; padding: 20px; }
        }
    </style>
</head>
<body>

    <!-- 1. 认证层 -->
    <div id="auth-layer">
        <div class="auth-box">
            <div id="auth-title" class="auth-title">SYSTEM LOGIN</div>
            
            <!-- 登录视图 -->
            <div id="view-login">
                <input type="email" id="in-email" class="auth-input" placeholder="EMAIL">
                <input type="password" id="in-pass" class="auth-input" placeholder="PASSWORD">
                <button class="auth-btn" onclick="userLogin()">CONNECT</button>
                <div class="auth-link" onclick="switchView('reg1')">NEW PLAYER? REGISTER</div>
            </div>

            <!-- 注册视图 1 -->
            <div id="view-reg1" class="hidden">
                <input type="text" id="in-reg-user" class="auth-input" placeholder="USERNAME">
                <input type="email" id="in-reg-email" class="auth-input" placeholder="EMAIL">
                <input type="password" id="in-reg-pass" class="auth-input" placeholder="PASSWORD">
                <button class="auth-btn" onclick="userGetCode()">GET CODE</button>
                <div class="auth-link" onclick="switchView('login')">BACK</div>
            </div>

            <!-- 注册视图 2 -->
            <div id="view-reg2" class="hidden">
                <p style="color:#aaa; font-size:0.8rem; margin-bottom:10px;">Code sent (or try 123456)</p>
                <input type="text" id="in-reg-code" class="auth-input" placeholder="6-DIGIT CODE">
                <button class="auth-btn" onclick="userConfirmReg()">CONFIRM</button>
            </div>

            <div id="ui-msg" class="auth-error"></div>
        </div>
    </div>

    <!-- 2. 主内容层 -->
    <div id="main-app">
        <div class="bg-anim"></div>
        
        <nav>
            <span class="brand">NGNL SYSTEM</span>
            <span id="user-badge" style="color:var(--primary-gold); border:1px solid var(--primary-gold); padding:2px 6px; font-size:0.8rem;">GUEST</span>
        </nav>

        <header class="hero">
            <h1>NO GAME NO LIFE</h1>
            <button class="auth-btn" style="width:auto; padding:10px 40px;" onclick="openReader()">READ NOVEL</button>
        </header>

        <section>
            <h2 style="text-align:center; font-family:'Orbitron'; margin-bottom:40px; color:var(--primary-cyan);">THE PLEDGES</h2>
            <div class="card-grid">
                <div class="card">I. 禁止杀伤、战争与掠夺</div>
                <div class="card">II. 所有纠纷通过游戏解决</div>
                <div class="card">III. 赌注必须对等</div>
                <div class="card">IV. 只要不违反三，内容不限</div>
                <div class="card">V. 受挑战方决定游戏内容</div>
                <div class="card">VI. 向盟约宣誓必须遵守</div>
            </div>
        </section>
    </div>

    <!-- 3. 阅读器层 -->
    <div id="reader-overlay">
        <div class="reader-head">
            <span style="color:var(--primary-cyan); font-family:'Orbitron'">NOVEL DATABASE</span>
            <button class="close-btn" onclick="closeReader()">EXIT</button>
        </div>
        <div id="reader-text" class="reader-content">
            <div style="text-align:center; margin-top:50px;">
                <p>INITIALIZING...</p>
                <button class="auth-btn" style="width:auto; margin-top:20px;" onclick="document.getElementById('file-picker').click()">LOAD FILE</button>
            </div>
        </div>
    </div>
    <input type="file" id="file-picker" accept=".txt" style="display:none;" onchange="loadFile(this)">

    <script>
        // =============================================
        // ⚠️ 填入你的 URL
        const API_URL = "https://script.google.com/macros/s/AKfycbxJBrAx1_jzwNCO6kCSVyJsNANGE4ibdXy5SXva_p54B4Zot8OaJeCm3PdQsIVhdU4v/exec"; 
        // =============================================

        // --- 1. 核心通信 (Text Plain 模式) ---
        async function api(data) {
            console.log("SEND:", data);
            try {
                const res = await fetch(API_URL, {
                    method: 'POST',
                    redirect: 'follow',
                    headers: { "Content-Type": "text/plain;charset=utf-8" },
                    body: JSON.stringify(data)
                });
                const json = await res.json();
                console.log("RECV:", json);
                return json;
            } catch (e) {
                console.error(e);
                return {status: 'error', message: 'Network/CORS Error'};
            }
        }

        // --- 2. 认证逻辑 ---
        
        // 切换视图
        function switchView(viewName) {
            // 隐藏所有
            ['view-login', 'view-reg1', 'view-reg2'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
            document.getElementById('ui-msg').innerText = "";

            // 显示目标
            if (viewName === 'login') {
                document.getElementById('view-login').classList.remove('hidden');
                document.getElementById('auth-title').innerText = "SYSTEM LOGIN";
            } else if (viewName === 'reg1') {
                document.getElementById('view-reg1').classList.remove('hidden');
                document.getElementById('auth-title').innerText = "REGISTER";
            } else if (viewName === 'reg2') {
                document.getElementById('view-reg2').classList.remove('hidden');
            }
        }

        // 登录
        async function userLogin() {
            const email = document.getElementById('in-email').value;
            const pass = document.getElementById('in-pass').value;
            const msg = document.getElementById('ui-msg');
            
            if (!email || !pass) { msg.innerText = "Missing Input"; return; }
            msg.innerText = "Connecting...";

            const res = await api({action: 'login', email: email, password: pass});
            
            if (res.status === 'success') {
                unlock(res.username);
            } else {
                msg.innerText = res.message;
            }
        }

        // 获取验证码
        let tempReg = {};
        async function userGetCode() {
            const user = document.getElementById('in-reg-user').value;
            const email = document.getElementById('in-reg-email').value;
            const pass = document.getElementById('in-reg-pass').value;
            const msg = document.getElementById('ui-msg');

            if (!user || !email || !pass) { msg.innerText = "Fill all fields"; return; }
            msg.innerText = "Sending...";

            tempReg = {username: user, email: email, password: pass};
            
            const res = await api({action: 'req_code', email: email});
            
            if (res.status === 'success') {
                switchView('reg2');
                alert(res.message);
            } else {
                msg.innerText = res.message;
            }
        }

        // 确认注册
        async function userConfirmReg() {
            const code = document.getElementById('in-reg-code').value;
            const msg = document.getElementById('ui-msg');
            
            if (!code) { msg.innerText = "Enter Code"; return; }
            msg.innerText = "Verifying...";

            const res = await api({
                action: 'register',
                username: tempReg.username,
                email: tempReg.email,
                password: tempReg.password,
                code: code
            });

            if (res.status === 'success') {
                alert("Registered! Logging in...");
                unlock(tempReg.username);
            } else {
                msg.innerText = res.message;
            }
        }

        // 解锁界面
        function unlock(username) {
            document.getElementById('login-overlay').style.display = 'none';
            document.body.classList.add('unlocked');
            document.getElementById('user-badge').innerText = username.toUpperCase();
        }

        // --- 3. 阅读器简易逻辑 ---
        function openReader() {
            document.getElementById('reader-overlay').classList.add('active');
            // 尝试自动加载
            fetch('novel.txt').then(r => r.text()).then(txt => {
                if(txt.length < 50) throw new Error();
                renderText(txt);
            }).catch(() => console.log("Waiting for file"));
        }
        function closeReader() { document.getElementById('reader-overlay').classList.remove('active'); }
        
        function loadFile(input) {
            const f = input.files[0];
            const r = new FileReader();
            r.onload = e => renderText(e.target.result);
            r.readAsText(f);
        }
        
        function renderText(txt) {
            const div = document.getElementById('reader-text');
            // 分行处理防卡顿
            const lines = txt.split('\n').slice(0, 500); // 先只显示前500行演示
            div.innerHTML = lines.map(l => `<div style="margin-bottom:10px;">${l}</div>`).join('');
        }

    </script>
</body>
</html>