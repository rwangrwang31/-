<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NO GAME NO LIFE | SYSTEM ONLINE</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Noto+Sans+SC:wght@300;500;700&family=ZCOOL+XiaoWei&display=swap" rel="stylesheet">
    <style>
        /* ================= GLOBAL VARS ================= */
        :root {
            --pink: #ff2a6d; --cyan: #05d9e8; --purple: #bd00ff; --gold: #ffd700;
            --dark: #05010d; --glass: rgba(20,20,40,0.85); --border: rgba(255,255,255,0.15);
            --rank-god: #ffd700; --rank-high: #9b59b6; --rank-mid: #2ecc71; --rank-low: #e74c3c;
        }
        * { margin:0; padding:0; box-sizing:border-box; cursor:none; outline:none; user-select:none; }
        body { background:var(--dark); color:white; font-family:'Noto Sans SC'; height:100vh; overflow:hidden; }
        body.unlocked { overflow-y:auto; overflow-x:hidden; }

        /* ================= UI COMPONENTS ================= */
        /* Custom Cursor */
        #cursor { width:20px; height:20px; border:2px solid var(--cyan); border-radius:50%; position:fixed; pointer-events:none; z-index:999999; transform:translate(-50%,-50%); transition:0.15s; mix-blend-mode:difference; }
        #cursor.hover { width:50px; height:50px; background:rgba(255,42,109,0.2); border-color:var(--pink); }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width:6px; } ::-webkit-scrollbar-track { background:#000; } ::-webkit-scrollbar-thumb { background:linear-gradient(var(--cyan),var(--purple)); border-radius:3px; }

        /* Buttons */
        .btn { background:rgba(5,217,232,0.05); border:1px solid var(--cyan); color:var(--cyan); padding:10px 25px; font-family:'Orbitron'; font-weight:bold; transition:0.3s; text-transform:uppercase; position:relative; overflow:hidden; }
        .btn:hover { background:var(--cyan); color:#000; box-shadow:0 0 20px var(--cyan); }
        .btn-pink { border-color:var(--pink); color:var(--pink); } .btn-pink:hover { background:var(--pink); color:white; box-shadow:0 0 25px var(--pink); }
        .btn:disabled { border-color:#555; color:#555; cursor:not-allowed; box-shadow:none; }

        .input-box { width:100%; padding:12px; background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.2); color:white; font-family:'Orbitron'; text-align:center; transition:0.3s; margin-bottom:10px; }
        .input-box:focus { border-color:var(--pink); box-shadow:0 0 10px rgba(255,42,109,0.3); }

        /* Common Classes */
        .hidden { display:none !important; }
        .fade-in { animation:fadeIn 0.5s ease forwards; }
        @keyframes fadeIn { from{opacity:0;transform:translateY(20px)} to{opacity:1;transform:translateY(0)} }

        /* ================= LAYOUT LAYERS ================= */
        #bg-layer { position:fixed; inset:0; z-index:-10; background:radial-gradient(circle at 50% 0%, rgba(189,0,255,0.1), transparent 70%), url("data:image/svg+xml,%3Csvg width='40' height='40' viewBox='0 0 40 40' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M0 0h40v40H0z' fill='none'/%3E%3Cpath d='M0 38h40v2H0z' fill='%2305d9e8' fill-opacity='0.03'/%3E%3Cpath d='M0 0h2v40H0z' fill='%2305d9e8' fill-opacity='0.03'/%3E%3C/svg%3E"); }
        #site-wrapper { position:relative; z-index:1; width:100%; transition:1s; filter:blur(15px); opacity:0.4; pointer-events:none; }
        body.unlocked #site-wrapper { filter:blur(0); opacity:1; pointer-events:all; }

        /* ================= MODULES ================= */
        
        /* 1. Login Overlay */
        #auth-overlay { position:fixed; inset:0; z-index:20000; background:rgba(5,1,10,0.95); backdrop-filter:blur(15px); display:flex; justify-content:center; align-items:center; }
        .auth-box { width:420px; padding:40px; border:2px solid var(--pink); box-shadow:0 0 60px rgba(255,42,109,0.2); text-align:center; background:rgba(0,0,0,0.8); position:relative; }
        .auth-title { font-family:'Orbitron'; font-size:2rem; margin-bottom:30px; text-shadow:0 0 10px var(--cyan); }
        
        /* 2. Navigation */
        nav { position:fixed; top:0; width:100%; height:70px; z-index:1000; display:flex; justify-content:space-between; align-items:center; padding:0 40px; background:rgba(5,1,10,0.9); border-bottom:1px solid var(--border); }
        .brand { font-family:'Orbitron'; font-weight:900; font-size:1.5rem; color:var(--pink); }
        .nav-item { margin-left:30px; font-family:'Orbitron'; color:#aaa; transition:0.3s; cursor:none; }
        .nav-item:hover { color:var(--cyan); text-shadow:0 0 8px var(--cyan); }

        /* 3. Sections */
        section { padding:100px 5%; max-width:1400px; margin:0 auto; }
        .sec-title { font-family:'Orbitron'; font-size:3rem; text-align:center; margin-bottom:60px; text-shadow:0 0 20px var(--cyan); }
        
        /* Hero */
        .hero { height:100vh; display:flex; flex-direction:column; justify-content:center; align-items:center; text-align:center; }
        .hero h1 { font-family:'Orbitron'; font-size:5rem; margin-bottom:20px; background:linear-gradient(to bottom,#fff,#ccc); -webkit-background-clip:text; -webkit-text-fill-color:transparent; filter:drop-shadow(0 0 15px var(--pink)); animation:glitch 3s infinite alternate; }
        @keyframes glitch { 0%{text-shadow:2px 0 var(--pink)} 100%{text-shadow:-2px 0 var(--cyan)} }

        /* Pledges */
        .pledge-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(300px,1fr)); gap:25px; }
        .pledge-card { background:var(--glass); border:1px solid var(--border); padding:30px; border-radius:12px; position:relative; overflow:hidden; transition:0.3s; }
        .pledge-card:hover { transform:translateY(-5px); border-color:var(--pink); box-shadow:0 0 20px rgba(255,42,109,0.2); }
        .pledge-num { position:absolute; right:15px; font-family:'Orbitron'; font-size:4rem; opacity:0.1; font-weight:900; color:var(--pink); }

        /* World Chess */
        .exceed-board { display:grid; grid-template-columns:repeat(auto-fill,minmax(220px,1fr)); gap:20px; }
        .piece-card { height:220px; background:rgba(255,255,255,0.03); border:1px solid var(--border); border-radius:8px; padding:20px; position:relative; overflow:hidden; transition:0.4s; display:flex; flex-direction:column; justify-content:space-between; }
        .piece-card:hover { background:rgba(255,255,255,0.08); transform:scale(1.05); z-index:10; box-shadow:0 10px 30px #000; }
        .piece-icon { position:absolute; bottom:-20px; right:-20px; font-size:8rem; opacity:0.05; transition:0.5s; }
        .piece-card:hover .piece-icon { opacity:0.2; transform:rotate(-10deg) scale(1.1); }
        .rank-god { border-color:var(--gold); box-shadow:inset 0 0 20px rgba(255,215,0,0.1); } 
        .rank-imanity:hover { border-color:white; animation:rainbow 2s infinite; }
        @keyframes rainbow { 0%{box-shadow:0 0 10px var(--pink);} 50%{box-shadow:0 0 10px var(--cyan);} 100%{box-shadow:0 0 10px var(--purple);} }

        /* Characters */
        .char-grid { display:flex; justify-content:center; gap:30px; flex-wrap:wrap; }
        .char-card { width:260px; height:380px; perspective:1000px; }
        .char-inner { width:100%; height:100%; transition:0.6s; transform-style:preserve-3d; position:relative; }
        .char-card:hover .char-inner { transform:rotateY(180deg); }
        .char-front, .char-back { position:absolute; width:100%; height:100%; backface-visibility:hidden; border-radius:15px; display:flex; flex-direction:column; align-items:center; justify-content:center; background:linear-gradient(145deg, #1a1025, #050505); border:1px solid var(--border); box-shadow:0 10px 30px rgba(0,0,0,0.5); }
        .char-back { transform:rotateY(180deg); background:linear-gradient(135deg, var(--pink), #2a0e36); padding:20px; text-align:center; }
        .char-av { width:130px; height:130px; border-radius:50%; border:3px solid white; margin-bottom:20px; background-size:cover; }

        /* ================= 5. Ë¶ÜÁõñÂ±Ç (Profile & Friend & Reader) ================= */
        .overlay-full { position:fixed; inset:0; background:var(--hud-bg); z-index:5000; display:flex; flex-direction:column; opacity:0; pointer-events:none; transition:0.3s; }
        .overlay-full.active { opacity:1; pointer-events:all; }
        .ov-head { height:60px; padding:0 30px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; background:rgba(0,0,0,0.8); }
        .ov-body { flex:1; display:flex; overflow:hidden; }

        /* Profile Style */
        .profile-container { padding:40px; width:100%; max-width:1000px; margin:0 auto; display:flex; gap:40px; }
        .p-card { background:rgba(255,255,255,0.05); padding:30px; border-radius:10px; border:1px solid var(--cyan); width:300px; text-align:center; }
        .p-av { width:150px; height:150px; border-radius:50%; border:4px solid var(--pink); margin:0 auto 20px; background-size:cover; background-color:#333; }
        .p-stats { text-align:left; margin-top:20px; color:#aaa; font-size:0.9rem; }
        .p-main { flex:1; }
        .p-bio { background:rgba(0,0,0,0.5); padding:20px; border-radius:8px; border:1px solid var(--border); min-height:100px; margin-bottom:20px; }

        /* Friend/Chat Style */
        .chat-list { width:250px; background:rgba(0,0,0,0.3); border-right:1px solid var(--border); display:flex; flex-direction:column; }
        .friend-item { padding:15px; border-bottom:1px solid var(--border); cursor:none; transition:0.2s; display:flex; align-items:center; gap:10px; }
        .friend-item:hover { background:rgba(5,217,232,0.1); }
        .chat-area { flex:1; display:flex; flex-direction:column; background:rgba(0,0,0,0.5); }
        .chat-msgs { flex:1; overflow-y:auto; padding:20px; display:flex; flex-direction:column; gap:10px; }
        .msg { max-width:70%; padding:10px 15px; border-radius:10px; background:#222; align-self:flex-start; font-size:0.9rem; }
        .msg.me { background:var(--pink); align-self:flex-end; color:black; }

        /* Reader Style */
        .reader-text { flex:1; overflow-y:auto; padding:50px 100px; font-family:'ZCOOL XiaoWei'; font-size:1.35rem; line-height:2.1; color:#ddd; }
        .story-line { position:relative; padding:2px 0; } .story-line:hover { background:rgba(255,255,255,0.05); }
        .bubble { position:absolute; right:-40px; top:50%; transform:translateY(-50%); color:var(--purple); opacity:0; transition:0.2s; pointer-events:auto; z-index:100; }
        .story-line:hover .bubble { opacity:1; right:10px; }
        .side-r { width:0; background:rgba(10,5,20,0.98); border-left:1px solid var(--border); transition:0.3s; display:flex; flex-direction:column; z-index:50; }
        .side-r.open { width:350px; }
        
        @media(max-width:768px) { .nav-links, .side-l { display:none; } .profile-container { flex-direction:column; } .side-r.open { position:absolute; right:0; width:100%; height:100%; } }
    </style>
</head>
<body>

    <div id="cursor"></div>

    <!-- AUTH OVERLAY -->
    <div id="auth-overlay">
        <div class="auth-box">
            <h2 id="auth-title" class="auth-title">SYSTEM LOGIN</h2>
            <!-- Login -->
            <div id="p-login">
                <input id="i-email" class="input-box" placeholder="EMAIL">
                <input id="i-pass" type="password" class="input-box" placeholder="PASSWORD">
                <button class="btn" style="width:100%" onclick="apiLogin()">CONNECT</button>
                <div style="margin-top:15px; font-size:0.8rem; display:flex; justify-content:space-between;">
                    <span class="nav-item" onclick="toggleView('reg1')">Register</span>
                </div>
            </div>
            <!-- Reg -->
            <div id="p-reg1" class="hidden">
                <input id="r-user" class="input-box" placeholder="USERNAME">
                <input id="r-email" class="input-box" placeholder="EMAIL">
                <input id="r-pass" type="password" class="input-box" placeholder="PASSWORD">
                <button class="btn" style="width:100%" onclick="apiCode()">GET CODE</button>
                <div class="nav-item" onclick="toggleView('login')" style="text-align:center; margin-top:10px;">BACK</div>
            </div>
            <div id="p-reg2" class="hidden">
                <input id="r-code" class="input-box" placeholder="CODE">
                <button class="btn" style="width:100%" onclick="apiReg()">CONFIRM</button>
            </div>
            <div id="auth-msg" style="color:var(--pink); margin-top:10px;"></div>
        </div>
    </div>

    <!-- MAIN SITE -->
    <div id="site-wrapper">
        <div id="bg-layer"></div>
        <nav>
            <div class="brand">NGNL</div>
            <div class="nav-links">
                <span class="nav-item" onclick="location.href='#hero'">HOME</span>
                <span class="nav-item" onclick="openProfile()">PROFILE</span>
                <span class="nav-item" onclick="openFriends()">FRIENDS</span>
                <span id="u-display" style="color:var(--gold); border:1px solid var(--gold); padding:2px 8px; margin-left:20px;">GUEST</span>
            </div>
        </nav>

        <header id="hero" class="hero anim-entry">
            <h1>NO GAME NO LIFE</h1>
            <p style="color:#ccc; margin-bottom:40px;">The world is just a game.</p>
            <button class="btn-pink" onclick="openReader()">READ NOVEL</button>
        </header>

        <section id="pledges" class="pledges anim-entry">
            <h2 class="sec-title">THE PLEDGES</h2>
            <div class="pledge-grid">
                <!-- Repeat for 10 pledges -->
                <div class="pledge-card"><div class="pledge-num">I</div><div class="pledge-text">Á¶ÅÊ≠¢ÊùÄ‰º§„ÄÅÊàò‰∫â‰∏éÊé†Â§∫</div></div>
                <div class="pledge-card"><div class="pledge-num">II</div><div class="pledge-text">ÊâÄÊúâÁ∫†Á∫∑ÈÄöËøáÊ∏∏ÊàèËß£ÂÜ≥</div></div>
                <div class="pledge-card"><div class="pledge-num">III</div><div class="pledge-text">ËµåÊ≥®ÂøÖÈ°ªÂØπÁ≠â</div></div>
                <div class="pledge-card"><div class="pledge-num">VI</div><div class="pledge-text">ÂêëÁõüÁ∫¶ÂÆ£Ë™ìÂøÖÈ°ªÈÅµÂÆà</div></div>
                <div class="pledge-card"><div class="pledge-num">IX</div><div class="pledge-text">ËßÑÂàôÁªùÂØπ‰∏çÂèò</div></div>
                <div class="pledge-card"><div class="pledge-num">X</div><div class="pledge-text">Â§ßÂÆ∂‰∏ÄËµ∑ÂíåÂπ≥Âú∞Áé©Âêß</div></div>
            </div>
        </section>

        <section id="world" class="anim-entry">
            <h2 class="sec-title">IXSEED (16 RACES)</h2>
            <div class="exceed-grid">
                <div class="piece-card rank-god"><div class="piece-rank">I</div><div class="piece-icon">‚ôî</div><div class="piece-name">Old Deus</div><div class="piece-desc">Á•ûÁÅµÁßç / King</div></div>
                <div class="piece-card"><div class="piece-rank">VI</div><div class="piece-icon">‚ôó</div><div class="piece-name">Fl√ºgel</div><div class="piece-desc">Â§©ÁøºÁßç / Bishop</div></div>
                <div class="piece-card rank-imanity"><div class="piece-rank">XVI</div><div class="piece-icon">‚ôô</div><div class="piece-name">Imanity</div><div class="piece-desc">‰∫∫Á±ªÁßç / Pawn</div></div>
            </div>
        </section>

        <section id="characters" class="anim-entry">
            <h2 class="sec-title">PLAYERS</h2>
            <div class="char-gallery">
                <div class="char-card"><div class="char-inner"><div class="char-front"><div class="char-av" style="background-image:url('sora.png')"></div><div class="char-name">SORA</div></div><div class="char-back"><h3>Á©∫</h3><p>Imanity / Pawn</p></div></div></div>
                <div class="char-card"><div class="char-inner"><div class="char-front"><div class="char-av" style="background-image:url('shiro.png')"></div><div class="char-name">SHIRO</div></div><div class="char-back"><h3>ÁôΩ</h3><p>Imanity / Pawn</p></div></div></div>
                <div class="char-card"><div class="char-inner"><div class="char-front"><div class="char-av" style="background-image:url('jibril.png')"></div><div class="char-name">JIBRIL</div></div><div class="char-back"><h3>ÂêâÊôÆËéâÂ∞î</h3><p>Fl√ºgel / Bishop</p></div></div></div>
            </div>
        </section>
    </div>

    <!-- OVERLAY: PROFILE -->
    <div id="profile-overlay" class="overlay-full">
        <div class="ov-head"><span style="color:var(--gold)">PLAYER PROFILE</span><button class="btn" onclick="closeOverlay('profile')">CLOSE</button></div>
        <div class="ov-body" style="overflow-y:auto;">
            <div class="profile-container">
                <div class="p-card">
                    <div id="p-avatar" class="p-av"></div>
                    <h2 id="p-username" style="color:var(--cyan)">User</h2>
                    <div class="p-stats">
                        <p>Rank: <span id="p-rank">16</span></p>
                        <p>Exp: <span id="p-exp">0</span></p>
                        <p>Coins: <span id="p-coins" style="color:var(--gold)">0</span></p>
                        <p>UID: <span id="p-uid">---</span></p>
                    </div>
                </div>
                <div class="p-main">
                    <h3>BIO</h3>
                    <div id="p-bio" class="p-bio"></div>
                    <button class="btn" onclick="editProfile()">EDIT PROFILE</button>
                </div>
            </div>
        </div>
    </div>

    <!-- OVERLAY: FRIENDS & CHAT -->
    <div id="chat-overlay" class="overlay-full">
        <div class="ov-head"><span style="color:var(--pink)">FRIEND LINK</span><button class="btn" onclick="closeOverlay('chat')">CLOSE</button></div>
        <div class="ov-body">
            <div class="chat-list">
                <div style="padding:15px; border-bottom:1px solid #333;">
                    <input id="add-friend-inp" class="input-box" placeholder="Add Username" style="font-size:0.8rem; margin:0;">
                    <button class="btn" style="width:100%; margin-top:5px; font-size:0.7rem;" onclick="addFriend()">ADD</button>
                </div>
                <div id="friend-list-container"></div>
            </div>
            <div class="chat-area">
                <div id="chat-box" class="chat-msgs"></div>
                <div style="padding:15px; background:#111; display:flex; gap:10px;">
                    <input id="msg-inp" class="input-box" style="margin:0; text-align:left;" placeholder="Message...">
                    <button class="btn" onclick="sendMsg()">SEND</button>
                </div>
            </div>
        </div>
    </div>

    <!-- OVERLAY: READER -->
    <div id="reader-overlay" class="overlay-full">
        <div class="ov-head"><span style="color:var(--cyan)">DATABASE</span><button class="btn" onclick="closeReader()">EXIT</button></div>
        <div class="ov-body">
            <div class="sidebar-left" style="width:250px; background:rgba(0,0,0,0.5); border-right:1px solid var(--border);">
                <div style="padding:10px; text-align:center; border-bottom:1px solid #333;">INDEX</div>
                <div id="toc-list" style="flex:1; overflow-y:auto;"></div>
            </div>
            <div class="text-area-container" style="flex:1; display:flex; flex-direction:column;">
                <div id="reader-content" class="reader-text"></div>
                <div style="padding:10px; background:#111; display:flex; justify-content:center; gap:20px;">
                    <button class="btn" onclick="turnPage(-1)">PREV</button>
                    <button class="btn" onclick="turnPage(1)">NEXT</button>
                </div>
            </div>
            <div id="side-r" class="side-r">
                <div style="padding:10px; display:flex; justify-content:space-between;"><span style="color:var(--pink)">COMMENTS</span><span onclick="toggleR()" style="cursor:pointer">X</span></div>
                <div id="cmt-list" style="flex:1; overflow:auto; padding:10px;"></div>
                <div style="padding:10px;"><input id="c-inp" class="input-box" placeholder="Comment..."><button class="btn" style="width:100%" onclick="postCmt()">POST</button></div>
            </div>
        </div>
    </div>
    <input type="file" id="file" accept=".txt" style="display:none" onchange="loadFile(this)">

    <script>
        // ==========================================
        // ‚ö†Ô∏è ‰Ω†ÁöÑ Google Script URL
        const API = "https://script.google.com/macros/s/AKfycbxJBrAx1_jzwNCO6kCSVyJsNANGE4ibdXy5SXva_p54B4Zot8OaJeCm3PdQsIVhdU4v/exec"; 
        // ==========================================

        let user = {};
        let lines=[], curLine=0, curCmtLine=-1, activeFriend="";

        // --- API ---
        async function req(d) {
            try { return await (await fetch(API, { method:'POST', redirect:'follow', headers:{'Content-Type':'text/plain;charset=utf-8'}, body:JSON.stringify(d) })).json(); }
            catch(e) { console.error(e); return {status:'error', message:'Net Error'}; }
        }

        // --- Auth ---
        function toggleView(v) {
            ['p-login','p-reg1','p-reg2'].forEach(id=>document.getElementById(id).classList.add('hidden'));
            document.getElementById('p-'+v).classList.remove('hidden');
        }
        async function apiLogin() {
            const e=document.getElementById('i-email').value, p=document.getElementById('i-pass').value;
            const r = await req({action:'login', email:e, password:p});
            if(r.status==='success') {
                user = r.data;
                document.getElementById('auth-overlay').style.display='none';
                document.body.classList.add('unlocked');
                document.getElementById('u-display').innerText = user.username.toUpperCase();
            } else alert(r.message);
        }
        let tmpR={};
        async function apiCode() {
            const u=document.getElementById('r-user').value, e=document.getElementById('r-email').value, p=document.getElementById('r-pass').value;
            const r = await req({action:'req_code', email:e});
            if(r.status==='success') { tmpR={u,e,p}; toggleView('reg2'); alert(r.message); } else alert(r.message);
        }
        async function apiReg() {
            const c=document.getElementById('r-code').value;
            const r = await req({action:'register', username:tmpR.u, email:tmpR.e, password:tmpR.p, code:c});
            if(r.status==='success') { alert("Success"); toggleView('login'); } else alert(r.message);
        }

        // --- Profile ---
        function openProfile() {
            document.getElementById('profile-overlay').classList.add('active');
            document.getElementById('p-username').innerText = user.username;
            document.getElementById('p-rank').innerText = user.rank;
            document.getElementById('p-exp').innerText = user.exp;
            document.getElementById('p-coins').innerText = user.coins;
            document.getElementById('p-uid').innerText = user.uid;
            document.getElementById('p-bio').innerText = user.bio;
            document.getElementById('p-avatar').style.backgroundImage = user.avatar ? `url(${user.avatar})` : `url(sora.png)`;
        }
        async function editProfile() {
            const b = prompt("New Bio:", user.bio);
            if(b!==null) {
                await req({action:'update_profile', username:user.username, bio:b});
                user.bio = b; openProfile();
            }
        }

        // --- Friends & Chat ---
        function openFriends() {
            document.getElementById('chat-overlay').classList.add('active');
            loadFriends();
        }
        async function loadFriends() {
            const r = await req({action:'get_friends', username:user.username});
            const div = document.getElementById('friend-list-container');
            div.innerHTML = r.data.map(f => `<div class="friend-item" onclick="openChat('${f}')">${f}</div>`).join('');
        }
        async function addFriend() {
            const t = document.getElementById('add-friend-inp').value;
            if(t) { await req({action:'add_friend', username:user.username, target_user:t}); loadFriends(); }
        }
        async function openChat(f) {
            activeFriend = f;
            const r = await req({action:'get_msgs', username:user.username, target_user:f});
            const box = document.getElementById('chat-box');
            box.innerHTML = r.data.map(m => `<div class="msg ${m.sender===user.username?'me':''}">${m.content}</div>`).join('');
        }
        async function sendMsg() {
            const t = document.getElementById('msg-inp').value;
            if(t && activeFriend) {
                await req({action:'send_msg', username:user.username, target_user:activeFriend, content:t});
                document.getElementById('msg-inp').value=""; openChat(activeFriend);
            }
        }

        // --- Reader ---
        function openReader() { document.getElementById('reader-overlay').classList.add('active'); if(lines.length===0) document.getElementById('file').click(); }
        function closeReader() { document.getElementById('reader-overlay').classList.remove('active'); }
        function loadFile(i) {
            const r = new FileReader();
            r.onload=e=>{ lines=e.target.result.split('\n'); renderPage(0); genToc(); };
            r.readAsText(i.files[0]);
        }
        function genToc() {
            const d = document.getElementById('toc-list'); d.innerHTML="";
            lines.forEach((l,i)=>{ if(l.match(/Á¨¨.+Á´†/)) d.innerHTML+=`<div style="padding:10px;border-bottom:1px solid #333;cursor:pointer" onclick="renderPage(${i})">${l}</div>` });
        }
        function renderPage(idx) {
            curLine = idx;
            const chunk = lines.slice(idx, idx+100);
            document.getElementById('reader-content').innerHTML = chunk.map((l,i)=>`<div class="story-line">${l}<div class="bubble" onclick="openComm(${idx+i})">üí¨</div></div>`).join('');
        }
        function turnPage(d) { renderPage(curLine + d*100); }

        // --- Comments ---
        function toggleR() { document.getElementById('side-r').classList.toggle('open'); }
        async function openComm(i) {
            curCmtLine=i; document.getElementById('side-r').classList.add('open');
            const r = await req({action:'get_line_comments', line_index:i});
            document.getElementById('cmt-list').innerHTML = r.data.map(c=>`<div style="margin-bottom:10px;border-bottom:1px solid #333"><span style="color:var(--cyan)">${c.user}</span>: ${c.content}</div>`).join('');
        }
        async function postCmt() {
            const t=document.getElementById('c-inp').value;
            if(t) { await req({action:'post_line_comment', line_index:curCmtLine, username:user.username, content:t}); openComm(curCmtLine); }
        }

        function closeOverlay(id) { document.getElementById(id+'-overlay').classList.remove('active'); }

        // Cursor
        const cur = document.getElementById('cursor');
        document.addEventListener('mousemove', e=>{cur.style.left=e.clientX+'px'; cur.style.top=e.clientY+'px'});
        document.addEventListener('mouseover', e=>{if(e.target.closest('.hover, .btn')) cur.classList.add('hover'); else cur.classList.remove('hover')});
    </script>
</body>
</html>