<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NO GAME NO LIFE - æ¸¸æˆäººç”Ÿ | SYSTEM LOGIN</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Noto+Sans+SC:wght@300;400;500;700&family=ZCOOL+XiaoWei&display=swap" rel="stylesheet">
    <style>
        /* ================= 1. æ ¸å¿ƒå˜é‡ ================= */
        :root {
            --primary-pink: #ff2a6d;
            --primary-cyan: #05d9e8;
            --primary-purple: #d905e8;
            --primary-gold: #ffd700;
            --dark-bg: #09000f;
            --glass-bg: rgba(15, 15, 30, 0.85);
            --glass-border: rgba(255, 255, 255, 0.1);
            --hud-bg: rgba(5, 2, 8, 0.98);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; cursor: none; outline: none; }
        
        body {
            background-color: var(--dark-bg);
            color: white;
            font-family: 'Noto Sans SC', sans-serif;
            min-height: 100vh;
            overflow-x: hidden;
            overflow-y: hidden; /* ç™»å½•å‰ç¦æ­¢æ»šåŠ¨ */
        }
        
        body.unlocked { overflow-y: auto; }

        /* ================= 2. è§†è§‰ç»„ä»¶ ================= */
        /* å…‰æ ‡ */
        #cursor {
            width: 20px; height: 20px; border: 2px solid var(--primary-cyan); border-radius: 50%;
            position: fixed; pointer-events: none; z-index: 999999; transform: translate(-50%, -50%);
            transition: width 0.2s, height 0.2s, border-color 0.2s; mix-blend-mode: difference;
        }
        #cursor.hovered { width: 50px; height: 50px; background: rgba(255, 42, 109, 0.3); border-color: var(--primary-pink); }

        /* æ»šåŠ¨æ¡ */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #050505; }
        ::-webkit-scrollbar-thumb { background: linear-gradient(var(--primary-cyan), var(--primary-purple)); border-radius: 3px; }

        /* é€šç”¨æŒ‰é’® */
        .btn-glow {
            background: rgba(5, 217, 232, 0.05); border: 1px solid var(--primary-cyan); color: var(--primary-cyan);
            padding: 10px 30px; font-family: 'Orbitron'; text-transform: uppercase; letter-spacing: 1px;
            cursor: none; transition: 0.3s; position: relative; overflow: hidden;
        }
        .btn-glow:hover { background: var(--primary-cyan); color: #000; box-shadow: 0 0 25px var(--primary-cyan); }
        
        .btn-pink { border-color: var(--primary-pink); color: var(--primary-pink); }
        .btn-pink:hover { background: var(--primary-pink); color: white; box-shadow: 0 0 25px var(--primary-pink); }

        /* ================= 3. å¸ƒå±€å±‚çº§ ================= */
        /* èƒŒæ™¯ */
        .bg-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -10;
            background-image: 
                radial-gradient(circle at 50% 0%, rgba(255, 42, 109, 0.1) 0%, transparent 50%),
                linear-gradient(rgba(255, 255, 255, 0.02) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.02) 1px, transparent 1px);
            background-size: 100% 100%, 40px 40px, 40px 40px;
        }
        #bg-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -5; opacity: 0.6; }

        /* å†…å®¹å®¹å™¨ (ç™»å½•æ—¶æ¨¡ç³Š) */
        #site-wrapper {
            position: relative; z-index: 1; width: 100%;
            transition: filter 0.8s ease, opacity 0.8s ease;
            filter: blur(15px); opacity: 0.3; pointer-events: none;
        }
        body.unlocked #site-wrapper { filter: blur(0); opacity: 1; pointer-events: all; }

        /* ç™»å½•é®ç½© */
        #login-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 20000;
            display: flex; justify-content: center; align-items: center;
            background: rgba(5, 2, 10, 0.9); backdrop-filter: blur(10px);
        }

        /* ================= 4. é¡µé¢æ¿å— ================= */
        nav {
            position: fixed; top: 0; width: 100%; height: 70px; padding: 0 5%;
            display: flex; justify-content: space-between; align-items: center;
            z-index: 1000; background: rgba(10, 5, 20, 0.9); border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .nav-brand { font-family: 'Orbitron'; font-weight: 900; font-size: 1.5rem; color: white; letter-spacing: 2px; }
        .nav-links a { margin-left: 30px; color: #aaa; text-decoration: none; font-family: 'Orbitron'; font-size: 0.9rem; transition: 0.3s; }
        .nav-links a:hover { color: var(--primary-cyan); text-shadow: 0 0 10px var(--primary-cyan); }

        section { padding: 100px 5%; max-width: 1400px; margin: 0 auto; }
        .section-title {
            font-family: 'Orbitron'; font-size: 3rem; text-align: center; margin-bottom: 60px;
            color: white; text-shadow: 0 0 20px var(--primary-cyan); letter-spacing: 5px;
        }

        /* Hero */
        .hero { height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; }
        .hero h1 { 
            font-family: 'Orbitron'; font-size: 5rem; margin-bottom: 20px; line-height: 1;
            background: linear-gradient(to bottom, #fff, #ccc); -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            filter: drop-shadow(0 0 15px var(--primary-pink));
        }
        .glitch { animation: glitch-anim 3s infinite alternate-reverse; }
        @keyframes glitch-anim { 0% { transform: skew(0deg); } 20% { transform: skew(-2deg); } 40% { transform: skew(2deg); } 100% { transform: skew(0deg); } }

        /* Pledges Grid */
        .pledge-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 30px; }
        .pledge-card {
            background: var(--glass-bg); border: 1px solid var(--glass-border); padding: 30px; border-radius: 12px;
            position: relative; overflow: hidden; transition: 0.4s; display: flex; align-items: center; min-height: 120px;
        }
        .pledge-card:hover { transform: translateY(-5px); border-color: var(--primary-pink); box-shadow: 0 10px 30px rgba(255,42,109,0.15); }
        .pledge-num { position: absolute; right: 20px; font-family: 'Orbitron'; font-size: 4rem; opacity: 0.1; font-weight: 900; }
        .pledge-text { position: relative; z-index: 1; font-size: 1.1rem; line-height: 1.6; }

        /* World Database (Tab & Content) */
        .world-container { background: rgba(0,0,0,0.5); border: 1px solid var(--glass-border); border-radius: 12px; overflow: hidden; }
        .world-tabs { display: flex; border-bottom: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.02); }
        .world-tab { flex: 1; padding: 20px; text-align: center; font-family: 'Orbitron'; color: #888; transition: 0.3s; border-right: 1px solid rgba(255,255,255,0.05); }
        .world-tab.active { color: white; background: rgba(5,217,232,0.1); text-shadow: 0 0 15px var(--primary-cyan); border-bottom: 2px solid var(--primary-cyan); }
        .world-content { padding: 40px; min-height: 300px; color: #ddd; font-size: 1.1rem; line-height: 1.8; }

        /* 16 Races Grid (Fixed) */
        .exceed-board {
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); /* å®Œç¾è‡ªé€‚åº” */
            gap: 20px; margin-top: 30px;
        }
        .piece-card {
            height: 200px; background: rgba(255,255,255,0.03); border: 1px solid var(--glass-border);
            border-radius: 8px; padding: 20px; position: relative; overflow: hidden; transition: 0.4s;
            display: flex; flex-direction: column; justify-content: space-between;
        }
        .piece-card:hover { background: rgba(255,255,255,0.08); transform: scale(1.02); box-shadow: 0 15px 40px rgba(0,0,0,0.5); z-index: 5; }
        .piece-icon { position: absolute; bottom: -15px; right: -15px; font-size: 7rem; opacity: 0.08; color: white; transition: 0.5s; }
        .piece-card:hover .piece-icon { opacity: 0.2; transform: rotate(-10deg) scale(1.2); }
        
        .piece-rank { font-family: 'Orbitron'; font-size: 2rem; font-weight: 900; opacity: 0.3; color: var(--primary-cyan); }
        .piece-name { font-family: 'Orbitron'; font-size: 1.2rem; color: white; font-weight: bold; margin-bottom: 5px; }
        .piece-desc { font-size: 0.85rem; color: #999; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 10px; }
        
        .piece-card.rank-1 { border-color: var(--primary-gold); box-shadow: inset 0 0 20px rgba(255,215,0,0.05); }
        .piece-card.rank-1 .piece-rank { color: var(--primary-gold); }

        /* Characters */
        .char-gallery { display: flex; justify-content: center; gap: 30px; flex-wrap: wrap; }
        .char-card { width: 260px; height: 380px; perspective: 1000px; }
        .char-inner { width: 100%; height: 100%; transition: 0.6s; transform-style: preserve-3d; position: relative; }
        .char-card:hover .char-inner { transform: rotateY(180deg); }
        .char-front, .char-back {
            position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: 15px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: linear-gradient(145deg, #1a1025, #050505); border: 1px solid var(--glass-border);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .char-back { transform: rotateY(180deg); background: linear-gradient(145deg, var(--primary-pink), #2a0e36); padding: 20px; text-align: center; }
        .char-avatar { width: 130px; height: 130px; border-radius: 50%; border: 3px solid white; background-size: cover; background-position: top center; margin-bottom: 20px; box-shadow: 0 0 20px var(--primary-cyan); }

        /* ================= 5. ç™»å½•æ¡† (Login Box) ================= */
        .login-box {
            width: 400px; padding: 40px; background: rgba(10, 5, 15, 0.95);
            border: 2px solid var(--primary-pink); box-shadow: 0 0 60px rgba(255, 42, 109, 0.2);
            text-align: center; position: relative;
        }
        .login-box::before { content: "ACCESS REQUEST"; position: absolute; top: -12px; left: 50%; transform: translateX(-50%); background: #000; padding: 0 10px; color: var(--primary-pink); font-family: 'Orbitron'; font-size: 0.8rem; letter-spacing: 2px; }
        .login-input { width: 100%; padding: 15px; margin-bottom: 15px; background: rgba(255,255,255,0.05); border: 1px solid #333; color: white; text-align: center; font-family: 'Orbitron'; font-size: 1.1rem; }
        .hidden { display: none !important; }

        /* ================= 6. ç»ˆæé˜…è¯»å™¨ (Reader Ultimate) ================= */
        #novel-reader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--hud-bg);
            z-index: 5000; display: flex; flex-direction: column;
            opacity: 0; pointer-events: none; transition: opacity 0.4s ease;
        }
        #novel-reader.active { opacity: 1; pointer-events: all; }

        .reader-header { height: 60px; display: flex; justify-content: space-between; align-items: center; padding: 0 30px; border-bottom: 1px solid var(--glass-border); background: rgba(0,0,0,0.6); }
        .reader-body { flex: 1; display: flex; overflow: hidden; position: relative; }

        /* åŠ è½½å±‚ (ä½äºBodyå†…) */
        #reader-loading-screen {
            position: absolute; inset: 0; background: rgba(0,0,0,0.9); z-index: 50;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            font-family: 'Orbitron'; color: var(--primary-cyan);
        }
        .loading-bar { width: 200px; height: 2px; background: #333; margin-top: 15px; position: relative; overflow: hidden; }
        .loading-progress { position: absolute; left: 0; top: 0; height: 100%; width: 0%; background: var(--primary-cyan); transition: width 0.1s; }

        /* ä¾§è¾¹æ  */
        .sidebar-left { width: 280px; background: rgba(0,0,0,0.4); border-right: 1px solid var(--glass-border); display: flex; flex-direction: column; }
        .toc-list { flex: 1; overflow-y: auto; }
        .toc-item { padding: 15px 20px; font-size: 0.9rem; color: #888; border-bottom: 1px solid rgba(255,255,255,0.02); transition: 0.2s; }
        .toc-item:hover { color: white; background: rgba(5,217,232,0.05); padding-left: 25px; }

        /* æ–‡æœ¬åŒº */
        .text-area-container { flex: 1; display: flex; flex-direction: column; }
        .reader-content { 
            flex: 1; overflow-y: auto; padding: 50px 100px; 
            font-family: 'ZCOOL XiaoWei', serif; font-size: 1.35rem; line-height: 2.1; color: #ddd; 
        }
        /* ç©ºçŠ¶æ€/é”™è¯¯çŠ¶æ€å®¹å™¨ */
        .reader-empty-state {
            height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; color: #666; gap: 20px;
        }

        /* è¯„è®ºä¾§è¾¹æ  */
        .sidebar-right { width: 0; background: rgba(10,5,20,0.98); border-left: 1px solid var(--glass-border); transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1); display: flex; flex-direction: column; }
        .sidebar-right.open { width: 360px; }

        .story-line { position: relative; padding-right: 30px; border-radius: 4px; margin-bottom: 10px; }
        .story-line:hover { background: rgba(255,255,255,0.05); }
        .comment-bubble { position: absolute; right: 5px; top: 50%; transform: translateY(-50%); color: var(--primary-purple); opacity: 0; transition: 0.2s; }
        .story-line:hover .comment-bubble { opacity: 1; }

        /* ç§»åŠ¨ç«¯ */
        @media (max-width: 768px) {
            .hero h1 { font-size: 3rem; }
            .nav-links { display: none; }
            .pledge-container, .exceed-board { grid-template-columns: 1fr; }
            .sidebar-left { display: none; }
            .reader-content { padding: 20px; font-size: 1.1rem; }
            .sidebar-right.open { position: absolute; right: 0; width: 90%; height: 100%; z-index: 60; }
            .login-box { width: 90%; }
        }
    </style>
</head>
<body>

    <div id="cursor"></div>

    <!-- LOGIN OVERLAY -->
    <div id="login-overlay">
        <div class="login-box hover-target">
            <h2 style="color:var(--primary-cyan); font-family:'Orbitron'; margin-bottom:20px;">SYSTEM LOGIN</h2>
            
            <div id="login-form">
                <input type="email" id="login-email" class="login-input" placeholder="EMAIL">
                <input type="password" id="login-password" class="login-input" placeholder="PASSWORD">
                <button class="btn-glow" style="width:100%; margin-top:10px;" onclick="handleLogin()">CONNECT</button>
                <div style="margin-top:15px; font-size:0.8rem; display:flex; justify-content:space-between;">
                    <span onclick="switchAuth('forgot')" style="text-decoration:underline; color:#888;">Forgot?</span>
                    <span onclick="switchAuth('register')" style="text-decoration:underline; color:var(--primary-pink);">New Player</span>
                </div>
            </div>

            <div id="register-step1" class="hidden">
                <input type="text" id="reg-user" class="login-input" placeholder="USERNAME">
                <input type="email" id="reg-email" class="login-input" placeholder="EMAIL">
                <input type="password" id="reg-pass" class="login-input" placeholder="PASSWORD">
                <button class="btn-glow" style="width:100%;" onclick="requestRegCode()">GET CODE</button>
                <div onclick="switchAuth('login')" style="margin-top:10px; color:#aaa;">BACK</div>
            </div>

            <div id="register-step2" class="hidden">
                <input type="text" id="reg-code" class="login-input" placeholder="6-DIGIT CODE">
                <button class="btn-glow" style="width:100%;" onclick="confirmRegister()">CONFIRM</button>
            </div>

            <div id="error-msg" style="color:#ff2a6d; margin-top:10px; font-family:'Orbitron'; font-size:0.8rem;"></div>
        </div>
    </div>

    <!-- MAIN SITE WRAPPER -->
    <div id="site-wrapper">
        <div class="bg-layer"></div>
        <canvas id="bg-canvas"></canvas>
        
        <nav>
            <div class="nav-brand">NGNL</div>
            <div class="nav-links">
                <a href="#hero" class="hover-target">HOME</a>
                <a href="#pledges" class="hover-target">PLEDGES</a>
                <a href="#world" class="hover-target">WORLD</a>
                <a href="#characters" class="hover-target">PLAYERS</a>
                <span id="nav-user" style="color:var(--primary-gold); margin-left:20px; font-size:0.8rem; border:1px solid var(--primary-gold); padding:2px 6px;">GUEST</span>
            </div>
        </nav>

        <header id="hero" class="hero">
            <h1 class="glitch" data-text="NO GAME NO LIFE">NO GAME NO LIFE</h1>
            <p style="color:#ccc; font-size:1.2rem; margin-bottom:40px;">The world is just a game. Let's play.</p>
            <button class="btn-pink hover-target" onclick="openReader()">READ NOVEL</button>
        </header>

        <section id="pledges" class="pledges">
            <h2 class="section-title">THE TEN PLEDGES</h2>
            <div class="pledge-container">
                <!-- Cards 1-10 -->
                <div class="pledge-card hover-target"><div class="pledge-num">I</div><div class="pledge-text">è¿™ä¸ªä¸–ç•Œç¦æ­¢ä¸€åˆ‡æ€ä¼¤ã€æˆ˜äº‰ä¸æ å¤ºã€‚</div></div>
                <div class="pledge-card hover-target"><div class="pledge-num">II</div><div class="pledge-text">æ‰€æœ‰çº çº·ä¸€å¾‹é€šè¿‡åœ¨æ¸¸æˆä¸­å†³èƒœè´Ÿæ¥è§£å†³ã€‚</div></div>
                <div class="pledge-card hover-target"><div class="pledge-num">III</div><div class="pledge-text">æ¸¸æˆä¸­é¡»èµŒä¸ŠåŒæ–¹è®¤ä¸ºå¯¹ç­‰çš„èµŒæ³¨ã€‚</div></div>
                <div class="pledge-card hover-target"><div class="pledge-num">IV</div><div class="pledge-text">åœ¨ä¸è¿åç¬¬ä¸‰æ¡çš„æƒ…å†µä¸‹ï¼Œæ¸¸æˆå†…å®¹ã€èµŒæ³¨çš†ä¸é™ã€‚</div></div>
                <div class="pledge-card hover-target"><div class="pledge-num">V</div><div class="pledge-text">å—æŒ‘æˆ˜çš„ä¸€æ–¹æœ‰æƒå†³å®šæ¸¸æˆçš„å†…å®¹ã€‚</div></div>
                <div class="pledge-card hover-target"><div class="pledge-num">VI</div><div class="pledge-text">ã€Œå‘ç›Ÿçº¦å®£èª“ã€çš„èµŒæ³¨ç»å¯¹è¦éµå®ˆã€‚</div></div>
                <div class="pledge-card hover-target"><div class="pledge-num">VII</div><div class="pledge-text">é›†å›¢çº çº·åº”æŒ‡å®šå…¨æƒä»£ç†äººã€‚</div></div>
                <div class="pledge-card hover-target"><div class="pledge-num">VIII</div><div class="pledge-text">æ¸¸æˆä¸­è‹¥æœ‰ä¸æ­£å½“è¡Œä¸ºï¼Œä¸€æ—¦è´¥éœ²å³è§†åŒè´¥åŒ—ã€‚</div></div>
                <div class="pledge-card hover-target"><div class="pledge-num">IX</div><div class="pledge-text">ä»¥ç¥ä¹‹åå®£å¸ƒï¼Œä»¥ä¸Šå„æ¡çš†ä¸ºç»å¯¹ä¸å˜çš„è§„åˆ™ã€‚</div></div>
                <div class="pledge-card hover-target"><div class="pledge-num">X</div><div class="pledge-text">å¤§å®¶ä¸€èµ·å’Œå¹³åœ°ç©å§ã€‚</div></div>
            </div>
        </section>

        <section id="world">
            <h2 class="section-title">WORLD DATABASE</h2>
            <div class="world-container">
                <div class="world-tabs">
                    <div class="world-tab active hover-target" onclick="switchWorldTab('disboard')">DISBOARD</div>
                    <div class="world-tab hover-target" onclick="switchWorldTab('exceed')">IXSEED (16ç§æ—)</div>
                    <div class="world-tab hover-target" onclick="switchWorldTab('history')">ARCHIVE</div>
                </div>
                <div class="world-content" id="world-display-area"></div>
            </div>
        </section>

        <section id="characters" class="characters">
            <h2 class="section-title">PLAYERS</h2>
            <div class="char-gallery">
                <div class="char-card hover-target"><div class="char-inner"><div class="char-front"><div class="char-avatar" style="background-image: url('sora.png');"></div><div class="char-name">SORA</div><div class="char-race">Imanity</div></div><div class="char-back"><h3>ç©º</h3><p>åå…«å²ã€‚æ— ä¸šã€å¤„ç”·ã€æ²Ÿé€šéšœç¢ã€æ¸¸æˆåºŸäººã€‚æ“…é•¿ç­–ç•¥ä¸è¯»å¿ƒã€‚</p></div></div></div>
                <div class="char-card hover-target"><div class="char-inner"><div class="char-front"><div class="char-avatar" style="background-image: url('shiro.png');"></div><div class="char-name">SHIRO</div><div class="char-race">Imanity</div></div><div class="char-back"><h3>ç™½</h3><p>åä¸€å²ã€‚ç©ºçš„ä¹‰å¦¹ã€‚æ‹¥æœ‰è¶…ä¹å¸¸äººçš„è®¡ç®—èƒ½åŠ›ã€‚</p></div></div></div>
                <div class="char-card hover-target"><div class="char-inner"><div class="char-front"><div class="char-avatar" style="background-image: url('jibril.png');"></div><div class="char-name">JIBRIL</div><div class="char-race">FlÃ¼gel</div></div><div class="char-back"><h3>å‰æ™®è‰å°”</h3><p>ä½é˜¶åºåˆ—ç¬¬å…­ä½ã€‚æ‹¥æœ‰æå¼ºçš„æˆ˜æ–—åŠ›ä¸çŸ¥è¯†æ¬²ã€‚</p></div></div></div>
                <div class="char-card hover-target"><div class="char-inner"><div class="char-front"><div class="char-avatar" style="background-image: url('steph.png');"></div><div class="char-name">STEPH</div><div class="char-race">Imanity</div></div><div class="char-back"><h3>å²è’‚èŠ¬å¦®</h3><p>è‰¾å°”å¥‡äºšçš„å‰ç‹æ—å­™å¥³ã€‚è¢«â€œç©ºç™½â€æ‰å¼„çš„ç®¡å®¶ã€‚</p></div></div></div>
                <div class="char-card hover-target"><div class="char-inner"><div class="char-front"><div class="char-avatar" style="background-image: url('izuna.png');"></div><div class="char-name">IZUNA</div><div class="char-race">Werebeast</div></div><div class="char-back"><h3>åˆæ¿‘ä¼Šçº²</h3><p>å…«å²ã€‚ä¸œéƒ¨è”åˆçš„å¤§ä½¿ã€‚æ‹¥æœ‰æå…¶æ•é”çš„äº”æ„Ÿã€‚</p></div></div></div>
                <div class="char-card hover-target"><div class="char-inner"><div class="char-front"><div class="char-avatar" style="background-image: url('tet.png');"></div><div class="char-name">TET</div><div class="char-race">One True God</div></div><div class="char-back"><h3>ç‰¹å›¾</h3><p>æ¸¸æˆä¹‹ç¥ï¼Œå”¯ä¸€çš„å…¨æƒç¥ã€‚</p></div></div></div>
            </div>
        </section>

        <footer><p>Â© NO GAME NO LIFE FAN SITE</p></footer>
    </div>

    <!-- READER OVERLAY (Fixed Performance) -->
    <div id="novel-reader">
        <div class="sidebar-left">
            <div class="toc-header">INDEX</div>
            <div class="toc-list" id="toc-list"></div>
        </div>
        
        <div class="reader-main">
            <div class="reader-header">
                <span style="font-family:'Orbitron'; color:var(--primary-cyan);">NOVEL DATABASE</span>
                <button onclick="closeReader()" style="background:none; border:1px solid var(--primary-pink); color:var(--primary-pink); padding:5px 15px; font-family:'Orbitron';">EXIT</button>
            </div>
            <div class="text-area-container">
                <!-- Loading Screen inside Reader -->
                <div id="reader-loading-screen" class="hidden">
                    <div id="loading-status">INITIALIZING DATA STREAM...</div>
                    <div class="loading-bar"><div class="loading-progress" id="progress-bar"></div></div>
                </div>

                <div class="reader-content" id="reader-content">
                    <!-- Default Empty State -->
                    <div class="reader-empty-state">
                        <div style="font-size:1.5rem; font-family:'Orbitron'; color:#555;">NO DATA LOADED</div>
                        <button class="btn-glow" onclick="document.getElementById('file-input').click()">SELECT NOVEL.TXT</button>
                    </div>
                </div>
                
                <div style="padding:10px; background:rgba(0,0,0,0.8); display:flex; justify-content:center; gap:20px; border-top:1px solid #333;">
                    <button class="btn-glow" style="padding:5px 20px;" onclick="changePage(-1)">PREV PAGE</button>
                    <span id="page-info" style="align-self:center; font-family:'Orbitron'; color:#aaa;">0 / 0</span>
                    <button class="btn-glow" style="padding:5px 20px;" onclick="changePage(1)">NEXT PAGE</button>
                </div>
            </div>
        </div>

        <div class="sidebar-right" id="comment-sidebar">
            <div class="comments-header" style="padding:15px; border-bottom:1px solid #444; display:flex; justify-content:space-between;">
                <span style="font-family:'Orbitron'; color:var(--primary-pink);">COMMENTS</span>
                <span onclick="toggleSidebar()">[X]</span>
            </div>
            <div id="comments-list" style="flex:1; overflow-y:auto; padding:15px;"></div>
            <div style="padding:15px; background:rgba(0,0,0,0.5);">
                <textarea id="comment-input" style="width:100%; background:rgba(255,255,255,0.1); color:white; border:1px solid #555; padding:10px;" rows="2"></textarea>
                <button class="btn-glow" style="width:100%; margin-top:5px;" onclick="postComment()">POST</button>
            </div>
        </div>
    </div>

    <input type="file" id="file-input" accept=".txt" style="display:none;" onchange="loadFromFile(this)">

    <script>
        // ==========================================
        // âš ï¸ å¿…é¡»ä¿®æ”¹ï¼šä½ çš„åç«¯ URL
        const API_URL = "https://script.google.com/macros/s/AKfycbxJBrAx1_jzwNCO6kCSVyJsNANGE4ibdXy5SXva_p54B4Zot8OaJeCm3PdQsIVhdU4v/exec"; 
        // ==========================================

        // State
        let currentUser = { username: "Guest", level: 16, exp: 0 };
        let allLines = [];
        let currentLineStart = 0;
        const LINES_PER_PAGE = 150; // åˆ†é¡µä¼˜åŒ–ï¼šæ¯é¡µ150è¡Œ

        // --- API ---
        async function callApi(data) {
            return fetch(API_URL, {
                method: 'POST',
                redirect: 'follow',
                headers: { "Content-Type": "text/plain;charset=utf-8" },
                body: JSON.stringify(data)
            }).then(res => res.json());
        }

        // --- Login ---
        function switchAuth(mode) {
            ['login-form','register-step1','register-step2'].forEach(id=>document.getElementById(id).classList.add('hidden'));
            if(mode==='login') document.getElementById('login-form').classList.remove('hidden');
            else document.getElementById('register-step1').classList.remove('hidden');
        }
        function handleLogin() {
            const e = document.getElementById('login-email').value, p = document.getElementById('login-password').value;
            const btn = document.querySelector('#login-form button'), err = document.getElementById('error-msg');
            btn.innerText = "VERIFYING..."; btn.disabled = true;
            callApi({action: 'login', email: e, password: p}).then(d => {
                if(d.status === 'success') {
                    currentUser = { username: d.username, level: d.level, exp: d.exp };
                    document.getElementById('login-overlay').style.opacity = '0';
                    document.body.classList.add('unlocked');
                    document.getElementById('nav-user').innerText = d.username.toUpperCase();
                    setTimeout(() => { document.getElementById('login-overlay').style.display = 'none'; initVisuals(); }, 800);
                } else { err.innerText = d.message; btn.disabled = false; btn.innerText = "CONNECT"; }
            }).catch(() => { err.innerText = "ERROR"; btn.disabled = false; btn.innerText = "CONNECT"; });
        }
        function requestRegCode() {
            const e = document.getElementById('reg-email').value;
            if(!e) return;
            document.getElementById('btn-reg-code').innerText="...";
            callApi({action:'req_reg_code', email:e}).then(d=>{
                if(d.status==='success'){ window.tempReg={e, u:document.getElementById('reg-user').value, p:document.getElementById('reg-pass').value}; document.getElementById('register-step1').classList.add('hidden'); document.getElementById('register-step2').classList.remove('hidden'); }
                else alert(d.message);
            });
        }
        function confirmRegister() {
            const c = document.getElementById('reg-code').value;
            callApi({action:'confirm_register', ...window.tempReg, code:c}).then(d=>{
                if(d.status==='success'){ alert('Welcome!'); handleLogin(); } else alert(d.message);
            });
        }

        // --- Reader Logic (Chunked Parsing to prevent lag) ---
        function openReader() {
            document.getElementById('novel-reader').classList.add('active');
            fetch('novel.txt').then(r => {
                if(r.ok) return r.text();
                throw new Error("404");
            }).then(text => {
                startChunkedProcessing(text);
            }).catch(() => {
                // å¦‚æœæ‰¾ä¸åˆ°æ–‡ä»¶ï¼Œä¿æŒ Empty Stateï¼Œä¸å¡æ­»
                console.log("Auto-load failed, waiting for manual selection.");
            });
        }

        function loadFromFile(inp) {
            const f = inp.files[0];
            const r = new FileReader();
            r.onload = e => startChunkedProcessing(e.target.result);
            r.readAsText(f);
        }

        // æ ¸å¿ƒä¿®å¤ï¼šåˆ†ç‰‡å¤„ç†ï¼Œé˜²æ­¢æµè§ˆå™¨å¡æ­»
        async function startChunkedProcessing(text) {
            const loadingScreen = document.getElementById('reader-loading-screen');
            const statusText = document.getElementById('loading-status');
            const progressBar = document.getElementById('progress-bar');
            const tocList = document.getElementById('toc-list');
            
            loadingScreen.classList.remove('hidden');
            tocList.innerHTML = "";
            
            // 1. Split Lines (Fast)
            allLines = text.split('\n');
            
            // 2. Generate TOC in Chunks
            const chunkSize = 2000; // æ¯æ¬¡å¤„ç†2000è¡Œ
            let tocHtml = "";
            const regex = /(?:^ç¬¬.+ç« )|(?:^Chapter)|(?:^åºç« )|(?:^ç»ˆç« )/i;

            for (let i = 0; i < allLines.length; i += chunkSize) {
                const end = Math.min(i + chunkSize, allLines.length);
                
                // å¤„ç†è¿™ä¸€å—æ•°æ®
                for (let j = i; j < end; j++) {
                    const line = allLines[j];
                    if (line.length < 50 && regex.test(line)) {
                        // ä¸ºäº†æ€§èƒ½ï¼Œè¿™é‡Œç”¨å­—ç¬¦ä¸²æ‹¼æ¥ä»£æ›¿ createElement
                        tocHtml += `<div class="toc-item hover-target" onclick="jumpToLine(${j})">${line.trim()}</div>`;
                    }
                }

                // æ›´æ–°è¿›åº¦æ¡
                const pct = Math.round((end / allLines.length) * 100);
                statusText.innerText = `PARSING DATA... ${pct}%`;
                progressBar.style.width = `${pct}%`;

                // è®©å‡ºä¸»çº¿ç¨‹ç»™ UI æ¸²æŸ“ (å…³é”®ï¼)
                await new Promise(r => setTimeout(r, 0));
            }

            tocList.innerHTML = tocHtml;
            jumpToLine(0);
            
            // Fade out loader
            setTimeout(() => loadingScreen.classList.add('hidden'), 500);
        }

        function jumpToLine(index) {
            currentLineStart = index;
            renderPage();
        }

        function changePage(dir) {
            const newStart = currentLineStart + (dir * LINES_PER_PAGE);
            if(newStart >= 0 && newStart < allLines.length) {
                currentLineStart = newStart;
                renderPage();
            }
        }

        function renderPage() {
            const container = document.getElementById('reader-content');
            const end = Math.min(currentLineStart + LINES_PER_PAGE, allLines.length);
            const slice = allLines.slice(currentLineStart, end);
            
            let html = "";
            slice.forEach((line, i) => {
                if(!line.trim()) { html += "<br>"; return; }
                const realIdx = currentLineStart + i;
                html += `<div class="story-line hover-target">${line}<div class="comment-bubble" onclick="openComments(${realIdx})">ğŸ’¬</div></div>`;
            });

            container.innerHTML = html;
            container.scrollTop = 0;
            
            const pct = Math.round((end / allLines.length) * 100);
            document.getElementById('page-info').innerText = `LINE ${currentLineStart} / ${allLines.length} (${pct}%)`;
        }

        function closeReader() { document.getElementById('novel-reader').classList.remove('active'); }

        // --- Comments ---
        let activeLine = -1;
        function toggleSidebar() { document.getElementById('comment-sidebar').classList.toggle('open'); }
        function openComments(idx) {
            activeLine = idx;
            document.getElementById('comment-sidebar').classList.add('open');
            const list = document.getElementById('comments-list');
            list.innerHTML = "Loading...";
            callApi({action: 'get_line_comments', line_index: idx}).then(d => {
                list.innerHTML = "";
                if(!d.data || d.data.length===0) list.innerHTML = "<div style='text-align:center; color:#666;'>No comments</div>";
                else d.data.forEach(c => list.innerHTML += `<div style="background:rgba(255,255,255,0.05); padding:10px; margin-bottom:10px; border-radius:5px;"><div style="color:var(--primary-cyan); font-size:0.8rem;">${c.user}</div><div style="color:#ddd;">${c.content}</div></div>`);
            });
        }
        function postComment() {
            const t = document.getElementById('comment-input').value;
            if(!t) return;
            callApi({action: 'post_line_comment', line_index: activeLine, username: currentUser.username, content: t}).then(()=>{
                document.getElementById('comment-input').value = "";
                openComments(activeLine);
            });
        }

        // --- World Data ---
        const worldData = {
            disboard: `<h3>DISBOARD (ç›˜ä¸Šä¸–ç•Œ)</h3><div class="world-text"><p>ä¸€åˆ‡éƒ½ç”±æ¸¸æˆå†³å®šçš„ä¸–ç•Œã€‚åœ¨è¿™ä¸ªä¸–ç•Œä¸­ï¼ŒåŒ…æ‹¬å›½å¢ƒçº¿åœ¨å†…çš„æ‰€æœ‰çº çº·éƒ½å¿…é¡»é€šè¿‡æ¸¸æˆæ¥è§£å†³ã€‚</p><br><p>è¿™ä¸ªä¸–ç•Œç”±å”¯ä¸€ç¥ç‰¹å›¾ï¼ˆTetï¼‰æ‰€åˆ›é€ çš„â€œåæ¡ç›Ÿçº¦â€æ‰€çº¦æŸã€‚æš´åŠ›æ˜¯è¢«ç»å¯¹ç¦æ­¢çš„ã€‚</p></div>`,
            history: `<h3>ARCHIVE (å¤å¤§æˆ˜)</h3><div class="world-text"><p>è¯¸ç¥äº‰å¤ºå”¯ä¸€ç¥å®åº§çš„è¿œå¤æˆ˜äº‰ï¼Œæœ€ç»ˆç”±ç‰¹å›¾å–å¾—æ˜Ÿæ¯è€Œç»“æŸã€‚</p></div>`,
            exceed: `<h3>IXSEED (åå…­ç§æ—)</h3><div class="world-text"><div class="exceed-board">
                <div class="piece-card rank-1 hover-target"><div class="piece-rank">I</div><div class="piece-icon">â™”</div><div class="piece-info"><div class="piece-name">Old Deus</div><div class="piece-jp-name">ç¥çµç§</div><div class="piece-desc">ç‹ï¼ˆKingï¼‰ã€‚ä¸–ç•Œæ ¸å¿ƒã€‚</div></div></div>
                <div class="piece-card rank-2 hover-target"><div class="piece-rank">II</div><div class="piece-icon">â™•</div><div class="piece-info"><div class="piece-name">Phantasma</div><div class="piece-jp-name">å¹»æƒ³ç§</div><div class="piece-desc">åï¼ˆQueenï¼‰ã€‚</div></div></div>
                <div class="piece-card hover-target"><div class="piece-rank">III</div><div class="piece-icon">â™–</div><div class="piece-info"><div class="piece-name">Dragonia</div><div class="piece-jp-name">é¾™ç²¾ç§</div><div class="piece-desc">è½¦ï¼ˆRookï¼‰ã€‚åŠ›é‡ã€‚</div></div></div>
                <div class="piece-card hover-target"><div class="piece-rank">IV</div><div class="piece-icon">â™—</div><div class="piece-info"><div class="piece-name">FlÃ¼gel</div><div class="piece-jp-name">å¤©ç¿¼ç§</div><div class="piece-desc">è±¡ï¼ˆBishopï¼‰ã€‚å¼‘ç¥å…µå™¨ã€‚</div></div></div>
                <div class="piece-card hover-target"><div class="piece-rank">V</div><div class="piece-icon">â™˜</div><div class="piece-info"><div class="piece-name">Elf</div><div class="piece-jp-name">æ£®ç²¾ç§</div><div class="piece-desc">é©¬ï¼ˆKnightï¼‰ã€‚é­”æ³•å¤§å›½ã€‚</div></div></div>
                <div class="piece-card hover-target"><div class="piece-rank">VI</div><div class="piece-icon">â™™</div><div class="piece-info"><div class="piece-name">Gigant</div><div class="piece-jp-name">å·¨ç¥ç§</div><div class="piece-desc">å…µï¼ˆPawnï¼‰ã€‚æ— é™å‡å˜ã€‚</div></div></div>
                <div class="piece-card hover-target"><div class="piece-rank">VII</div><div class="piece-icon">ğŸ¨ </div><div class="piece-info"><div class="piece-name">Werebeast</div><div class="piece-jp-name">å…½äººç§</div><div class="piece-desc">é‡‘å°†ã€‚èº«ä½“èƒ½åŠ›å¼ºåŒ–ã€‚</div></div></div>
                <div class="piece-card hover-target"><div class="piece-rank">VIII</div><div class="piece-icon">â™™</div><div class="piece-info"><div class="piece-name">Goblin</div><div class="piece-jp-name">åœ°ç²¾ç§</div><div class="piece-desc">å…µï¼ˆå˜ä½“ï¼‰ã€‚é”»é€ æŠ€æœ¯ã€‚</div></div></div>
                <div class="piece-card hover-target"><div class="piece-rank">IX</div><div class="piece-icon">â™–</div><div class="piece-info"><div class="piece-name">Dragonblood</div><div class="piece-jp-name">å¤©é¾™ç§</div><div class="piece-desc">è±¡å¾åšå›ºä¸åŠ›é‡ã€‚</div></div></div>
                <div class="piece-card hover-target"><div class="piece-rank">X</div><div class="piece-icon">â™—</div><div class="piece-info"><div class="piece-name">Demonia</div><div class="piece-jp-name">å¦–é­”ç§</div><div class="piece-desc">å¼ºé­”åŠ›ï¼Œè±¡å¾æ–œå‘å½±å“åŠ›ã€‚</div></div></div>
                <div class="piece-card hover-target"><div class="piece-rank">XI</div><div class="piece-icon">â™•</div><div class="piece-info"><div class="piece-name">Seiren</div><div class="piece-jp-name">æµ·ç¥ç§</div><div class="piece-desc">ç”Ÿå‘½åŠ›ç¹ç››ï¼Œä¾é ä»–æ—ç¹æ®–ã€‚</div></div></div>
                <div class="piece-card hover-target"><div class="piece-rank">XII</div><div class="piece-icon">â™˜</div><div class="piece-info"><div class="piece-name">Fairy</div><div class="piece-jp-name">å¦–ç²¾ç§</div><div class="piece-desc">è·³è·ƒä¸ä¸å¯é¢„æµ‹çš„è¡ŒåŠ¨æ€§ã€‚</div></div></div>
                <div class="piece-card hover-target"><div class="piece-rank">XIII</div><div class="piece-icon">â™œ</div><div class="piece-info"><div class="piece-name">Ex-Machina</div><div class="piece-jp-name">æœºæ¢°ç§</div><div class="piece-desc">é€»è¾‘ä¸ç«åŠ›ï¼Œåˆä½“æ£‹å­ã€‚</div></div></div>
                <div class="piece-card hover-target"><div class="piece-rank">XIV</div><div class="piece-icon">â™™</div><div class="piece-info"><div class="piece-name">Dhampir</div><div class="piece-jp-name">å¸è¡€é¬¼ç§</div><div class="piece-desc">é€šè¿‡å¸å–æ”¹å˜çŠ¶æ€ï¼Œè¿›åŒ–æ½œåŠ›ã€‚</div></div></div>
                <div class="piece-card hover-target"><div class="piece-rank">XV</div><div class="piece-icon">â™™</div><div class="piece-info"><div class="piece-name">Moonver</div><div class="piece-jp-name">æœˆä¸‹å…½äºº</div><div class="piece-desc">ç‹¬ç‰¹æŠ€èƒ½ï¼Œä»å½’ä¸ºå…µé˜¶ã€‚</div></div></div>
                <div class="piece-card rank-16 hover-target"><div class="piece-rank">XVI</div><div class="piece-icon">â™™</div><div class="piece-info"><div class="piece-name">Imanity</div><div class="piece-jp-name">äººç±»ç§</div><div class="piece-desc">å…µï¼ˆPawnï¼‰ã€‚æœ€å¼±ä½†æ‹¥æœ‰æ— é™å¯èƒ½æ€§ã€‚</div></div></div>
            </div></div>`
        };
        function renderWorld() { document.getElementById('world-display-area').innerHTML = worldData.disboard; }
        function switchWorldTab(tab) {
            const tabs = document.querySelectorAll('.world-tab'); tabs.forEach(t => t.classList.remove('active'));
            if(tab === 'disboard') tabs[0].classList.add('active'); else if(tab === 'exceed') tabs[1].classList.add('active'); else tabs[2].classList.add('active');
            const area = document.getElementById('world-display-area'); area.style.opacity=0;
            setTimeout(()=>{area.innerHTML=worldData[tab]; area.style.opacity=1;},200);
        }

        // --- Visuals ---
        function initVisuals() {
            const cvs = document.getElementById('bg-canvas'); const ctx = cvs.getContext('2d');
            let w = window.innerWidth, h = window.innerHeight; cvs.width = w; cvs.height = h;
            const parts = Array.from({length:40}, ()=>({x:Math.random()*w, y:Math.random()*h, s:Math.random()+0.5, t:['â™”','â™•','â™–'][Math.floor(Math.random()*3)]}));
            function anim(){ ctx.clearRect(0,0,w,h); parts.forEach(p=>{p.y+=p.s; if(p.y>h)p.y=-20; ctx.fillStyle='rgba(255,255,255,0.1)'; ctx.font='20px Arial'; ctx.fillText(p.t, p.x, p.y);}); requestAnimationFrame(anim); }
            anim(); renderWorld();
        }
        const cursor = document.getElementById('cursor');
        document.addEventListener('mousemove', e=>{ cursor.style.left=e.clientX+'px'; cursor.style.top=e.clientY+'px'; });
        document.body.addEventListener('mouseover', e=>{ if(e.target.closest('.hover-target')) cursor.classList.add('hovered'); else cursor.classList.remove('hovered'); });
    </script>
</body>
</html>