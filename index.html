<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NO GAME NO LIFE - SYSTEM</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Noto+Sans+SC:wght@300;400;500;700&family=ZCOOL+XiaoWei&display=swap" rel="stylesheet">
    <style>
        /* 全局样式 */
        :root {
            --primary-pink: #ff2a6d; --primary-cyan: #05d9e8; --primary-purple: #d905e8; --dark-bg: #09000f;
            --glass-bg: rgba(20, 20, 35, 0.9);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; }
        body { background-color: var(--dark-bg); color: white; font-family: 'Noto Sans SC', sans-serif; height: 100vh; overflow: hidden; }
        body.unlocked { overflow: auto; }

        /* 登录层 */
        #overlay-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 10000;
            background: rgba(5, 2, 10, 0.95); display: flex; justify-content: center; align-items: center;
        }
        .auth-box {
            width: 400px; padding: 40px; background: rgba(0,0,0,0.8); 
            border: 2px solid var(--primary-pink); text-align: center;
            box-shadow: 0 0 50px rgba(255, 42, 109, 0.3);
        }
        .auth-title { font-family: 'Orbitron'; font-size: 2rem; margin-bottom: 20px; color: white; text-shadow: 0 0 10px var(--primary-cyan); }
        
        /* 输入框与按钮 */
        .my-input {
            width: 100%; padding: 12px; margin-bottom: 15px; background: rgba(255,255,255,0.1);
            border: 1px solid #555; color: white; text-align: center; font-family: 'Orbitron'; font-size: 1rem;
        }
        .my-btn {
            width: 100%; padding: 12px; background: var(--primary-pink); border: none;
            color: white; font-family: 'Orbitron'; font-weight: bold; cursor: pointer; transition: 0.3s;
        }
        .my-btn:hover { background: white; color: var(--primary-pink); box-shadow: 0 0 20px var(--primary-pink); }
        .my-btn:disabled { background: #555; cursor: not-allowed; }

        .link-text { margin-top: 15px; font-size: 0.8rem; color: #aaa; text-decoration: underline; cursor: pointer; }
        .err-msg { color: red; margin-top: 10px; min-height: 20px; font-family: 'Orbitron'; }

        /* 显隐控制类 */
        .d-none { display: none !important; }

        /* 主界面模糊 */
        #main-content { filter: blur(10px); opacity: 0.5; pointer-events: none; width: 100%; min-height: 100vh; transition: 1s; }
        body.unlocked #main-content { filter: blur(0); opacity: 1; pointer-events: all; }
        
        /* 简单排版 */
        nav { padding: 20px; text-align: center; border-bottom: 1px solid #333; font-family: 'Orbitron'; letter-spacing: 2px; }
        .hero { height: 80vh; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        h1 { font-size: 4rem; color: var(--primary-cyan); text-shadow: 0 0 20px var(--primary-cyan); }
    </style>
</head>
<body>

    <!-- 登录遮罩 -->
    <div id="overlay-layer">
        <div class="auth-box">
            <h2 id="ui-title" class="auth-title">SYSTEM LOGIN</h2>
            
            <!-- 1. 登录表单 (ID: section-login) -->
            <div id="section-login">
                <input type="email" id="inp-login-email" class="my-input" placeholder="EMAIL">
                <input type="password" id="inp-login-pass" class="my-input" placeholder="PASSWORD">
                <button class="my-btn" onclick="actLogin(this)">CONNECT</button>
                <div class="link-text" onclick="gotoRegister()">NEW PLAYER? REGISTER</div>
            </div>

            <!-- 2. 注册第一步 (ID: section-reg1) -->
            <div id="section-reg1" class="d-none">
                <input type="text" id="inp-reg-user" class="my-input" placeholder="USERNAME">
                <input type="email" id="inp-reg-email" class="my-input" placeholder="EMAIL">
                <input type="password" id="inp-reg-pass" class="my-input" placeholder="PASSWORD">
                <button class="my-btn" onclick="actGetCode(this)">GET CODE</button>
                <div class="link-text" onclick="gotoLogin()">BACK</div>
            </div>

            <!-- 3. 注册第二步 (ID: section-reg2) -->
            <div id="section-reg2" class="d-none">
                <p style="color:#ccc; margin-bottom:10px;">Code sent (or use 123456)</p>
                <input type="text" id="inp-reg-code" class="my-input" placeholder="ENTER CODE">
                <button class="my-btn" onclick="actConfirm(this)">CONFIRM</button>
            </div>

            <div id="msg-box" class="err-msg"></div>
        </div>
    </div>

    <!-- 主界面 -->
    <div id="main-content">
        <nav>NGNL SYSTEM // <span id="user-name" style="color:var(--primary-gold)">GUEST</span></nav>
        <div class="hero">
            <h1>ASCHENTE</h1>
            <p style="color:#aaa; margin-top:20px;">Welcome to Disboard.</p>
        </div>
    </div>

    <script>
        // ==============================================
        // ⚠️ 填入你的 Google Apps Script URL
        const API_URL = "https://script.google.com/macros/s/AKfycbxJBrAx1_jzwNCO6kCSVyJsNANGE4ibdXy5SXva_p54B4Zot8OaJeCm3PdQsIVhdU4v/exec"; 
        // ==============================================

        // --- 1. 绝对安全的切换视图函数 ---
        function gotoRegister() {
            // 强制隐藏登录，显示注册1
            document.getElementById('section-login').classList.add('d-none');
            document.getElementById('section-reg1').classList.remove('d-none');
            document.getElementById('section-reg2').classList.add('d-none');
            document.getElementById('ui-title').innerText = "REGISTER";
            document.getElementById('msg-box').innerText = "";
        }

        function gotoLogin() {
            // 强制显示登录，隐藏其他
            document.getElementById('section-login').classList.remove('d-none');
            document.getElementById('section-reg1').classList.add('d-none');
            document.getElementById('section-reg2').classList.add('d-none');
            document.getElementById('ui-title').innerText = "SYSTEM LOGIN";
            document.getElementById('msg-box').innerText = "";
        }

        function gotoVerify() {
            document.getElementById('section-reg1').classList.add('d-none');
            document.getElementById('section-reg2').classList.remove('d-none');
        }

        // --- 2. API 请求 ---
        async function sendReq(data) {
            console.log("发送数据:", data);
            try {
                const res = await fetch(API_URL, {
                    method: 'POST',
                    redirect: 'follow',
                    headers: { "Content-Type": "text/plain;charset=utf-8" },
                    body: JSON.stringify(data)
                });
                const json = await res.json();
                console.log("收到数据:", json);
                return json;
            } catch (e) {
                console.error(e);
                return {status: 'error', message: '网络错误，请检查控制台'};
            }
        }

        // --- 3. 业务逻辑 ---
        
        // 登录
        async function actLogin(btn) {
            const e = document.getElementById('inp-login-email').value;
            const p = document.getElementById('inp-login-pass').value;
            const msg = document.getElementById('msg-box');

            if(!e || !p) { msg.innerText = "请输入邮箱和密码"; return; }

            btn.disabled = true; btn.innerText = "...";
            
            const res = await sendReq({action: 'login', email: e, password: p});

            if (res.status === 'success') {
                document.getElementById('overlay-layer').style.display = 'none';
                document.body.classList.add('unlocked');
                document.getElementById('user-name').innerText = res.username;
            } else {
                msg.innerText = res.message;
                btn.disabled = false; btn.innerText = "CONNECT";
            }
        }

        // 临时存数据
        let tempUser = {};

        // 获取验证码
        async function actGetCode(btn) {
            const u = document.getElementById('inp-reg-user').value;
            const e = document.getElementById('inp-reg-email').value;
            const p = document.getElementById('inp-reg-pass').value;
            const msg = document.getElementById('msg-box');

            if(!u || !e || !p) { msg.innerText = "请填完所有信息"; return; }

            btn.disabled = true; btn.innerText = "...";
            tempUser = { username: u, email: e, password: p };

            const res = await sendReq({action: 'req_reg_code', email: e});

            if (res.status === 'success') {
                gotoVerify();
                msg.innerText = "";
                alert("验证码已发送 (测试码: 123456)");
            } else {
                msg.innerText = res.message;
                btn.disabled = false; btn.innerText = "GET CODE";
            }
        }

        // 确认注册
        async function actConfirm(btn) {
            const code = document.getElementById('inp-reg-code').value;
            const msg = document.getElementById('msg-box');

            if(!code) { msg.innerText = "请输入验证码"; return; }
            
            btn.disabled = true; btn.innerText = "...";

            const res = await sendReq({
                action: 'confirm_register',
                username: tempUser.username,
                email: tempUser.email,
                password: tempUser.password,
                code: code
            });

            if (res.status === 'success') {
                alert("注册成功！请登录");
                gotoLogin();
            } else {
                msg.innerText = res.message;
                btn.disabled = false; btn.innerText = "CONFIRM";
            }
        }
    </script>
</body>
</html>